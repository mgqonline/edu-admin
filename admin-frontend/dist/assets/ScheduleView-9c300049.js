import{n as d,_ as h}from"./index-67337038.js";const u={name:"ScheduleView",components:{V2SimpleDate:()=>h(()=>import("./V2SimpleDate-11821f76.js"),["assets/V2SimpleDate-11821f76.js","assets/index-67337038.js","assets/index-f5f188af.css","assets/V2SimpleDate-9b3aafb8.css"])},data(){return{activeTab:"class",list:[],columns:[{title:"日期",dataIndex:"date"},{title:"开始",dataIndex:"start"},{title:"结束",dataIndex:"end"},{title:"班级",dataIndex:"classId"},{title:"教师",dataIndex:"teacherId"},{title:"教室",dataIndex:"room"},{title:"状态",dataIndex:"status"}],filters:{classId:null,teacherId:null,studentId:"",campusId:null,room:"",startDate:null,endDate:null},classOptions:[],teacherOptions:[],studentOptions:[],campusOptions:[],roomOptions:[]}},created(){this.loadClassOptions(),this.loadTeacherOptions(),this.loadStudentOptions(),this.loadCampusOptions(),this.applyRouteFilters()},methods:{noop(){},async applyRouteFilters(){try{const s=this.$route&&this.$route.query||{};if(s.mode==="upcoming"){let i=Number.parseInt(s.days||"0",10);if(!i||Number.isNaN(i)){const o=s.startDate,r=s.endDate;if(o&&r){const l=new Date(o),n=new Date(r),c=Math.round((n-l)/(24*3600*1e3))+1;i=c>0?c:3}else i=3}await this.loadUpcoming(i);return}const t=s.dim,e=s.startDate,a=s.endDate;if(e&&(this.filters.startDate=e),a&&(this.filters.endDate=a),t==="class"&&s.classId){this.activeTab="class",this.filters.classId=Number(s.classId),await this.loadClassSchedule();return}if(t==="teacher"&&s.teacherId){this.activeTab="teacher",this.filters.teacherId=Number(s.teacherId),await this.loadTeacherSchedule();return}if(t==="student"&&s.studentId){this.activeTab="student",this.filters.studentId=String(s.studentId),await this.loadStudentSchedule();return}if(t==="room"&&s.campusId&&s.room){this.activeTab="room",this.filters.campusId=Number(s.campusId),this.filters.room=String(s.room),await this.loadRoomSchedule();return}}catch{}},async loadUpcoming(s=3){try{const t=new URLSearchParams({days:String(s),limit:"100"}),a=await(await fetch("/api/schedule/upcoming?"+t.toString())).json();a&&a.code===200&&(this.list=Array.isArray(a.data)?a.data:[],this.activeTab="class")}catch{}},async loadClassOptions(){try{const t=await(await fetch("/api/class/list")).json();t&&t.code===200&&(this.classOptions=(t.data||[]).map(e=>({id:e.id,name:e.name})))}catch{}},async loadTeacherOptions(){try{const t=await(await fetch("/api/teacher/list")).json();t&&t.code===200&&(this.teacherOptions=(t.data||[]).map(e=>({id:e.id,name:e.name})))}catch{}},async loadStudentOptions(){try{const t=await(await fetch("/api/student/list")).json();t&&t.code===200&&(this.studentOptions=(t.data||[]).map(e=>({id:e.id||e.studentId||e.uid,name:e.name||e.realName||e.nickname})))}catch{}},async loadCampusOptions(){try{const t=await(await fetch("/api/base/campus/list")).json();t&&t.code===200&&(this.campusOptions=t.data||[])}catch{}},async loadRoomOptions(s){if(!s){this.roomOptions=[];return}try{const e=await(await fetch("/api/base/classroom/list?campusId="+encodeURIComponent(s))).json();e&&e.code===200&&(this.roomOptions=(e.data||[]).map(a=>({id:a.id||a.roomId||a.roomCode,name:a.name||a.roomName||a.code,usableSeats:a.usableSeats,campusId:a.campusId})))}catch{}},onCampusChange(s){this.filters.campusId=s,this.filters.room="",this.loadRoomOptions(s)},fmtDate(s){if(!s)return"";if(typeof s=="string")return s;try{return s&&s.toISOString?s.toISOString().slice(0,10):""}catch{return""}},async loadClassSchedule(){if(!this.filters.classId){this.$message.warning("请选择班级");return}const s=new URLSearchParams({classId:this.filters.classId}),t=this.fmtDate(this.filters.startDate),e=this.fmtDate(this.filters.endDate);t&&e&&(s.append("startDate",t),s.append("endDate",e));const i=await(await fetch("/api/schedule/query/class?"+s.toString())).json();this.list=i&&i.code===200?i.data||[]:[]},async loadTeacherSchedule(){if(!this.filters.teacherId){this.$message.warning("请选择教师");return}const s=new URLSearchParams({teacherId:this.filters.teacherId}),t=this.fmtDate(this.filters.startDate),e=this.fmtDate(this.filters.endDate);t&&e&&(s.append("startDate",t),s.append("endDate",e));const i=await(await fetch("/api/schedule/query/teacher?"+s.toString())).json();this.list=i&&i.code===200?i.data||[]:[]},async loadStudentSchedule(){if(!this.filters.studentId){this.$message.warning("请选择学员");return}const s=new URLSearchParams({studentId:this.filters.studentId}),t=this.fmtDate(this.filters.startDate),e=this.fmtDate(this.filters.endDate);t&&e&&(s.append("startDate",t),s.append("endDate",e));const i=await(await fetch("/api/schedule/query/student?"+s.toString())).json();this.list=i&&i.code===200?i.data||[]:[]},async loadRoomSchedule(){if(!this.filters.campusId||!this.filters.room){this.$message.warning("请选择校区与教室");return}const s=new URLSearchParams({campusId:this.filters.campusId,room:this.filters.room}),t=this.fmtDate(this.filters.startDate),e=this.fmtDate(this.filters.endDate);t&&e&&(s.append("startDate",t),s.append("endDate",e));const i=await(await fetch("/api/schedule/query/room?"+s.toString())).json();this.list=i&&i.code===200?i.data||[]:[]},buildExportTitle(){const s={class:"班级",teacher:"教师",student:"学员",room:"教室"},t=(this.fmtDate(this.filters.startDate)||"")+(this.filters.endDate?"~"+this.fmtDate(this.filters.endDate):""),e=this.activeTab==="class"?this.filters.classId:this.activeTab==="teacher"?this.filters.teacherId:this.activeTab==="student"?this.filters.studentId:this.filters.campusId+"#"+this.filters.room;return`课表_${s[this.activeTab]||this.activeTab}_${e||"全部"}_${t||"全部"}`},buildTableHtml(){const s=this.columns.map(a=>`<th>${a.title}</th>`).join(""),t=this.list.map(a=>`<tr>${this.columns.map(i=>`<td>${a[i.dataIndex]!==void 0&&a[i.dataIndex]!==null?String(a[i.dataIndex]):""}</td>`).join("")}</tr>`).join("");return`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:8px;text-align:left}</style></head><body><table><thead><tr>${s}</tr></thead><tbody>${t}</tbody></table></body></html>`},exportXls(){if(!this.list.length){this.$message.info("暂无数据可导出");return}const s=this.buildTableHtml(),t=new Blob([s],{type:"application/vnd.ms-excel"}),e=URL.createObjectURL(t),a=document.createElement("a");a.href=e,a.download=this.buildExportTitle()+".xls",a.click(),URL.revokeObjectURL(e)},exportCsv(){if(!this.list.length){this.$message.info("暂无数据可导出");return}const s=this.columns.map(l=>l.dataIndex),t=s.join(","),e=this.list.map(l=>s.map(n=>l[n]!==void 0&&l[n]!==null?String(l[n]).replace(/,/g,";"):"").join(",")),a=[t,...e].join(`
`),i=new Blob([a],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download="课表导出.csv",r.click(),URL.revokeObjectURL(o)},exportPdf(){if(!this.list.length){this.$message.info("暂无数据可导出");return}const s=this.buildTableHtml(),t=window.open("","_blank");if(!t){this.$message.error("无法打开打印窗口");return}t.document.open(),t.document.write(`<html><head><title>${this.buildExportTitle()}</title></head><body>${s}</body></html>`),t.document.close(),t.focus(),t.print()},printTable(){window.print()},async shareSchedule(){const s={dimension:this.activeTab,targetId:this.activeTab==="class"?this.filters.classId:this.activeTab==="teacher"?this.filters.teacherId:this.activeTab==="student"?this.filters.studentId:this.filters.campusId+"#"+this.filters.room,range:(this.fmtDate(this.filters.startDate)||"")+"~"+(this.fmtDate(this.filters.endDate)||"")},e=await(await fetch("/api/schedule/share",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();e&&e.code===200?this.$message.success("分享已入队"):this.$message.error("分享失败")}},watch:{$route(s,t){this.applyRouteFilters()}}};var p=function(){var t=this,e=t._self._c;return e("div",{staticClass:"schedule-view-container"},[e("div",{staticClass:"page-title"},[t._v("课表查询")]),e("a-tabs",{model:{value:t.activeTab,callback:function(a){t.activeTab=a},expression:"activeTab"}},[e("a-tab-pane",{key:"class",attrs:{tab:"班级课表"}},[e("a-space",{staticStyle:{width:"100%"},attrs:{direction:"vertical"}},[e("a-row",{attrs:{gutter:12}},[e("a-col",{attrs:{sm:8,xs:24}},[e("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择班级"},model:{value:t.filters.classId,callback:function(a){t.$set(t.filters,"classId",a)},expression:"filters.classId"}},t._l(t.classOptions,function(a){return e("a-select-option",{key:a.id,attrs:{value:a.id}},[t._v(t._s(a.name||"班级#"+a.id))])}),1)],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"开始日期"},model:{value:t.filters.startDate,callback:function(a){t.$set(t.filters,"startDate",a)},expression:"filters.startDate"}})],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"结束日期"},model:{value:t.filters.endDate,callback:function(a){t.$set(t.filters,"endDate",a)},expression:"filters.endDate"}})],1)],1),e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.loadClassSchedule}},[t._v("查询")]),e("a-button",{on:{click:t.exportXls}},[t._v("导出 Excel(xls)")]),e("a-button",{on:{click:t.exportPdf}},[t._v("导出 PDF")]),e("a-button",{on:{click:t.exportCsv}},[t._v("导出Excel(CSV)")]),e("a-button",{on:{click:t.printTable}},[t._v("打印")]),e("a-button",{on:{click:t.shareSchedule}},[t._v("分享")])],1),e("a-table",{attrs:{"data-source":t.list,columns:t.columns,rowKey:"id",pagination:!1}})],1)],1),e("a-tab-pane",{key:"teacher",attrs:{tab:"教师课表"}},[e("a-space",{staticStyle:{width:"100%"},attrs:{direction:"vertical"}},[e("a-row",{attrs:{gutter:12}},[e("a-col",{attrs:{sm:8,xs:24}},[e("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择教师"},model:{value:t.filters.teacherId,callback:function(a){t.$set(t.filters,"teacherId",a)},expression:"filters.teacherId"}},t._l(t.teacherOptions,function(a){return e("a-select-option",{key:a.id,attrs:{value:a.id}},[t._v(t._s(a.name||"老师#"+a.id))])}),1)],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"开始日期"},model:{value:t.filters.startDate,callback:function(a){t.$set(t.filters,"startDate",a)},expression:"filters.startDate"}})],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"结束日期"},model:{value:t.filters.endDate,callback:function(a){t.$set(t.filters,"endDate",a)},expression:"filters.endDate"}})],1)],1),e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.loadTeacherSchedule}},[t._v("查询")]),e("a-button",{on:{click:t.exportXls}},[t._v("导出 Excel(xls)")]),e("a-button",{on:{click:t.exportPdf}},[t._v("导出 PDF")]),e("a-button",{on:{click:t.exportCsv}},[t._v("导出Excel(CSV)")]),e("a-button",{on:{click:t.printTable}},[t._v("打印")]),e("a-button",{on:{click:t.shareSchedule}},[t._v("分享")])],1),e("a-table",{attrs:{"data-source":t.list,columns:t.columns,rowKey:"id",pagination:!1}})],1)],1),e("a-tab-pane",{key:"student",attrs:{tab:"学员课表"}},[e("a-space",{staticStyle:{width:"100%"},attrs:{direction:"vertical"}},[e("a-row",{attrs:{gutter:12}},[e("a-col",{attrs:{sm:8,xs:24}},[e("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择学员",allowClear:"","show-search":"",filterOption:!0},model:{value:t.filters.studentId,callback:function(a){t.$set(t.filters,"studentId",a)},expression:"filters.studentId"}},t._l(t.studentOptions,function(a){return e("a-select-option",{key:a.id,attrs:{value:a.id}},[t._v(t._s(a.name||"学员#"+a.id))])}),1)],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"开始日期"},model:{value:t.filters.startDate,callback:function(a){t.$set(t.filters,"startDate",a)},expression:"filters.startDate"}})],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"结束日期"},model:{value:t.filters.endDate,callback:function(a){t.$set(t.filters,"endDate",a)},expression:"filters.endDate"}})],1)],1),e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.loadStudentSchedule}},[t._v("查询")]),e("a-button",{on:{click:t.exportXls}},[t._v("导出 Excel(xls)")]),e("a-button",{on:{click:t.exportPdf}},[t._v("导出 PDF")]),e("a-button",{on:{click:t.exportCsv}},[t._v("导出Excel(CSV)")]),e("a-button",{on:{click:t.printTable}},[t._v("打印")]),e("a-button",{on:{click:t.shareSchedule}},[t._v("分享")])],1),e("a-table",{attrs:{"data-source":t.list,columns:t.columns,rowKey:"id",pagination:!1}})],1)],1),e("a-tab-pane",{key:"room",attrs:{tab:"教室课表"}},[e("a-space",{staticStyle:{width:"100%"},attrs:{direction:"vertical"}},[e("a-row",{attrs:{gutter:12}},[e("a-col",{attrs:{sm:8,xs:24}},[e("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择校区",allowClear:"","show-search":"",filterOption:!0},on:{change:t.onCampusChange},model:{value:t.filters.campusId,callback:function(a){t.$set(t.filters,"campusId",a)},expression:"filters.campusId"}},t._l(t.campusOptions,function(a){return e("a-select-option",{key:a.id,attrs:{value:a.id}},[t._v(t._s(a.name))])}),1)],1),e("a-col",{attrs:{sm:8,xs:24}},[e("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择教室",allowClear:"","show-search":"",filterOption:!0},model:{value:t.filters.room,callback:function(a){t.$set(t.filters,"room",a)},expression:"filters.room"}},t._l(t.roomOptions,function(a){return e("a-select-option",{key:a.id||a.name,attrs:{value:a.name}},[t._v(t._s(a.name)),a.usableSeats?[t._v("（可用座位："+t._s(a.usableSeats)+"）")]:t._e()],2)}),1)],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"开始日期"},model:{value:t.filters.startDate,callback:function(a){t.$set(t.filters,"startDate",a)},expression:"filters.startDate"}})],1),e("a-col",{attrs:{sm:8,xs:24}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{format:"YYYY-MM-DD",placeholder:"结束日期"},model:{value:t.filters.endDate,callback:function(a){t.$set(t.filters,"endDate",a)},expression:"filters.endDate"}})],1)],1),e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.loadRoomSchedule}},[t._v("查询")]),e("a-button",{on:{click:t.exportXls}},[t._v("导出 Excel(xls)")]),e("a-button",{on:{click:t.exportPdf}},[t._v("导出 PDF")]),e("a-button",{on:{click:t.exportCsv}},[t._v("导出Excel(CSV)")]),e("a-button",{on:{click:t.printTable}},[t._v("打印")]),e("a-button",{on:{click:t.shareSchedule}},[t._v("分享")])],1),e("a-table",{attrs:{"data-source":t.list,columns:t.columns,rowKey:"id",pagination:!1}})],1)],1)],1)],1)},m=[],f=d(u,p,m,!1,null,null,null,null);const D=f.exports;export{D as default};
