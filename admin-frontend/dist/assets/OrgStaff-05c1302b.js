import{n as m}from"./index-67337038.js";const p={name:"OrgStaffPage",data(){return{loadingDept:!1,loadingStaff:!1,deptTree:[],flatDepts:[],selectedDeptId:"",campuses:[],roles:[],filters:{campusId:""},staffList:[],pagination:{current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},columns:[{title:"姓名",dataIndex:"name"},{title:"账号",dataIndex:"username"},{title:"手机",dataIndex:"mobile"},{title:"角色",dataIndex:"roleNames",scopedSlots:{customRender:"roles"}},{title:"部门",dataIndex:"deptName"},{title:"校区",dataIndex:"campusName"},{title:"状态",dataIndex:"status"},{title:"操作",scopedSlots:{customRender:"action"}}],staffModal:{visible:!1,form:{id:"",name:"",username:"",password:"",mobile:"",roleIds:[],deptId:"",campusId:""}}}},computed:{staffCardTitle(){const a=this.flatDepts.find(t=>t.id===this.selectedDeptId);return a?`员工列表 - ${a.title}`:"员工列表"}},created(){Promise.all([this.loadCampuses(),this.loadRoles()]).then(()=>{this.loadDepts()})},methods:{async loadDepts(){this.loadingDept=!0;try{const a=this.filters.campusId?`?campusId=${this.filters.campusId}`:"",e=await(await fetch(`/api/base/dept/tree${a}`)).json();if(e&&e.code===200){const s=e.data||[];this.deptTree=s,this.flatDepts=this.flattenTree(s),!this.selectedDeptId&&this.flatDepts.length&&(this.selectedDeptId=this.flatDepts[0].id),this.loadStaff()}else this.useDeptFallback()}catch{this.useDeptFallback()}finally{this.loadingDept=!1}},useDeptFallback(){const a=[{id:"d1",title:"总部",children:[{id:"d1-1",title:"教务部"},{id:"d1-2",title:"招生部"}]},{id:"d2",title:"南校区",children:[{id:"d2-1",title:"教学组"}]}];this.deptTree=a,this.flatDepts=this.flattenTree(a),this.selectedDeptId=this.flatDepts[0].id,this.loadStaff()},flattenTree(a,t=[]){return a.forEach(e=>{t.push({id:e.id,title:e.title}),e.children&&e.children.length&&this.flattenTree(e.children,t)}),t},async loadCampuses(){try{const t=await(await fetch("/api/base/campus/list")).json();t&&t.code===200?(this.campuses=t.data||[],!this.filters.campusId&&this.campuses.length&&(this.filters.campusId=this.campuses[0].id)):this.campuses=[{id:"c1",name:"总部"},{id:"c2",name:"南校区"}]}catch{this.campuses=[{id:"c1",name:"总部"},{id:"c2",name:"南校区"}]}},onCampusChange(){this.loadDepts(),this.loadStaff()},async loadRoles(){try{const t=await(await fetch("/api/base/role/list")).json();if(t&&t.code===200){const e=Array.isArray(t.data)?t.data:[],s=new Set;this.roles=e.filter(l=>{const r=String(l&&l.id);return!r||s.has(r)?!1:(s.add(r),!0)})}else this.roles=[{id:1,name:"教务老师"},{id:2,name:"教师"}]}catch{this.roles=[{id:1,name:"教务老师"},{id:2,name:"教师"}]}},beforeUploadUserExcel(a){const t=new FormData;return t.append("file",a),fetch("/api/auth/user/import/excel",{method:"POST",body:t}).then(e=>e.json()).then(e=>{e&&e.code===200?(this.$message&&this.$message.success(`导入成功 ${e.data.success} 条，失败 ${e.data.failed} 条`),this.loadStaff()):this.$message&&this.$message.error("导入失败")}).catch(()=>{this.$message&&this.$message.error("导入请求失败")}),!1},genInitialAccounts(){fetch("/api/auth/user/init-accounts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:"staff"})}).then(a=>a.json()).then(a=>{a&&a.code===200?(this.$message&&this.$message.success(`已更新 ${a.data.updated} 个账号`),this.loadStaff()):this.$message&&this.$message.error("生成失败")}).catch(()=>{this.$message&&this.$message.error("生成请求失败")})},loadStaff(){this.loadingStaff=!0;const a=new URLSearchParams;this.selectedDeptId&&/^\d+$/.test(String(this.selectedDeptId))&&a.append("deptId",this.selectedDeptId),this.filters.campusId&&/^\d+$/.test(String(this.filters.campusId))&&a.append("campusId",this.filters.campusId),a.append("page",String(this.pagination.current||1)),a.append("size",String(this.pagination.pageSize||10)),fetch(`/api/base/staff/list?${a.toString()}`).then(t=>t.json()).then(t=>{if(t&&t.code===200){const e=t.data||{},s=Array.isArray(e)?e:e.items||[],l=i=>{const o=this.roles.find(n=>String(n.id)===String(i));return o?o.name:""},r=i=>{const o=this.campuses.find(n=>String(n.id)===String(i));return o?o.name:""},d=i=>{const o=this.flatDepts.find(n=>String(n.id)===String(i));return o?o.title:""};this.staffList=s.map(i=>{const o=String(i.roleIds||i.roleId||"").trim(),n=o?o.split(",").filter(Boolean):[],f=n.map(c=>l(c)).filter(Boolean);return{id:i.id||i.staffId||Math.random().toString(36).slice(2),name:i.name,username:i.username||"",mobile:i.mobile||"",roleIds:n,roleNames:f,roleId:i.roleId||"",deptId:i.deptId||"",deptName:d(i.deptId),campusId:i.campusId||"",campusName:r(i.campusId),status:i.status||"enabled"}}),this.pagination.total=e.total||s.length}else this.useStaffFallback();this.loadingStaff=!1}).catch(()=>{this.useStaffFallback(),this.loadingStaff=!1})},onTableChange(a){this.pagination.current=a.current,this.pagination.pageSize=a.pageSize,this.loadStaff()},useStaffFallback(){this.staffList=[{id:"s1",name:"张三",roleId:1,roleName:"教务老师",deptName:"教务部",campusName:"总部",status:"enabled"},{id:"s2",name:"李四",roleId:2,roleName:"教师",deptName:"教学组",campusName:"南校区",status:"disabled"}]},onDeptSelect(a){a&&a.length&&(this.selectedDeptId=a[0],this.loadStaff())},openStaffModal(){this.staffModal.visible=!0,this.staffModal.form={id:"",name:"",username:"",password:"",mobile:"",roleIds:[],deptId:this.selectedDeptId,campusId:this.filters.campusId}},closeStaffModal(){this.staffModal.visible=!1},editStaff(a){this.staffModal.visible=!0;const t=Array.isArray(a.roleIds)?a.roleIds.map(s=>String(s)):[],e=Array.from(new Set(t));this.staffModal.form={id:a.id,name:a.name,username:a.username||"",password:"",mobile:a.mobile||"",roleIds:e,deptId:a.deptId||this.selectedDeptId,campusId:a.campusId||this.filters.campusId}},saveStaff(){const a={...this.staffModal.form};Array.isArray(a.roleIds)&&(a.roleIds=Array.from(new Set(a.roleIds.map(s=>String(s)))));const t=a.id?`/api/base/staff/update/${a.id}`:"/api/base/staff/save",e=a.id?"PUT":"POST";fetch(t,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(s=>s.json()).then(s=>{s&&s.code===200?(this.closeStaffModal(),this.loadStaff(),this.$message&&this.$message.success("员工信息已保存")):(this.closeStaffModal(),this.loadStaff(),this.$message&&this.$message.error("保存失败，已回滚至列表"))}).catch(()=>{this.closeStaffModal(),this.loadStaff(),this.$message&&this.$message.error("保存失败，已回滚至列表")})},toggleStatus(a){const t=a.status==="enabled"?"disabled":"enabled";fetch(`/api/base/staff/status/${a.id}?status=${t}`,{method:"POST"}).then(e=>e.json()).then(e=>{e&&e.code===200?(a.status=t,this.$message&&this.$message.success("状态已更新")):(a.status=t,this.$message&&this.$message.warning("状态更新接口不可用，已在前端切换"))}).catch(()=>{a.status=t,this.$message&&this.$message.error("状态更新失败，已在前端切换")})},resetPassword(a){!a||!a.id||fetch(`/api/base/staff/reset-password/${a.id}`,{method:"POST"}).then(t=>t.json()).then(t=>{t&&t.code===200?this.$message&&this.$message.success("已初始化密码为 123456"):this.$message&&this.$message.error("初始化失败")}).catch(()=>{this.$message&&this.$message.error("初始化请求失败")})}}};var u=function(){var t=this,e=t._self._c;return e("div",{staticClass:"orgstaff-page"},[e("a-page-header",{attrs:{title:"组织与教职工管理","sub-title":"部门树与教职工列表"}}),e("a-row",{attrs:{gutter:16}},[e("a-col",{attrs:{span:6}},[e("a-card",{attrs:{title:"部门结构",bordered:""}},[e("a-tree",{attrs:{treeData:t.deptTree,defaultExpandAll:!0},on:{select:t.onDeptSelect}})],1),e("a-card",{staticStyle:{"margin-top":"12px"},attrs:{title:"过滤"}},[e("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择校区"},on:{change:t.onCampusChange},model:{value:t.filters.campusId,callback:function(s){t.$set(t.filters,"campusId",s)},expression:"filters.campusId"}},t._l(t.campuses,function(s){return e("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1)],1)],1),e("a-col",{attrs:{span:18}},[e("a-card",{attrs:{title:t.staffCardTitle,bordered:""}},[e("a-space",{staticStyle:{"margin-bottom":"12px"}},[e("a-button",{attrs:{type:"primary"},on:{click:t.openStaffModal}},[t._v("新增员工")]),e("a-upload",{attrs:{showUploadList:!1,beforeUpload:t.beforeUploadUserExcel}},[e("a-button",[t._v("导入用户Excel")])],1),e("a-button",{on:{click:t.genInitialAccounts}},[t._v("生成初始账号")]),e("a-button",{attrs:{loading:t.loadingStaff},on:{click:t.loadStaff}},[t._v("刷新")])],1),e("a-table",{attrs:{"data-source":t.staffList,columns:t.columns,rowKey:"id",pagination:t.pagination},on:{change:t.onTableChange},scopedSlots:t._u([{key:"status",fn:function(s,l,r){return[s==="enabled"?e("a-tag",{attrs:{color:"green"}},[t._v("启用")]):e("a-tag",{attrs:{color:"red"}},[t._v("停用")])]}},{key:"roles",fn:function(s,l){return[e("a-space",{attrs:{wrap:""}},t._l(l.roleNames||[],function(r,d){return e("a-tag",{key:r+"_"+d,attrs:{color:"blue"}},[t._v(t._s(r))])}),1)]}},{key:"action",fn:function(s,l,r){return[e("a-space",[e("a-button",{attrs:{size:"small"},on:{click:function(d){return t.editStaff(l)}}},[t._v("编辑")]),e("a-button",{attrs:{size:"small"},on:{click:function(d){return t.resetPassword(l)}}},[t._v("重置密码")]),e("a-button",{attrs:{size:"small",type:"danger"},on:{click:function(d){return t.toggleStatus(l)}}},[t._v(t._s((l&&l.status)==="enabled"?"停用":"启用"))])],1)]}}])})],1)],1)],1),e("a-modal",{attrs:{visible:t.staffModal.visible,title:"员工信息"},on:{ok:t.saveStaff,cancel:t.closeStaffModal}},[e("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[e("a-form-item",{attrs:{label:"姓名"}},[e("a-input",{attrs:{placeholder:"请输入姓名"},model:{value:t.staffModal.form.name,callback:function(s){t.$set(t.staffModal.form,"name",s)},expression:"staffModal.form.name"}})],1),e("a-form-item",{attrs:{label:"角色"}},[e("a-select",{attrs:{mode:"multiple",placeholder:"选择角色"},model:{value:t.staffModal.form.roleIds,callback:function(s){t.$set(t.staffModal.form,"roleIds",s)},expression:"staffModal.form.roleIds"}},t._l(t.roles,function(s,l){return e("a-select-option",{key:"role-"+String(s.id),attrs:{value:String(s.id)}},[t._v(t._s(s.name))])}),1)],1),e("a-form-item",{attrs:{label:"手机号码"}},[e("a-input",{attrs:{placeholder:"用于联系或作默认账号"},model:{value:t.staffModal.form.mobile,callback:function(s){t.$set(t.staffModal.form,"mobile",s)},expression:"staffModal.form.mobile"}})],1),e("a-form-item",{attrs:{label:"所属部门"}},[e("a-select",{attrs:{placeholder:"选择部门"},model:{value:t.staffModal.form.deptId,callback:function(s){t.$set(t.staffModal.form,"deptId",s)},expression:"staffModal.form.deptId"}},t._l(t.flatDepts,function(s){return e("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.title))])}),1)],1),e("a-form-item",{attrs:{label:"所属校区"}},[e("a-select",{attrs:{placeholder:"选择校区"},model:{value:t.staffModal.form.campusId,callback:function(s){t.$set(t.staffModal.form,"campusId",s)},expression:"staffModal.form.campusId"}},t._l(t.campuses,function(s){return e("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1)],1),e("a-form-item",{attrs:{label:"账号"}},[e("a-input",{attrs:{placeholder:"用于登录的账号名"},model:{value:t.staffModal.form.username,callback:function(s){t.$set(t.staffModal.form,"username",s)},expression:"staffModal.form.username"}})],1),e("a-form-item",{attrs:{label:"初始密码"}},[e("a-input",{attrs:{placeholder:"留空则使用默认密码"},model:{value:t.staffModal.form.password,callback:function(s){t.$set(t.staffModal.form,"password",s)},expression:"staffModal.form.password"}})],1)],1)],1)],1)},h=[],g=m(p,u,h,!1,null,null,null,null);const I=g.exports;export{I as default};
