import{n as l}from"./index-67337038.js";const d={name:"ReferralManage",data(){return{form:{referrerName:"",newStudentId:null},reward:{type:"coupon",amount:100},list:[],loadingList:!1,loadingStudents:!1,submitting:!1,studentOptions:[],columns:[{title:"ID",dataIndex:"id",key:"id"},{title:"推荐人ID",dataIndex:"referrerId",key:"referrerId"},{title:"新学员ID",dataIndex:"newStudentId",key:"newStudentId"},{title:"奖励规则",key:"rewardRule",scopedSlots:{customRender:"rewardRule"}},{title:"时间",dataIndex:"time",key:"time"}]}},computed:{canSubmit(){return!!(this.form.referrerName&&this.form.referrerName.trim())&&!!this.form.newStudentId&&!this.submitting}},methods:{formatReward(a){if(!a)return"-";const t={coupon:"代金券",cash:"现金"}[a.type]||a.type,r=a.amount!=null?Number(a.amount):"-";return`${t} ${r}`},async relate(){if(!(this.form.referrerName&&this.form.referrerName.trim())||!this.form.newStudentId){this.$message&&this.$message.error("请填写推荐人姓名与选择新学员");return}const a=await this.resolveReferrerIdByName(this.form.referrerName);if(!a){this.$message&&this.$message.error("未找到匹配的推荐人");return}const e={referrerId:Number(a),newStudentId:Number(this.form.newStudentId),rewardRule:{type:this.reward.type,amount:Number(this.reward.amount)}};this.submitting=!0;try{const r=await(await fetch("/api/student/referral/relate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();if(r.code===200){const s=r&&r.data,n=s&&s.id;this.$message&&this.$message.success(`关联成功，记录ID：${n}`),Number(a)===Number(s.referrerId)&&(!this.form.newStudentId||Number(this.form.newStudentId)===Number(s.newStudentId))?this.list=[s,...this.list||[]]:this.loadList()}else r.code===409?this.$message&&this.$message.warning(r.msg||"该转介绍关系已存在"):this.$message&&this.$message.error("失败："+(r.msg||"未知错误"))}catch{this.$message&&this.$message.error("网络错误或服务器不可用")}finally{this.submitting=!1}},async loadList(){this.loadingList=!0;try{const a=new URLSearchParams;if(this.form.referrerName&&this.form.referrerName.trim()){const r=await this.resolveReferrerIdByName(this.form.referrerName);r&&a.append("referrerId",r)}this.form.newStudentId&&a.append("newStudentId",this.form.newStudentId);const t=await(await fetch(`/api/student/referral/list?${a.toString()}`)).json();if(this.list=t.data||[],this.$message){const r=this.list.length;this.$message.success(`已加载 ${r} 条记录`)}}catch{this.$message&&this.$message.error("加载失败，请稍后重试")}finally{this.loadingList=!1}},resetFilter(){this.form.referrerName="",this.form.newStudentId=null,this.loadList()},async resolveReferrerIdByName(a){try{const e=`/api/student/search?name=${encodeURIComponent(a)}&limit=20`,r=await(await fetch(e)).json(),s=Array.isArray(r.data)?r.data:[],i=s.find(o=>String(o.name).trim()===String(a).trim())||s[0];return i&&i.id?Number(i.id):null}catch{return null}},async onStudentSearch(a){try{this.loadingStudents=!0;const e=`/api/student/search?name=${encodeURIComponent(a||"")}&limit=20`,r=await(await fetch(e)).json(),s=Array.isArray(r.data)?r.data:[];this.studentOptions=s.map(n=>({id:n.id,name:n.name}))}catch{this.studentOptions=[]}finally{this.loadingStudents=!1}}}};var m=function(){var e=this,t=e._self._c;return t("div",{staticClass:"referral-manage"},[t("a-page-header",{attrs:{title:"转介绍管理","sub-title":"记录关系与奖励规则"}}),t("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:"",title:"建立转介绍关系"}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[t("a-row",{attrs:{gutter:16}},[t("a-col",{attrs:{span:6}},[t("a-form-item",{attrs:{label:"推荐人姓名"}},[t("a-input",{attrs:{placeholder:"输入姓名"},model:{value:e.form.referrerName,callback:function(r){e.$set(e.form,"referrerName",r)},expression:"form.referrerName"}})],1)],1),t("a-col",{attrs:{span:8}},[t("a-form-item",{attrs:{label:"新学员"}},[t("a-select",{staticStyle:{width:"100%"},attrs:{showSearch:"",filterOption:!1,allowClear:"",placeholder:"选择学员"},on:{search:e.onStudentSearch},model:{value:e.form.newStudentId,callback:function(r){e.$set(e.form,"newStudentId",r)},expression:"form.newStudentId"}},e._l(e.studentOptions,function(r){return t("a-select-option",{key:r.id,attrs:{value:r.id}},[e._v(e._s(r.name))])}),1)],1)],1),t("a-col",{attrs:{span:6}},[t("a-form-item",{attrs:{label:"奖励类型"}},[t("a-select",{staticStyle:{width:"100%"},attrs:{allowClear:""},model:{value:e.reward.type,callback:function(r){e.$set(e.reward,"type",r)},expression:"reward.type"}},[t("a-select-option",{attrs:{value:"coupon"}},[e._v("代金券")]),t("a-select-option",{attrs:{value:"cash"}},[e._v("现金")])],1)],1)],1),t("a-col",{attrs:{span:6}},[t("a-form-item",{attrs:{label:"奖励金额"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0,step:.01},model:{value:e.reward.amount,callback:function(r){e.$set(e.reward,"amount",r)},expression:"reward.amount"}})],1)],1)],1),t("a-form-item",{attrs:{"wrapper-col":{span:16,offset:6}}},[t("a-space",[t("a-button",{attrs:{type:"primary",loading:e.submitting,disabled:!e.canSubmit},on:{click:e.relate}},[e._v("建立关系")]),t("a-button",{attrs:{loading:e.loadingList},on:{click:e.loadList}},[e._v("加载列表")]),t("a-button",{on:{click:e.resetFilter}},[e._v("重置筛选")])],1)],1)],1)],1),t("a-card",{attrs:{bordered:"",title:"转介绍记录"}},[t("a-table",{attrs:{"data-source":e.list,columns:e.columns,rowKey:"id",pagination:!1,loading:e.loadingList},scopedSlots:e._u([{key:"rewardRule",fn:function(r){return[e._v(" "+e._s(e.formatReward(r&&r.record&&r.record.rewardRule))+" ")]}}])})],1)],1)},c=[],u=l(d,m,c,!1,null,"ebcc2907",null,null);const h=u.exports;export{h as default};
