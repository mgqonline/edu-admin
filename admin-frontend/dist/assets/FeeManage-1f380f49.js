import{n as b}from"./index-67337038.js";const f={name:"FeeManage",data(){return{classOptions:[],classroomOptions:[],studentOptions:[],calc:{studentId:null,classId:null,classroomId:null,seatNo:null,unitPrice:0,hours:0,textbookFee:0,discount:0},totalFee:0,pay:{method:"",receiptNo:"",receiver:"",voucherUrl:""},voucherList:[],list:[],seatPreviewVisible:!1,seatLoading:!1,seatGrid:[],seatLabelMap:{},occupiedMap:{},columns:[{title:"学员ID",dataIndex:"studentId",key:"studentId"},{title:"类型",dataIndex:"opType",key:"opType",scopedSlots:{customRender:"opType"}},{title:"班级ID",dataIndex:"classId",key:"classId"},{title:"教室ID",dataIndex:"classroomId",key:"classroomId"},{title:"座位号",dataIndex:"seatNo",key:"seatNo"},{title:"总费用",dataIndex:"totalFee",key:"totalFee"},{title:"支付方式",dataIndex:"method",key:"method"},{title:"收据编号",dataIndex:"receiptNo",key:"receiptNo"},{title:"领取人",dataIndex:"receiver",key:"receiver"},{title:"状态",dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"操作",key:"action",scopedSlots:{customRender:"action"}}]}},computed:{totalFeeDisplay(){return Number(this.totalFee||0).toFixed(2)},seatOptions(){if(!this.calc.classroomId)return[];const s=(this.classroomOptions||[]).find(a=>a.id===this.calc.classroomId),e=Number(s&&(s.usableSeats!=null?s.usableSeats:s.capacity))||0,t=[];for(let a=1;a<=e;a++)t.push(a);return t}},methods:{async loadStudentOptions(){try{const e=await(await fetch("/api/student/list")).json(),t=Array.isArray(e.data)?e.data:[];this.studentOptions=t.map(a=>({id:a.id,name:a.name}))}catch{this.studentOptions=[]}},async loadClassOptions(){try{const e=await(await fetch("/api/class/list")).json();this.classOptions=Array.isArray(e.data)?e.data:[]}catch{this.classOptions=[]}},async loadClassroomOptions(){try{const e=await(await fetch("/api/base/classroom/list")).json();this.classroomOptions=Array.isArray(e.data)?e.data:[]}catch{this.classroomOptions=[]}},onClassChange(s){const e=this.classOptions.find(t=>t.id===s);e&&e.fee!=null&&(this.calc.unitPrice=Number(e.fee)||0),this.calc.seatNo=null,this.occupiedMap={},this.loadOccupiedSeats()},onClassroomChange(){this.calc.seatNo=null,this.seatLabelMap={},this.occupiedMap={},this.loadOccupiedSeats(),this.loadSeatLabels()},async onSeatDropdownOpen(s){s&&((!this.seatLabelMap||Object.keys(this.seatLabelMap).length===0)&&await this.loadSeatLabels(),await this.loadOccupiedSeats())},async loadSeatLabels(){if(this.seatLabelMap={},!!this.calc.classroomId)try{const e=await(await fetch(`/api/base/classroom/seats/${this.calc.classroomId}`)).json(),t=Array.isArray(e.data)?e.data:[],a={};let r=0;for(const o of t){if(!!!o.usable)continue;let n=o.seatNo!=null?Number(o.seatNo):null;(!Number.isFinite(n)||n<=0)&&(r+=1,n=r),a[n]=String(o.label||"")}this.seatLabelMap=a}catch{}},async loadOccupiedSeats(){if(this.occupiedMap={},!(!this.calc.classroomId||!this.calc.classId))try{const e=await(await fetch(`/api/finance/settlement/occupied-seats?classroomId=${this.calc.classroomId}&classId=${this.calc.classId}`)).json(),t=Array.isArray(e.data)?e.data:[],a={};t.forEach(r=>{const o=Number(r.seatNo);Number.isFinite(o)&&o>0&&(a[o]=String(r.studentName||"已占用"))}),this.occupiedMap=a}catch{}},async openSeatPreview(){if(!this.calc.classroomId){this.$message&&this.$message.warning("请先选择教室");return}this.seatPreviewVisible=!0,this.seatLoading=!0,this.seatGrid=[];try{const e=await(await fetch(`/api/base/classroom/seats/${this.calc.classroomId}`)).json(),t=Array.isArray(e.data)?e.data:[],a=t.reduce((c,i)=>Math.max(c,Number(i.rowIndex||0)),0),r=t.reduce((c,i)=>Math.max(c,Number(i.colIndex||0)),0),o=a+1,h=r+1,n=[],d=[];for(let c=0;c<o;c++){const i=[];for(let l=0;l<h;l++){const u=t.find(p=>Number(p.rowIndex)===c&&Number(p.colIndex)===l)||{usable:!1,label:`${String.fromCharCode(65+c)}${l+1}`};i.push({rowIndex:c,colIndex:l,label:u.label,usable:!!u.usable,seatNo:u&&u.seatNo!=null?Number(u.seatNo):null,occupiedName:""})}d.push(i)}for(let c=0;c<d.length;c++)for(let i=0;i<d[c].length;i++)d[c][i].usable&&n.push({r:c,c:i});t.some(c=>c&&c.seatNo!=null)||n.forEach((c,i)=>{d[c.r][c.c].seatNo=i+1});let m={};if(this.calc.classId)try{const i=await(await fetch(`/api/finance/settlement/occupied-seats?classroomId=${this.calc.classroomId}&classId=${this.calc.classId}`)).json();(Array.isArray(i.data)?i.data:[]).forEach(u=>{m[Number(u.seatNo)]=String(u.studentName||"已占用")}),this.occupiedMap=m}catch{}for(let c=0;c<d.length;c++)for(let i=0;i<d[c].length;i++){const l=d[c][i];l.seatNo&&m[l.seatNo]&&(l.occupiedName=m[l.seatNo],l.usable=!1)}this.seatGrid=d}catch{this.$message&&this.$message.error("座位数据加载失败"),this.seatPreviewVisible=!1}finally{this.seatLoading=!1}},onPickSeat(s){!s||!s.usable||s.occupiedName||(this.calc.seatNo=s.seatNo,this.seatPreviewVisible=!1)},async calculate(){try{const s={opType:"enroll",unitPrice:Number(this.calc.unitPrice||0),hours:Number(this.calc.hours||0),textbookFee:Number(this.calc.textbookFee||0),discount:Number(this.calc.discount||0)},t=await(await fetch("/api/finance/settlement/calculate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(t&&t.code===200)this.totalFee=Number(t.data&&t.data.totalFee||0);else throw new Error("计算失败")}catch{const{unitPrice:e,hours:t,textbookFee:a,discount:r}=this.calc,o=Number(e||0)*Number(t||0)+Number(a||0)-Number(r||0);this.totalFee=Math.max(0,Number.isFinite(o)?o:0)}},beforeUpload(s){const e=URL.createObjectURL(s);return this.pay.voucherUrl=e,this.voucherList=[{uid:s.uid||Date.now(),name:s.name,status:"done",url:e}],!1},genReceiptNo(){const s=new Date,e=s.getFullYear(),t=String(s.getMonth()+1).padStart(2,"0"),a=String(s.getDate()).padStart(2,"0"),r=String(s.getHours()).padStart(2,"0"),o=String(s.getMinutes()).padStart(2,"0"),h=String(s.getSeconds()).padStart(2,"0"),n=Math.random().toString(36).slice(2,6).toUpperCase();return`RC-${e}${t}${a}${r}${o}${h}-${n}`},async saveSettlement(){if(!this.calc.studentId||!this.calc.classId){this.$message&&this.$message.error("请填写学员与班级");return}if(!this.calc.classroomId||!this.calc.seatNo){this.$message&&this.$message.warning("请填写教室与座位");return}(!this.totalFee||Number(this.totalFee)<=0)&&this.calculate();const s={opType:"enroll",studentId:Number(this.calc.studentId),classId:Number(this.calc.classId),classroomId:Number(this.calc.classroomId),seatNo:Number(this.calc.seatNo),unitPrice:Number(this.calc.unitPrice||0),hours:Number(this.calc.hours||0),textbookFee:Number(this.calc.textbookFee||0),discount:Number(this.calc.discount||0),totalFee:Number(this.totalFee||0),method:this.pay.method||"",receiptNo:this.pay.receiptNo||this.genReceiptNo(),receiver:this.pay.receiver||"",voucherUrl:this.pay.voucherUrl||"",status:"paid"};try{const t=await(await fetch("/api/finance/settlement/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(t&&t.code===200)this.$message&&this.$message.success("收费记录已保存"),this.loadList();else if(t&&t.code===409)this.$message&&this.$message.error("该座位已被占用，请重新选择");else throw new Error("保存失败")}catch{this.$message&&this.$message.error("保存失败：接口不可用或网络错误")}},async loadList(){try{const e=await(await fetch("/api/finance/settlement/list")).json();this.list=Array.isArray(e.data)?e.data:[]}catch{this.list=[]}},async markArrears(s){try{const t=await(await fetch(`/api/finance/arrears/mark/${s.id}`,{method:"PUT"})).json();if(t&&t.code===200)this.$message&&this.$message.success("已标记欠费"),this.loadList();else throw new Error("失败")}catch{this.$message&&this.$message.error("标记失败")}},async sendReminder(s){const e={studentId:s.studentId,amountDue:s.totalFee,channels:["sms","wechat"]};try{const a=await(await fetch("/api/finance/reminder/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();if(a&&a.code===200)this.$message&&this.$message.success("提醒已发送");else throw new Error("失败")}catch{this.$message&&this.$message.error("提醒失败")}},async releaseSeat(s){if(!(!s||!s.id))try{const t=await(await fetch(`/api/finance/settlement/release-seat/${s.id}`,{method:"PUT"})).json();if(t&&t.code===200)this.$message&&this.$message.success("座位已释放"),await this.loadList(),this.calc.classId&&this.calc.classroomId&&s.classId===this.calc.classId&&s.classroomId===this.calc.classroomId&&await this.loadOccupiedSeats();else throw new Error("失败")}catch{this.$message&&this.$message.error("释放失败")}}},created(){this.loadStudentOptions(),this.loadClassOptions(),this.loadClassroomOptions(),this.loadList(),this.pay.receiptNo=this.genReceiptNo();try{const s=this.$route&&this.$route.query?this.$route.query:{};s&&s.studentId&&(this.calc.studentId=Number(s.studentId)||null)}catch{}}};var y=function(){var e=this,t=e._self._c;return t("div",{staticClass:"fee-manage"},[t("a-page-header",{attrs:{title:"学员报班缴费","sub-title":"选择班级、教室与座位后计算费用"}}),t("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:"",title:"报名与费用"}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[t("a-form-item",{attrs:{label:"学员"}},[t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择学员",allowClear:""},model:{value:e.calc.studentId,callback:function(a){e.$set(e.calc,"studentId",a)},expression:"calc.studentId"}},e._l(e.studentOptions,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.name)+"（ID: "+e._s(a.id)+"）")])}),1)],1),t("a-form-item",{attrs:{label:"报班班级"}},[t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择班级"},on:{change:e.onClassChange},model:{value:e.calc.classId,callback:function(a){e.$set(e.calc,"classId",a)},expression:"calc.classId"}},e._l(e.classOptions,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.name))])}),1)],1),t("a-form-item",{attrs:{label:"教室"}},[t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择教室",allowClear:""},on:{change:e.onClassroomChange},model:{value:e.calc.classroomId,callback:function(a){e.$set(e.calc,"classroomId",a)},expression:"calc.classroomId"}},e._l(e.classroomOptions,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.name)+"（可用座位："+e._s(Number(a.usableSeats||a.capacity||0))+"）")])}),1)],1),t("a-form-item",{attrs:{label:"座位"}},[t("a-space",[t("a-select",{staticStyle:{width:"300px"},attrs:{placeholder:"选择座位",disabled:!e.calc.classroomId||e.seatOptions.length===0,allowClear:""},on:{dropdownVisibleChange:e.onSeatDropdownOpen},model:{value:e.calc.seatNo,callback:function(a){e.$set(e.calc,"seatNo",a)},expression:"calc.seatNo"}},e._l(e.seatOptions,function(a){return t("a-select-option",{key:a,attrs:{value:a,disabled:!!e.occupiedMap[a]}},[e._v(" "+e._s(a)+" 号 - "+e._s(e.seatLabelMap[a]||"未知")+" "),e.occupiedMap[a]?[e._v("（已占用："+e._s(e.occupiedMap[a])+"）")]:e._e()],2)}),1),t("a-button",{attrs:{disabled:!e.calc.classroomId},on:{click:e.openSeatPreview}},[e._v("预览座位")])],1)],1),t("a-form-item",{attrs:{label:"课程单价"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.calc.unitPrice,callback:function(a){e.$set(e.calc,"unitPrice",a)},expression:"calc.unitPrice"}})],1),t("a-form-item",{attrs:{label:"课时数"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.calc.hours,callback:function(a){e.$set(e.calc,"hours",a)},expression:"calc.hours"}})],1),t("a-form-item",{attrs:{label:"教材费"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.calc.textbookFee,callback:function(a){e.$set(e.calc,"textbookFee",a)},expression:"calc.textbookFee"}})],1),t("a-form-item",{attrs:{label:"优惠活动"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.calc.discount,callback:function(a){e.$set(e.calc,"discount",a)},expression:"calc.discount"}})],1),t("a-form-item",{attrs:{"wrapper-col":{span:12,offset:6}}},[t("a-space",[t("a-button",{attrs:{type:"primary"},on:{click:e.calculate}},[e._v("计算费用")]),t("span",[e._v("总费用："),t("strong",[e._v(e._s(e.totalFeeDisplay))])])],1)],1)],1)],1),t("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:"",title:"收费与票据"}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[t("a-form-item",{attrs:{label:"支付方式"}},[t("a-select",{attrs:{placeholder:"选择支付方式"},model:{value:e.pay.method,callback:function(a){e.$set(e.pay,"method",a)},expression:"pay.method"}},[t("a-select-option",{attrs:{value:"cash"}},[e._v("现金")]),t("a-select-option",{attrs:{value:"wechat"}},[e._v("微信")]),t("a-select-option",{attrs:{value:"alipay"}},[e._v("支付宝")]),t("a-select-option",{attrs:{value:"bankcard"}},[e._v("银行卡")])],1)],1),t("a-form-item",{attrs:{label:"支付凭证"}},[t("a-upload",{attrs:{"before-upload":e.beforeUpload,"file-list":e.voucherList,"list-type":"picture"}},[t("a-button",[e._v("上传凭证")])],1)],1),t("a-form-item",{attrs:{label:"收据编号"}},[t("a-input",{attrs:{placeholder:"自动生成，可覆盖"},model:{value:e.pay.receiptNo,callback:function(a){e.$set(e.pay,"receiptNo",a)},expression:"pay.receiptNo"}})],1),t("a-form-item",{attrs:{label:"领取人"}},[t("a-input",{attrs:{placeholder:"填写领取人"},model:{value:e.pay.receiver,callback:function(a){e.$set(e.pay,"receiver",a)},expression:"pay.receiver"}})],1),t("a-form-item",{attrs:{"wrapper-col":{span:12,offset:6}}},[t("a-space",[t("a-button",{attrs:{type:"primary"},on:{click:e.saveSettlement}},[e._v("保存收费记录")]),t("a-button",{on:{click:e.loadList}},[e._v("刷新列表")])],1)],1)],1)],1),t("a-card",{attrs:{bordered:"",title:"欠费管理"}},[t("a-table",{attrs:{"data-source":e.list,columns:e.columns,rowKey:"id",pagination:!1},scopedSlots:e._u([{key:"opType",fn:function(a){return[(a&&a.text!==void 0?a.text:a)==="renew"?t("a-tag",{attrs:{color:"geekblue"}},[e._v("续费")]):t("a-tag",{attrs:{color:"blue"}},[e._v("报名")])]}},{key:"status",fn:function(a){return[(a&&a.text!==void 0?a.text:a)==="unpaid"?t("a-tag",{attrs:{color:"red"}},[e._v("未缴清")]):t("a-tag",{attrs:{color:"green"}},[e._v("已支付")])]}},{key:"action",fn:function(a){return[t("a-space",[a&&a.record&&a.record.status!=="unpaid"?t("a-button",{attrs:{size:"small"},on:{click:function(r){return e.markArrears(a&&a.record?a.record:null)}}},[e._v("标记欠费")]):e._e(),a&&a.record&&a.record.status==="unpaid"?t("a-button",{attrs:{size:"small",type:"primary"},on:{click:function(r){return e.sendReminder(a&&a.record?a.record:null)}}},[e._v("发送提醒")]):e._e(),a&&a.record&&a.record.seatNo?t("a-button",{attrs:{size:"small",danger:""},on:{click:function(r){return e.releaseSeat(a&&a.record?a.record:null)}}},[e._v("释放座位")]):e._e()],1)]}}])})],1),t("a-modal",{attrs:{title:"座位预览与选择",footer:null,width:"720px"},model:{value:e.seatPreviewVisible,callback:function(a){e.seatPreviewVisible=a},expression:"seatPreviewVisible"}},[e.seatLoading?t("div",[e._v("加载座位中...")]):t("div",{staticClass:"seat-grid"},e._l(e.seatGrid,function(a,r){return t("div",{key:"row-"+r,staticClass:"seat-row"},e._l(a,function(o){return t("div",{key:o.label,staticClass:"seat-cell",class:{disabled:!o.usable,occupied:!!o.occupiedName,selected:e.calc.seatNo===o.seatNo},on:{click:function(h){return e.onPickSeat(o)}}},[t("div",{staticClass:"seat-label"},[e._v(e._s(o.label))]),o.occupiedName?t("div",{staticClass:"seat-name"},[e._v(e._s(o.occupiedName))]):t("div",{staticClass:"seat-no"},[e._v("#"+e._s(o.seatNo))])])}),0)}),0)])],1)},v=[],N=b(f,y,v,!1,null,"31afad57",null,null);const w=N.exports;export{w as default};
