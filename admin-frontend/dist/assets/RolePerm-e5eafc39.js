import{n}from"./index-67337038.js";const m={name:"RolePermPage",data(){return{loadingRoles:!1,roleList:[],columns:[{title:"角色名称",dataIndex:"name"},{title:"角色编码",dataIndex:"code"},{title:"状态",dataIndex:"status",scopedSlots:{customRender:"status"}},{title:"操作",scopedSlots:{customRender:"action"}}],roleModal:{visible:!1,form:{id:"",name:"",code:""}},permModal:{visible:!1,roleId:"",allPerms:!1,menuPerms:[],buttonPerms:[],dataPerms:[]},permCatalog:{menus:[],buttons:[],dataScopes:[]}}},created(){this.loadRoles(),this.loadPermCatalog()},methods:{async loadPermCatalog(){try{const e=await(await fetch("/api/base/perm/catalog")).json();if(e&&e.code===200){const a=e.data||{};this.permCatalog={menus:a.menus||[],buttons:a.buttons||[],dataScopes:a.dataScopes||[]},this.$message&&this.$message.success("权限目录已加载")}else this.usePermCatalogFallback(),this.$message&&this.$message.warning("权限目录接口不可用，使用本地数据")}catch{this.usePermCatalogFallback(),this.$message&&this.$message.error("权限目录加载失败，使用本地数据")}},usePermCatalogFallback(){this.permCatalog={menus:[{label:"attendance",value:"menu:attendance"},{label:"base",value:"menu:base"},{label:"scheduling",value:"menu:scheduling"},{label:"student",value:"menu:student"}],buttons:[{label:"排课编辑",value:"btn:scheduling:edit"},{label:"退款审批",value:"btn:refund:approve"}],dataScopes:[{label:"本校区数据",value:"data:campus:own"},{label:"本班级数据",value:"data:class:own"}]}},async loadRoles(){this.loadingRoles=!0;try{const e=await(await fetch("/api/base/role/list")).json();e&&e.code===200?(this.roleList=e.data||[],this.$message&&this.$message.success("角色列表已加载")):(this.useRoleFallback(),this.$message&&this.$message.warning("角色接口不可用，使用本地数据"))}catch{this.useRoleFallback(),this.$message&&this.$message.error("角色列表加载失败，使用本地数据")}finally{this.loadingRoles=!1}},useRoleFallback(){this.roleList=[{id:"r1",name:"超级管理员",code:"super_admin",status:"enabled"},{id:"r2",name:"校区管理员",code:"campus_admin",status:"enabled"},{id:"r3",name:"教务老师",code:"edu_teacher",status:"enabled"}]},openRoleModal(){this.roleModal.visible=!0,this.roleModal.form={id:"",name:"",code:""}},closeRoleModal(){this.roleModal.visible=!1},editRole(t){this.roleModal.visible=!0,this.roleModal.form={id:t.id,name:t.name,code:t.code}},async saveRole(){const t={...this.roleModal.form};try{const e=t.id?`/api/base/role/update/${t.id}`:"/api/base/role/save",a=t.id?"PUT":"POST",o=await(await fetch(e,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();if(o&&o.code===200)this.closeRoleModal(),this.loadRoles(),this.$message&&this.$message.success("角色信息已保存");else throw new Error("保存失败")}catch{this.closeRoleModal(),this.loadRoles(),this.$message&&this.$message.error("保存角色失败，已回滚至列表")}},async toggleRole(t){const e=t.status==="enabled"?"disabled":"enabled";try{const s=await(await fetch(`/api/base/role/disable/${t.id}`,{method:"POST"})).json();s&&s.code===200?(t.status=e,this.$message&&this.$message.success("角色状态已更新")):(t.status=e,this.$message&&this.$message.warning("状态更新接口不可用，已在前端切换"))}catch{t.status=e,this.$message&&this.$message.error("状态更新失败，已在前端切换")}},async openPermModal(t){this.permModal.visible=!0,this.permModal.roleId=t.id,this.permModal.allPerms=!1,this.permModal.menuPerms=[],this.permModal.buttonPerms=[],this.permModal.dataPerms=[];try{const a=await(await fetch(`/api/base/role/perms/${t.id}`)).json();if(a&&a.code===200){const s=new Set(a.data||[]);s.has("*")&&(this.permModal.allPerms=!0);const o=(this.permCatalog.menus||[]).map(l=>l.value),r=(this.permCatalog.buttons||[]).map(l=>l.value),i=(this.permCatalog.dataScopes||[]).map(l=>l.value);this.permModal.menuPerms=[...s].filter(l=>o.includes(l)),this.permModal.buttonPerms=[...s].filter(l=>r.includes(l)),this.permModal.dataPerms=[...s].filter(l=>i.includes(l))}}catch{}},closePermModal(){this.permModal.visible=!1},async savePerms(){const t=this.permModal.allPerms,e=new Set;t&&e.add("*"),this.permModal.menuPerms.forEach(a=>e.add(a)),this.permModal.buttonPerms.forEach(a=>e.add(a)),this.permModal.dataPerms.forEach(a=>e.add(a));try{const s=await(await fetch(`/api/base/role/perms/${this.permModal.roleId}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Array.from(e))})).json();s&&s.code===200?(this.closePermModal(),this.$message&&this.$message.success("权限已保存")):(this.closePermModal(),this.$message&&this.$message.warning("保存失败，请稍后重试"))}catch{this.closePermModal(),this.$message&&this.$message.error("保存权限时发生错误")}}}};var d=function(){var e=this,a=e._self._c;return a("div",{staticClass:"roleperm-page"},[a("a-page-header",{attrs:{title:"角色与权限管理","sub-title":"维护角色信息与权限分配"}}),a("a-space",{staticStyle:{width:"100%"},attrs:{direction:"vertical"}},[a("a-space",[a("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"base:role:add",expression:"'base:role:add'"}],attrs:{type:"primary"},on:{click:e.openRoleModal}},[e._v("新增角色")]),a("a-button",{attrs:{loading:e.loadingRoles},on:{click:e.loadRoles}},[e._v("刷新")])],1),a("a-table",{attrs:{"data-source":e.roleList,columns:e.columns,rowKey:"id",pagination:!1},scopedSlots:e._u([{key:"status",fn:function(s,o){return[o.status==="enabled"?a("a-tag",{attrs:{color:"green"}},[e._v("启用")]):a("a-tag",{attrs:{color:"red"}},[e._v("停用")])]}},{key:"action",fn:function(s,o){return[a("a-space",[a("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"base:role:edit",expression:"'base:role:edit'"}],attrs:{size:"small"},on:{click:function(r){return e.editRole(o)}}},[e._v("编辑")]),a("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"base:role:perm",expression:"'base:role:perm'"}],attrs:{size:"small"},on:{click:function(r){return e.openPermModal(o)}}},[e._v("权限")]),a("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"base:role:toggle",expression:"'base:role:toggle'"}],attrs:{size:"small",type:"danger"},on:{click:function(r){return e.toggleRole(o)}}},[e._v(e._s(o.status==="enabled"?"禁用":"启用"))])],1)]}}])})],1),a("a-modal",{attrs:{visible:e.roleModal.visible,title:"角色信息"},on:{ok:e.saveRole,cancel:e.closeRoleModal}},[a("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[a("a-form-item",{attrs:{label:"角色名称"}},[a("a-input",{attrs:{placeholder:"例如：教务老师"},model:{value:e.roleModal.form.name,callback:function(s){e.$set(e.roleModal.form,"name",s)},expression:"roleModal.form.name"}})],1),a("a-form-item",{attrs:{label:"角色编码"}},[a("a-input",{attrs:{placeholder:"例如：edu_teacher"},model:{value:e.roleModal.form.code,callback:function(s){e.$set(e.roleModal.form,"code",s)},expression:"roleModal.form.code"}})],1)],1)],1),a("a-modal",{attrs:{visible:e.permModal.visible,title:"权限分配",width:720},on:{ok:e.savePerms,cancel:e.closePermModal}},[a("a-alert",{staticStyle:{"margin-bottom":"12px"},attrs:{type:"info","show-icon":"",message:"为当前角色勾选可用的功能权限。勾选'全部权限'将赋予'*'。"}}),a("a-checkbox",{model:{value:e.permModal.allPerms,callback:function(s){e.$set(e.permModal,"allPerms",s)},expression:"permModal.allPerms"}},[e._v("全部权限")]),a("a-row",{staticStyle:{"margin-top":"12px"},attrs:{gutter:16}},[a("a-col",{attrs:{span:12}},[a("a-card",{attrs:{title:"菜单权限"}},[a("a-checkbox-group",{attrs:{options:e.permCatalog.menus},model:{value:e.permModal.menuPerms,callback:function(s){e.$set(e.permModal,"menuPerms",s)},expression:"permModal.menuPerms"}})],1)],1),a("a-col",{attrs:{span:12}},[a("a-card",{attrs:{title:"按钮权限"}},[a("a-checkbox-group",{attrs:{options:e.permCatalog.buttons},model:{value:e.permModal.buttonPerms,callback:function(s){e.$set(e.permModal,"buttonPerms",s)},expression:"permModal.buttonPerms"}})],1)],1)],1),a("a-row",{staticStyle:{"margin-top":"12px"},attrs:{gutter:16}},[a("a-col",{attrs:{span:24}},[a("a-card",{attrs:{title:"数据范围"}},[a("a-checkbox-group",{attrs:{options:e.permCatalog.dataScopes},model:{value:e.permModal.dataPerms,callback:function(s){e.$set(e.permModal,"dataPerms",s)},expression:"permModal.dataPerms"}})],1)],1)],1)],1)],1)},c=[],u=n(m,d,c,!1,null,null,null,null);const h=u.exports;export{h as default};
