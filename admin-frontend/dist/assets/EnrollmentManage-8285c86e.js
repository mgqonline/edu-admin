import{n}from"./index-67337038.js";const o={name:"EnrollmentManage",data(){return{form:{studentId:null,classId:null,applyInfo:"",fee:0,approvalRequired:!1},list:[],classes:[],selectedClass:null,columns:[{title:"ID",dataIndex:"id",key:"id"},{title:"学员ID",dataIndex:"studentId",key:"studentId"},{title:"班级ID",dataIndex:"classId",key:"classId"},{title:"费用",dataIndex:"fee",key:"fee"},{title:"审批",key:"approval",customRender:(a,e)=>e.approvalRequired?"需审批":"免审批"},{title:"状态",dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"合同",key:"contract",scopedSlots:{customRender:"contract"}},{title:"操作",key:"action",scopedSlots:{customRender:"action"}}]}},methods:{isValidId(a){return Number.isFinite(Number(a))&&Number(a)>0},isValidMoney(a){const e=Number(a);return Number.isFinite(e)&&e>=0},validateForm(){return this.isValidId(this.form.studentId)?this.isValidId(this.form.classId)?this.isValidMoney(this.form.fee)?!0:(this.$message&&this.$message.error("请填写有效的费用"),!1):(this.$message&&this.$message.error("请填写或选择有效的班级"),!1):(this.$message&&this.$message.error("请填写有效的学员ID"),!1)},async loadClassOptions(){try{const e=await(await fetch("/api/class/list")).json();this.classes=Array.isArray(e.data)?e.data:[]}catch{this.classes=[]}},onClassChange(a){this.form.classId=a,this.selectedClass=this.classes.find(e=>e.id===a)||null,this.selectedClass&&this.selectedClass.fee!=null&&(this.form.fee=Number(this.selectedClass.fee)||0),this.autoApproval()},applyClassFee(){this.selectedClass&&this.selectedClass.fee!=null&&(this.form.fee=Number(this.selectedClass.fee)||0,this.$message&&this.$message.success("已按班级费用填充"),this.autoApproval())},onFeeChange(a){this.form.fee=Number(a)||0,this.autoApproval()},autoApproval(){try{const a=(Number(this.form.fee)||0)>=2e3;this.form.approvalRequired=a}catch{}},prefillFromQuery(){const a=this.$route&&this.$route.query?this.$route.query:{};a.studentId&&(this.form.studentId=Number(a.studentId)||null);const e=a.auditionId?String(a.auditionId):"",s=a.recommend?String(a.recommend):"";if(e||s){const t=`来自试听${e?"#"+e:""}${s?"，推荐："+s:""}`;this.form.applyInfo=t,this.form.approvalRequired=!0,this.$message&&this.$message.info("已根据试听结果预填报名信息")}},async apply(){if(!this.validateForm())return;const e=await(await fetch("/api/enroll/apply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.form)})).json();e.code===200?(this.$message&&this.$message.success("报名提交成功"),this.loadList()):this.$message&&this.$message.error("失败："+(e.msg||"未知错误"))},async loadList(){const e=await(await fetch("/api/enroll/list")).json();this.list=e.data||[]},async generateContract(a){if(!a||!a.id){this.$message&&this.$message.warning("无法生成合同：记录不存在");return}const s=await(await fetch("/api/enroll/contract/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enrollId:a.id})})).json();s.code===200?(this.$message&&this.$message.success("合同已生成"),this.loadList()):this.$message&&this.$message.error("失败："+(s.msg||"未知错误"))},async signContract(a){if(!a||!a.id){this.$message&&this.$message.warning("无法签署：记录不存在");return}const s=await(await fetch("/api/enroll/contract/sign",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enrollId:a.id})})).json();s.code===200?(this.$message&&this.$message.success("电子签名完成"),this.loadList()):this.$message&&this.$message.error("失败："+(s.msg||"未知错误"))},async approve(a,e){if(!a||!a.id){this.$message&&this.$message.warning("无法审批：记录不存在");return}const t=await(await fetch("/api/enroll/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enrollId:a.id,action:e?"approve":"reject"})})).json();t.code===200?(this.$message&&this.$message.success(e?"审批通过":"审批拒绝"),this.loadList()):this.$message&&this.$message.error("失败："+(t.msg||"未知错误"))},async cleanupInvalid(){try{(!Array.isArray(this.list)||this.list.length===0)&&await this.loadList();const a=(this.list||[]).filter(t=>!this.isValidId(t.studentId)||!this.isValidId(t.classId)||!this.isValidMoney(t.fee));if(a.length===0){this.$message&&this.$message.info("没有需要清理的空记录");return}let e=0,s=0;for(const t of a)try{const r=await(await fetch("/api/enroll/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t.id})})).json();r&&r.code===200?e++:s++}catch{s++}if(e>0)this.$message&&this.$message.success(`清理完成：成功 ${e} 条，失败 ${s} 条`),await this.loadList();else{const t=this.list.length;this.list=(this.list||[]).filter(r=>this.isValidId(r.studentId)&&this.isValidId(r.classId)&&this.isValidMoney(r.fee));const i=t-this.list.length;this.$message&&this.$message.info(`后端未提供删除接口，已从列表隐藏 ${i} 条无效记录`)}}catch{this.$message&&this.$message.error("清理失败：网络或服务异常")}}},mounted(){this.loadList(),this.prefillFromQuery(),this.loadClassOptions()}};var l=function(){var e=this,s=e._self._c;return s("div",{staticClass:"enroll-manage"},[s("a-page-header",{attrs:{title:"报名管理","sub-title":"报名、合同与审批"}}),s("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:"",title:"提交报名"}},[s("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[s("a-row",{attrs:{gutter:16}},[s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"学员ID"}},[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:1},model:{value:e.form.studentId,callback:function(t){e.$set(e.form,"studentId",t)},expression:"form.studentId"}})],1)],1),s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"班级"}},[e.classes.length?[s("a-select",{staticStyle:{width:"100%"},attrs:{"show-search":"",allowClear:"",placeholder:"选择班级"},on:{change:e.onClassChange},model:{value:e.form.classId,callback:function(t){e.$set(e.form,"classId",t)},expression:"form.classId"}},e._l(e.classes,function(t){return s("a-select-option",{key:t.id,attrs:{value:t.id}},[e._v(e._s(t.name||"班级#"+t.id))])}),1)]:[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:1,placeholder:"班级ID"},model:{value:e.form.classId,callback:function(t){e.$set(e.form,"classId",t)},expression:"form.classId"}})]],2)],1),s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"报名信息"}},[s("a-input",{attrs:{placeholder:"备注或补充说明"},model:{value:e.form.applyInfo,callback:function(t){e.$set(e.form,"applyInfo",t)},expression:"form.applyInfo"}})],1)],1),s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"费用"}},[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0,step:.01},on:{change:e.onFeeChange},model:{value:e.form.fee,callback:function(t){e.$set(e.form,"fee",t)},expression:"form.fee"}})],1)],1)],1),s("a-form-item",{attrs:{"wrapper-col":{span:16,offset:6}}},[s("a-space",[s("a-checkbox",{model:{value:e.form.approvalRequired,callback:function(t){e.$set(e.form,"approvalRequired",t)},expression:"form.approvalRequired"}},[e._v("需审批")]),e.selectedClass&&e.selectedClass.fee?s("a-button",{on:{click:e.applyClassFee}},[e._v("按班级费用")]):e._e(),s("a-button",{attrs:{type:"primary"},on:{click:e.apply}},[e._v("提交报名")]),s("a-button",{on:{click:e.loadList}},[e._v("加载列表")]),s("a-button",{attrs:{type:"dashed"},on:{click:e.cleanupInvalid}},[e._v("清理空记录")])],1)],1)],1)],1),s("a-card",{attrs:{bordered:"",title:"报名列表"}},[s("a-table",{attrs:{"data-source":e.list,columns:e.columns,rowKey:"id",pagination:!1},scopedSlots:e._u([{key:"status",fn:function(t){return[t.text==="pending"?s("a-tag",{attrs:{color:"orange"}},[e._v("待处理")]):t.text==="approved"?s("a-tag",{attrs:{color:"green"}},[e._v("已通过")]):t.text==="rejected"?s("a-tag",{attrs:{color:"red"}},[e._v("已拒绝")]):s("a-tag",[e._v("未知")])]}},{key:"contract",fn:function(t){return[t&&t.record&&t.record.contractUrl?s("span",[s("a",{attrs:{href:t.record.contractUrl,target:"_blank"}},[e._v("查看合同")])]):s("span",[e._v("未生成")])]}},{key:"action",fn:function(t){return[t&&t.record&&t.record.id?s("a-space",[s("a-button",{attrs:{size:"small"},on:{click:function(i){return e.generateContract(t.record)}}},[e._v("生成合同")]),s("a-button",{attrs:{size:"small",disabled:!(t&&t.record&&t.record.contractUrl)||t&&t.record&&t.record.signed},on:{click:function(i){return e.signContract(t.record)}}},[e._v("电子签名")]),t&&t.record&&t.record.approvalRequired?s("a-button",{attrs:{size:"small",type:"primary"},on:{click:function(i){return e.approve(t.record,!0)}}},[e._v("审批通过")]):e._e(),t&&t.record&&t.record.approvalRequired?s("a-button",{attrs:{size:"small",type:"danger"},on:{click:function(i){return e.approve(t.record,!1)}}},[e._v("审批拒绝")]):e._e()],1):s("span",[e._v("—")])]}}])})],1)],1)},c=[],d=n(o,l,c,!1,null,"920694a5",null,null);const h=d.exports;export{h as default};
