import{n as I,_ as p}from"./index-67337038.js";const b={name:"AuditionManage",components:{V2SimpleDate:()=>p(()=>import("./V2SimpleDate-11821f76.js"),["assets/V2SimpleDate-11821f76.js","assets/index-67337038.js","assets/index-f5f188af.css","assets/V2SimpleDate-9b3aafb8.css"])},data(){return{form:{studentId:null,courseId:null,teacherId:null,time:""},list:[],courses:[],students:[],teachers:[],columns:[{title:"ID",dataIndex:"id",key:"id"},{title:"学员",dataIndex:"studentName",key:"studentName"},{title:"课程",dataIndex:"courseName",key:"courseName"},{title:"教师",dataIndex:"teacherName",key:"teacherName"},{title:"时间",dataIndex:"time",key:"time"},{title:"状态",dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"操作",key:"action",scopedSlots:{customRender:"action"}}]}},methods:{noop(){},onTimeChange(i){this.form.time=(i||"").toString()},isValidId(i){return Number.isFinite(Number(i))&&Number(i)>0},validateForm(){const{studentId:i,courseId:e,teacherId:s,time:t}=this.form;return this.isValidId(i)?this.isValidId(e)?this.isValidId(s)?!t||String(t).trim().length===0?(this.$message&&this.$message.error("请选择试听时间"),!1):!0:(this.$message&&this.$message.error("请填写或选择有效的教师"),!1):(this.$message&&this.$message.error("请填写或选择有效的课程"),!1):(this.$message&&this.$message.error("请填写有效的学员ID"),!1)},async book(){if(!this.validateForm())return;const i={studentId:Number(this.form.studentId),courseId:Number(this.form.courseId),teacherId:Number(this.form.teacherId),time:this.form.time},s=await(await fetch("/api/audition/book",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();s.code===200?(this.$message&&this.$message.success("预约成功"),this.loadList()):this.$message&&this.$message.error("预约失败："+(s.msg||"未知错误"))},studentNameById(i){const e=String(i),s=(this.students||[]).find(t=>String(t._studentId)===e);return s&&s.name||"学员#"+e},courseNameById(i){const e=String(i),s=(this.courses||[]).find(t=>String(t._courseId)===e);return s&&s.name||"课程#"+e},teacherNameById(i){const e=String(i),s=(this.teachers||[]).find(t=>String(t._teacherId)===e);return s&&s.name||"教师#"+e},async loadList(){const e=await(await fetch("/api/audition/list")).json();this.list=(e.data||[]).map(s=>({...s,studentName:this.studentNameById(s.studentId),courseName:this.courseNameById(s.courseId),teacherName:this.teacherNameById(s.teacherId),_feedback:"",_result:"适合报班"}))},async cleanupInvalid(){try{(!Array.isArray(this.list)||this.list.length===0)&&await this.loadList();const i=(this.list||[]).filter(t=>!this.isValidId(t.studentId)||!this.isValidId(t.courseId)||!this.isValidId(t.teacherId)||!t.time);if(i.length===0){this.$message&&this.$message.info("没有需要清理的空记录");return}let e=0,s=0;for(const t of i)try{const d=await(await fetch("/api/audition/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t.id})})).json();d&&d.code===200?e++:s++}catch{s++}if(e>0)this.$message&&this.$message.success(`清理完成：成功 ${e} 条，失败 ${s} 条`),await this.loadList();else{const t=this.list.length;this.list=(this.list||[]).filter(d=>this.isValidId(d.studentId)&&this.isValidId(d.courseId)&&this.isValidId(d.teacherId)&&!!d.time);const o=t-this.list.length;this.$message&&this.$message.info(`后端未提供删除接口，已从列表隐藏 ${o} 条无效记录`)}}catch{this.$message&&this.$message.error("清理失败：网络或服务异常")}},async loadOptions(){try{const[i,e,s]=await Promise.all([fetch("/api/course/list"),fetch("/api/teacher/list"),fetch("/api/student/list")]),t=await i.json().catch(()=>({})),o=await e.json().catch(()=>({})),d=await s.json().catch(()=>({})),u=t&&t.code===200&&Array.isArray(t.data)?t.data:Array.isArray(t)?t:Array.isArray(t.items)?t.items:[],m=a=>{const r=a.status!=null?a.status:a.state!=null?a.state:a.publishStatus!=null?a.publishStatus:null;if(typeof r=="string"){const n=r.toLowerCase();return n==="published"||n==="已发布"||n==="online"||n==="enabled"}return r===!0||r===1||r==="1"};let l=u.filter(a=>m(a)).map(a=>{const r=Number(a.courseId),n=Number(a.id),c=Number.isFinite(r)&&r>0?r:Number.isFinite(n)&&n>0?n:null;return Object.assign({},a,{_courseId:c})}).filter(a=>Number.isFinite(a._courseId)&&a._courseId>0);l.length||(l=u.map(a=>{const r=Number(a.courseId),n=Number(a.id),c=Number.isFinite(r)&&r>0?r:Number.isFinite(n)&&n>0?n:null;return Object.assign({},a,{_courseId:c})}).filter(a=>Number.isFinite(a._courseId)&&a._courseId>0)),this.courses=l;const h=Array.isArray(o.data)?o.data:[];this.teachers=h.map(a=>{const r=Number(a.teacherId),n=Number(a.id),c=Number.isFinite(r)&&r>0?r:Number.isFinite(n)&&n>0?n:null;return Object.assign({},a,{_teacherId:c})}).filter(a=>Number.isFinite(a._teacherId)&&a._teacherId>0);const f=Array.isArray(d.data)?d.data:[];this.students=f.map(a=>{const r=Number(a.id),n=Number(a.studentId),c=Number.isFinite(r)&&r>0?r:Number.isFinite(n)&&n>0?n:null;return Object.assign({},a,{_studentId:c})}).filter(a=>Number.isFinite(a._studentId)&&a._studentId>0)}catch{this.courses=[],this.students=[],this.teachers=[]}},async submitFeedback(i){const e={id:i.id,feedback:i._feedback,result:i._result},t=await(await fetch("/api/audition/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();t.code===200?(this.$message&&this.$message.success("反馈已提交"),this.loadList()):this.$message&&this.$message.error("失败："+(t.msg||"未知错误"))},async convert(i){const s=await(await fetch("/api/audition/convert",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({auditionId:i.id})})).json();if(s.code===200){this.$message&&this.$message.success("可转为正式学员，已为你跳转到报名页");const t=i._result||i.result||"适合报班";this.$router&&this.$router.push({path:"/student/enroll",query:{studentId:i.studentId,auditionId:i.id,recommend:t}})}else this.$message&&this.$message.error("转化失败："+(s.msg||"未知错误"))}},async mounted(){await this.loadOptions(),await this.loadList()}};var _=function(){var e=this,s=e._self._c;return s("div",{staticClass:"audition-manage"},[s("a-page-header",{attrs:{title:"试听管理","sub-title":"预约、反馈与转化"}}),s("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:"",title:"预约试听"}},[s("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[s("a-row",{attrs:{gutter:16}},[s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"学员"}},[e.students.length?[s("a-select",{staticStyle:{width:"100%"},attrs:{"show-search":"",allowClear:"",placeholder:"选择学员"},model:{value:e.form.studentId,callback:function(t){e.$set(e.form,"studentId",t)},expression:"form.studentId"}},e._l(e.students,function(t){return s("a-select-option",{key:t._studentId,attrs:{value:t._studentId}},[e._v(e._s(t.name||"学员#"+t._studentId))])}),1)]:[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:1,placeholder:"学员ID"},model:{value:e.form.studentId,callback:function(t){e.$set(e.form,"studentId",t)},expression:"form.studentId"}})]],2)],1),s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"课程"}},[e.courses.length?[s("a-select",{staticStyle:{width:"100%"},attrs:{"show-search":"",allowClear:"",placeholder:"选择课程"},model:{value:e.form.courseId,callback:function(t){e.$set(e.form,"courseId",t)},expression:"form.courseId"}},e._l(e.courses,function(t){return s("a-select-option",{key:t._courseId,attrs:{value:t._courseId,disabled:t.status&&t.status!=="published"}},[e._v(e._s((t.name||"课程#"+t._courseId)+(t.status?" ["+(t.status==="published"?"已发布":t.status==="draft"?"草稿":"已下架")+"]":"")))])}),1)]:[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:1,placeholder:"课程ID"},model:{value:e.form.courseId,callback:function(t){e.$set(e.form,"courseId",t)},expression:"form.courseId"}})]],2)],1),s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"教师"}},[e.teachers.length?[s("a-select",{staticStyle:{width:"100%"},attrs:{"show-search":"",allowClear:"",placeholder:"选择教师"},model:{value:e.form.teacherId,callback:function(t){e.$set(e.form,"teacherId",t)},expression:"form.teacherId"}},e._l(e.teachers,function(t){return s("a-select-option",{key:t._teacherId,attrs:{value:t._teacherId}},[e._v(e._s(t.name||"教师#"+t._teacherId))])}),1)]:[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:1,placeholder:"教师ID"},model:{value:e.form.teacherId,callback:function(t){e.$set(e.form,"teacherId",t)},expression:"form.teacherId"}})]],2)],1),s("a-col",{attrs:{span:6}},[s("a-form-item",{attrs:{label:"时间"}},[s("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{type:"datetime",format:"YYYY-MM-DD HH:mm:ss",valueType:"format"},on:{change:e.onTimeChange},model:{value:e.form.time,callback:function(t){e.$set(e.form,"time",t)},expression:"form.time"}})],1)],1)],1),s("a-form-item",{attrs:{"wrapper-col":{span:16,offset:6}}},[s("a-space",[s("a-button",{attrs:{type:"primary"},on:{click:e.book}},[e._v("预约试听")]),s("a-button",{on:{click:e.loadList}},[e._v("加载列表")]),s("a-button",{attrs:{type:"dashed"},on:{click:e.cleanupInvalid}},[e._v("清理空记录")])],1)],1)],1)],1),s("a-card",{attrs:{bordered:"",title:"试听列表"}},[s("a-table",{attrs:{"data-source":e.list,columns:e.columns,rowKey:"id",pagination:!1},scopedSlots:e._u([{key:"status",fn:function(t){return[t&&t.record&&t.record.status==="booked"?s("a-tag",{attrs:{color:"blue"}},[e._v("已预约")]):t&&t.record&&t.record.status==="finished"?s("a-tag",{attrs:{color:"green"}},[e._v("已完成")]):s("a-tag",[e._v("未知")])]}},{key:"action",fn:function(t){return[t&&t.record?s("a-space",[s("a-input",{staticStyle:{width:"160px"},attrs:{size:"small",placeholder:"评价"},model:{value:t.record._feedback,callback:function(o){e.$set(t.record,"_feedback",o)},expression:"slotProps.record._feedback"}}),s("a-select",{staticStyle:{width:"140px"},attrs:{size:"small"},model:{value:t.record._result,callback:function(o){e.$set(t.record,"_result",o)},expression:"slotProps.record._result"}},[s("a-select-option",{attrs:{value:"适合报班"}},[e._v("适合报班")]),s("a-select-option",{attrs:{value:"需再评估"}},[e._v("需再评估")])],1),s("a-button",{attrs:{size:"small",disabled:t.record.status==="finished"},on:{click:function(o){return e.submitFeedback(t.record)}}},[e._v("提交反馈")]),s("a-button",{attrs:{size:"small",type:"primary"},on:{click:function(o){return e.convert(t.record)}}},[e._v("转为正式学员")])],1):s("span",[e._v("—")])]}}])})],1)],1)},y=[],g=I(b,_,y,!1,null,"6c3f2ac7",null,null);const $=g.exports;export{$ as default};
