import{n as d}from"./index-67337038.js";const c={name:"ClassroomManage",data(){return{loading:!1,list:[],campusOptions:[],filters:{campusId:null,q:""},pagination:{current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},modal:{visible:!1,mode:"add",form:{id:null,campusId:null,name:"",roomCode:"",capacity:0,usableSeats:0,seatRows:null,seatCols:null,seatMap:"",status:"enabled",note:""}},seatGrid:[],preview:{visible:!1,title:"",grid:[]},columns:[{title:"校区",dataIndex:"campusName",key:"campusName"},{title:"教室名称",dataIndex:"name",key:"name"},{title:"教室编号",dataIndex:"roomCode",key:"roomCode"},{title:"容纳人数",dataIndex:"capacity",key:"capacity"},{title:"可用座位",dataIndex:"usableSeats",key:"usableSeats"},{title:"行×列",key:"seatDims",scopedSlots:{customRender:"seatDims"}},{title:"座位图",key:"layout",scopedSlots:{customRender:"layout"}},{title:"状态",dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"操作",key:"action",scopedSlots:{customRender:"action"}}]}},computed:{modalTitle(){return this.modal.mode==="edit"?"编辑教室":"新增教室"}},created(){this.loadCampusOptions().then(()=>this.loadData())},methods:{async loadCampusOptions(){try{const t=await(await fetch("/api/base/campus/list")).json();this.campusOptions=t&&t.code===200?t.data||[]:[],!this.filters.campusId&&this.campusOptions.length&&(this.filters.campusId=this.campusOptions[0].id)}catch{this.campusOptions=[]}},campusNameById(a){const t=(this.campusOptions||[]).find(s=>String(s.id)===String(a));return t?t.name:""},async loadData(){this.loading=!0;try{const a=new URLSearchParams;this.filters.campusId&&a.append("campusId",this.filters.campusId),this.filters.q&&a.append("q",this.filters.q),a.append("page",String(this.pagination.current||1)),a.append("size",String(this.pagination.pageSize||10));const s=await(await fetch("/api/base/classroom/list"+(a.toString()?"?"+a.toString():""))).json(),e=s&&s.code===200?s.data||{}:{},i=Array.isArray(e)?e:e.items||[];this.list=i.map(o=>({...o,campusName:this.campusNameById(o.campusId)})),this.pagination.total=Number(e.total||i.length)}catch{this.list=[]}finally{this.loading=!1}},onTableChange(a){this.pagination.current=a.current,this.pagination.pageSize=a.pageSize,this.loadData()},openAdd(){this.modal.mode="add",this.modal.form={id:null,campusId:this.filters.campusId,name:"",roomCode:"",capacity:0,usableSeats:0,seatRows:null,seatCols:null,seatMap:"",status:"enabled",note:""},this.seatGrid=[],this.modal.visible=!0},openEdit(a){if(!a||a.id==null){this.$message&&this.$message.warning("无效数据");return}this.modal.mode="edit",this.modal.form={id:a.id,campusId:a.campusId,name:a.name,roomCode:a.roomCode,capacity:Number(a.capacity||0),usableSeats:Number(a.usableSeats||0),seatRows:a.seatRows||null,seatCols:a.seatCols||null,seatMap:a.seatMap||"",status:a.status||"enabled",note:a.note||""},this.initSeatGridFromForm(),this.modal.visible=!0},closeModal(){this.modal.visible=!1},onCampusChange(){},onCapacityChange(){const a=this.modal.form,t=Number(a.capacity||0),s=Number(a.seatRows||0),e=Number(a.seatCols||0);if(t>0&&(s<=0||e<=0)){const i=Math.max(1,Math.floor(Math.sqrt(t))),o=Math.max(1,Math.ceil(t/i));a.seatRows=i,a.seatCols=o,this.onSeatDimChange()}},onSeatDimChange(){const a=this.modal.form,t=Number(a.seatRows||0),s=Number(a.seatCols||0);t>0&&s>0&&(a.capacity=t*s,this.seatGrid=Array.from({length:t},()=>Array.from({length:s},()=>!0)),a.usableSeats=t*s)},resetSeatGrid(){this.onSeatDimChange()},toggleSeat(a,t){!this.seatGrid||!this.seatGrid[a]||(this.$set(this.seatGrid[a],t,!this.seatGrid[a][t]),this.syncUsableSeats())},rowLabel(a){return a<26?String.fromCharCode(65+a):a+1},enableAllSeats(){!this.seatGrid||!this.seatGrid.length||(this.seatGrid=this.seatGrid.map(a=>a.map(()=>!0)),this.syncUsableSeats())},disableAllSeats(){!this.seatGrid||!this.seatGrid.length||(this.seatGrid=this.seatGrid.map(a=>a.map(()=>!1)),this.syncUsableSeats())},syncUsableSeats(){const a=this.modal.form;let t=0;for(const s of this.seatGrid||[])for(const e of s||[])e&&t++;a.usableSeats=t},initSeatGridFromForm(){const a=this.modal.form,t=Number(a.seatRows||0),s=Number(a.seatCols||0);if(t>0&&s>0){if(a.seatMap)try{const e=JSON.parse(a.seatMap);if(Array.isArray(e)&&e.length===t){this.seatGrid=e.map(i=>i.map(o=>!!o)),this.syncUsableSeats();return}}catch{}this.seatGrid=Array.from({length:t},()=>Array.from({length:s},()=>!0)),a.capacity=t*s,this.syncUsableSeats()}else this.seatGrid=[]},async saveModal(){const a=this.modal.form;if(this.seatGrid&&this.seatGrid.length&&this.syncUsableSeats(),!a.campusId){this.$message&&this.$message.warning("请选择校区");return}if(!a.name){this.$message&&this.$message.warning("请输入教室名称");return}const t=Number(a.capacity||0),s=Number(a.usableSeats||0);if(t<0||s<0){this.$message&&this.$message.warning("容量与座位不能为负数");return}if(s>t){this.$message&&this.$message.warning("可用座位数不能超过容纳人数");return}if(a.seatRows&&a.seatCols){const e=Number(a.seatRows),i=Number(a.seatCols);if(e*i!==t){this.$message&&this.$message.warning("容量应等于座位行列乘积");return}if(!this.seatGrid||this.seatGrid.length!==e){this.$message&&this.$message.warning("请先生成座位布局");return}try{a.seatMap=JSON.stringify(this.seatGrid.map(o=>o.map(l=>l?1:0)))}catch{a.seatMap=""}}else a.seatMap="";try{if(this.modal.mode==="add"){const i=await(await fetch("/api/base/classroom/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();if(i&&i.code===200)this.$message&&this.$message.success("新增成功"),this.modal.visible=!1,this.loadData();else throw new Error(i&&i.msg||"新增失败")}else{const i=await(await fetch(`/api/base/classroom/update/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();if(i&&i.code===200)this.$message&&this.$message.success("更新成功"),this.modal.visible=!1,this.loadData();else throw new Error(i&&i.msg||"更新失败")}}catch(e){this.$message&&this.$message.error(e.message||"操作失败")}},async openPreview(a){if(!a)return;const t=Number(a.seatRows||0),s=Number(a.seatCols||0);let e=[];if(a.id!=null&&t>0&&s>0)try{const o=await(await fetch(`/api/base/classroom/seats/${a.id}`)).json(),l=Array.isArray(o&&o.data)?o.data:[];if(l.length){e=Array.from({length:t},()=>Array.from({length:s},()=>!0));for(const n of l){const r=Number(n.rowIndex),m=Number(n.colIndex);r>=0&&r<t&&m>=0&&m<s&&(e[r][m]=!!n.usable)}}}catch{}if(!e.length&&t>0&&s>0){if(a.seatMap)try{const i=JSON.parse(a.seatMap);Array.isArray(i)&&i.length===t&&(e=i.map(o=>o.map(l=>!!l)))}catch{}e.length||(e=Array.from({length:t},()=>Array.from({length:s},()=>!0)))}this.preview={visible:!0,title:`${a.name||a.roomCode||"座位布局预览"}`,grid:e}},closePreview(){this.preview.visible=!1},async deleteItem(a){if(!a||a.id==null){this.$message&&this.$message.warning("无效数据");return}try{const s=await(await fetch(`/api/base/classroom/delete/${a.id}`,{method:"DELETE"})).json();if(s&&s.code===200)this.$message&&this.$message.success("删除成功"),this.loadData();else throw new Error(s&&s.msg||"删除失败")}catch(t){this.$message&&this.$message.error(t.message||"删除失败")}},async toggleStatus(a){if(!a||a.id==null){this.$message&&this.$message.warning("无效数据");return}try{const t=a.status==="enabled"?"disabled":"enabled",e=await(await fetch(`/api/base/classroom/update/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({...a,status:t})})).json();if(e&&e.code===200)this.$message&&this.$message.success("状态已更新"),this.loadData();else throw new Error(e&&e.msg||"更新失败")}catch(t){this.$message&&this.$message.error(t.message||"更新失败")}}}};var u=function(){var t=this,s=t._self._c;return s("div",{staticClass:"classroom-page"},[s("a-page-header",{attrs:{title:"教室管理","sub-title":"维护教室信息与容量"}}),s("a-card",[s("div",{staticStyle:{"margin-bottom":"8px",display:"flex",gap:"8px","align-items":"center"}},[s("a-select",{staticStyle:{width:"220px"},attrs:{placeholder:"选择校区"},on:{change:t.loadData},model:{value:t.filters.campusId,callback:function(e){t.$set(t.filters,"campusId",e)},expression:"filters.campusId"}},t._l(t.campusOptions,function(e){return s("a-select-option",{key:e.id,attrs:{value:e.id}},[t._v(t._s(e.name))])}),1),s("a-input",{staticStyle:{width:"240px"},attrs:{placeholder:"按名称/编号搜索"},on:{pressEnter:t.loadData},model:{value:t.filters.q,callback:function(e){t.$set(t.filters,"q",e)},expression:"filters.q"}}),s("a-button",{attrs:{type:"primary",icon:"plus"},on:{click:t.openAdd}},[t._v("新增教室")]),s("a-button",{on:{click:t.loadData}},[t._v("查询")])],1),s("a-table",{attrs:{"data-source":t.list,loading:t.loading,pagination:t.pagination,rowKey:e=>e.id||e.roomCode,columns:t.columns},on:{change:t.onTableChange},scopedSlots:t._u([{key:"status",fn:function(e){return[s("a-tag",{attrs:{color:e==="enabled"?"green":"default"}},[t._v(t._s(e==="enabled"?"启用":"停用"))])]}},{key:"seatDims",fn:function(e,i){return[s("span",[t._v(t._s(i.seatRows||"-")+"×"+t._s(i.seatCols||"-"))])]}},{key:"layout",fn:function(e,i){return[s("a-tag",{attrs:{color:i.seatMap?"blue":"default"}},[t._v(t._s(i.seatMap?"有":"无"))]),s("a-button",{staticStyle:{"margin-left":"8px"},attrs:{size:"small"},on:{click:function(o){return t.openPreview(i)}}},[t._v("预览")])]}},{key:"action",fn:function(e,i){return[s("a-button",{attrs:{size:"small"},on:{click:function(o){return t.openEdit(i)}}},[t._v("编辑")]),s("a-divider",{attrs:{type:"vertical"}}),s("a-button",{attrs:{size:"small"},on:{click:function(o){return t.toggleStatus(i)}}},[t._v(t._s(i.status==="enabled"?"停用":"启用"))]),s("a-divider",{attrs:{type:"vertical"}}),s("a-popconfirm",{attrs:{title:"确认删除该教室？"},on:{confirm:function(o){return t.deleteItem(i)}}},[s("a-button",{attrs:{size:"small",type:"danger"}},[t._v("删除")])],1)]}}])})],1),s("a-modal",{attrs:{visible:t.modal.visible,title:t.modalTitle,width:720},on:{ok:t.saveModal,cancel:t.closeModal}},[s("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[s("a-form-item",{attrs:{label:"校区"}},[s("a-select",{attrs:{placeholder:"选择校区"},on:{change:t.onCampusChange},model:{value:t.modal.form.campusId,callback:function(e){t.$set(t.modal.form,"campusId",e)},expression:"modal.form.campusId"}},t._l(t.campusOptions,function(e){return s("a-select-option",{key:e.id,attrs:{value:e.id}},[t._v(t._s(e.name))])}),1)],1),s("a-form-item",{attrs:{label:"教室名称"}},[s("a-input",{attrs:{placeholder:"如 教学楼302"},model:{value:t.modal.form.name,callback:function(e){t.$set(t.modal.form,"name",e)},expression:"modal.form.name"}})],1),s("a-form-item",{attrs:{label:"教室编号"}},[s("a-input",{attrs:{placeholder:"如 A-302 或 ZB-01"},model:{value:t.modal.form.roomCode,callback:function(e){t.$set(t.modal.form,"roomCode",e)},expression:"modal.form.roomCode"}})],1),s("a-form-item",{attrs:{label:"容纳人数"}},[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0,max:999},on:{change:t.onCapacityChange},model:{value:t.modal.form.capacity,callback:function(e){t.$set(t.modal.form,"capacity",e)},expression:"modal.form.capacity"}})],1),s("a-form-item",{attrs:{label:"可用座位数"}},[s("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0,max:999,disabled:t.seatGrid&&t.seatGrid.length},model:{value:t.modal.form.usableSeats,callback:function(e){t.$set(t.modal.form,"usableSeats",e)},expression:"modal.form.usableSeats"}}),s("div",{staticClass:"help"},[t._v("应小于或等于容纳人数")])],1),s("a-form-item",{attrs:{label:"座位行列"}},[s("a-space",[s("a-input-number",{attrs:{min:1,max:50,placeholder:"行数"},on:{change:t.onSeatDimChange},model:{value:t.modal.form.seatRows,callback:function(e){t.$set(t.modal.form,"seatRows",e)},expression:"modal.form.seatRows"}}),s("span",[t._v("×")]),s("a-input-number",{attrs:{min:1,max:50,placeholder:"列数"},on:{change:t.onSeatDimChange},model:{value:t.modal.form.seatCols,callback:function(e){t.$set(t.modal.form,"seatCols",e)},expression:"modal.form.seatCols"}}),s("a-button",{attrs:{size:"small"},on:{click:t.resetSeatGrid}},[t._v("重置布局")])],1),s("div",{staticClass:"help"},[t._v("根据行列自动生成座位网格，点击方格可禁用/启用。")])],1),s("a-form-item",{attrs:{label:"座位布局"}},[s("div",{staticStyle:{"margin-bottom":"8px"}},[s("a-space",[s("a-button",{attrs:{size:"small",disabled:!t.seatGrid||!t.seatGrid.length},on:{click:t.enableAllSeats}},[t._v("全部启用")]),s("a-button",{attrs:{size:"small",disabled:!t.seatGrid||!t.seatGrid.length},on:{click:t.disableAllSeats}},[t._v("全部禁用")])],1)],1),t.seatGrid&&t.seatGrid.length?s("div",{staticClass:"seat-grid"},t._l(t.seatGrid,function(e,i){return s("div",{key:"r"+i,staticClass:"seat-row"},t._l(e,function(o,l){return s("div",{key:"c"+l,staticClass:"seat-cell",class:o?"seat-ok":"seat-off",on:{click:function(n){return t.toggleSeat(i,l)}}},[t._v(" "+t._s(t.rowLabel(i))+t._s(l+1)+" ")])}),0)}),0):s("div",{staticClass:"help"},[t._v("请输入行列生成座位布局")])]),s("a-form-item",{attrs:{label:"状态"}},[s("a-select",{model:{value:t.modal.form.status,callback:function(e){t.$set(t.modal.form,"status",e)},expression:"modal.form.status"}},[s("a-select-option",{attrs:{value:"enabled"}},[t._v("启用")]),s("a-select-option",{attrs:{value:"disabled"}},[t._v("停用")])],1)],1),s("a-form-item",{attrs:{label:"备注"}},[s("a-textarea",{attrs:{rows:3,placeholder:"特殊说明"},model:{value:t.modal.form.note,callback:function(e){t.$set(t.modal.form,"note",e)},expression:"modal.form.note"}})],1)],1)],1),s("a-modal",{attrs:{visible:t.preview.visible,title:t.preview.title,width:640},on:{ok:t.closePreview,cancel:t.closePreview}},[t.preview.grid&&t.preview.grid.length?s("div",{staticClass:"seat-grid"},t._l(t.preview.grid,function(e,i){return s("div",{key:"pr"+i,staticClass:"seat-row"},t._l(e,function(o,l){return s("div",{key:"pc"+l,staticClass:"seat-cell",class:o?"seat-ok":"seat-off"},[t._v(" "+t._s(t.rowLabel(i))+t._s(l+1)+" ")])}),0)}),0):s("div",{staticClass:"help"},[t._v("暂无座位布局数据")])])],1)},p=[],h=d(c,u,p,!1,null,null,null,null);const g=h.exports;export{g as default};
