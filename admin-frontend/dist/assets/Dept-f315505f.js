import{n as l}from"./index-67337038.js";const d={name:"DeptPage",data(){return{campuses:[],deptTree:[],flatDepts:[],selectedDept:null,loadingDept:!1,filters:{campusId:""},modal:{visible:!1,mode:"add",form:{id:"",title:"",parentId:0,campusId:"",sortOrder:0,status:"enabled"}}}},computed:{cardTitle(){const s=this.campuses.find(e=>String(e.id)===String(this.filters.campusId));return s?`部门结构 - ${s.name}`:"部门结构"},modalTitle(){return this.modal.mode==="edit"?"编辑部门":"新增部门"}},created(){if(this.$route&&this.$route.query&&this.$route.query.campusId){const s=this.$route.query.campusId;this.filters.campusId=isNaN(Number(s))?s:Number(s),this.loadDepts(),this.loadCampuses()}else this.loadCampuses()},methods:{async loadCampuses(){try{const e=await(await fetch("/api/base/campus/list")).json();e&&e.code===200&&(this.campuses=e.data||[],!this.filters.campusId&&this.campuses.length&&(this.filters.campusId=this.campuses[0].id,this.loadDepts()))}catch{this.campuses=[]}},async loadDepts(){this.loadingDept=!0;try{const e=await(await fetch(`/api/base/dept/tree?campusId=${this.filters.campusId||""}`)).json();if(e&&e.code===200){const t=e.data||[];this.deptTree=t.map(this.mapToTreeNode),this.flatDepts=this.flattenTree(t),this.selectedDept=null}else this.deptTree=[],this.flatDepts=[]}catch{this.deptTree=[],this.flatDepts=[]}finally{this.loadingDept=!1}},mapToTreeNode(s){const e={key:s.id,title:s.title,id:s.id};return s.children&&s.children.length&&(e.children=s.children.map(this.mapToTreeNode)),e},flattenTree(s,e=[]){return s.forEach(t=>{e.push({id:t.id,title:t.title}),t.children&&t.children.length&&this.flattenTree(t.children,e)}),e},onCampusChange(){this.loadDepts()},onDeptSelect(s){if(s&&s.length){const e=s[0],t=this.flatDepts.find(a=>String(a.id)===String(e));this.selectedDept=t||null}else this.selectedDept=null},openAddRoot(){this.modal.visible=!0,this.modal.mode="add",this.modal.form={id:"",title:"",parentId:0,campusId:this.filters.campusId,sortOrder:0,status:"enabled"}},openAddChild(){this.selectedDept&&(this.modal.visible=!0,this.modal.mode="add",this.modal.form={id:"",title:"",parentId:this.selectedDept.id,campusId:this.filters.campusId,sortOrder:0,status:"enabled"})},openEdit(){this.selectedDept&&(this.modal.visible=!0,this.modal.mode="edit",this.modal.form={id:this.selectedDept.id,title:this.selectedDept.title,parentId:0,campusId:this.filters.campusId,sortOrder:0,status:"enabled"})},closeModal(){this.modal.visible=!1},async saveDept(){const s={...this.modal.form};s.parentId=s.parentId===0?null:s.parentId;try{const e=s.id?`/api/base/dept/update/${s.id}`:"/api/base/dept/save",t=s.id?"PUT":"POST",i=await(await fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(i&&i.code===200)this.closeModal(),this.loadDepts(),this.$message&&this.$message.success("部门信息已保存");else throw new Error("保存失败")}catch{this.closeModal(),this.loadDepts(),this.$message&&this.$message.error("保存失败，已尝试刷新数据")}},async disableSelected(){if(this.selectedDept)try{const e=await(await fetch(`/api/base/dept/disable/${this.selectedDept.id}`,{method:"POST"})).json();if(e&&e.code===200)this.$message&&this.$message.success("已禁用"),this.loadDepts();else throw new Error("禁用失败")}catch{this.$message&&this.$message.error("禁用失败")}}}};var r=function(){var e=this,t=e._self._c;return t("div",{staticClass:"dept-page"},[t("a-page-header",{attrs:{title:"组织信息维护","sub-title":"按校区维护部门结构"}}),t("a-row",{attrs:{gutter:16}},[t("a-col",{attrs:{span:6}},[t("a-card",{attrs:{title:"校区选择",bordered:""}},[t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择校区"},on:{change:e.onCampusChange},model:{value:e.filters.campusId,callback:function(a){e.$set(e.filters,"campusId",a)},expression:"filters.campusId"}},e._l(e.campuses,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.name))])}),1)],1),t("a-card",{staticStyle:{"margin-top":"12px"},attrs:{title:"部门结构",bordered:""}},[t("a-tree",{attrs:{treeData:e.deptTree,defaultExpandAll:!0},on:{select:e.onDeptSelect}})],1)],1),t("a-col",{attrs:{span:18}},[t("a-card",{attrs:{title:e.cardTitle,bordered:""}},[t("a-space",{staticStyle:{"margin-bottom":"12px"}},[t("a-button",{attrs:{type:"primary"},on:{click:e.openAddRoot}},[e._v("新增根部门")]),t("a-button",{attrs:{disabled:!e.selectedDept},on:{click:e.openAddChild}},[e._v("在选中部门下新增")]),t("a-button",{attrs:{disabled:!e.selectedDept},on:{click:e.openEdit}},[e._v("编辑选中部门")]),t("a-button",{attrs:{type:"danger",disabled:!e.selectedDept},on:{click:e.disableSelected}},[e._v("禁用选中部门")]),t("a-button",{attrs:{loading:e.loadingDept},on:{click:e.loadDepts}},[e._v("刷新")])],1),e.selectedDept?t("div",[t("p",[t("b",[e._v("当前选中：")]),e._v(e._s(e.selectedDept.title)+"（ID: "+e._s(e.selectedDept.id)+"）")])]):t("div",[t("p",[e._v("请选择左侧树中的部门进行维护。")])])],1)],1)],1),t("a-modal",{attrs:{visible:e.modal.visible,title:e.modalTitle},on:{ok:e.saveDept,cancel:e.closeModal}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[t("a-form-item",{attrs:{label:"部门名称"}},[t("a-input",{attrs:{placeholder:"请输入部门名称"},model:{value:e.modal.form.title,callback:function(a){e.$set(e.modal.form,"title",a)},expression:"modal.form.title"}})],1),t("a-form-item",{attrs:{label:"父部门"}},[t("a-select",{attrs:{placeholder:"选择父部门，为空则为根"},model:{value:e.modal.form.parentId,callback:function(a){e.$set(e.modal.form,"parentId",a)},expression:"modal.form.parentId"}},[t("a-select-option",{attrs:{value:0}},[e._v("(无)")]),e._l(e.flatDepts,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.title))])})],2)],1),t("a-form-item",{attrs:{label:"排序"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.modal.form.sortOrder,callback:function(a){e.$set(e.modal.form,"sortOrder",a)},expression:"modal.form.sortOrder"}})],1),t("a-form-item",{attrs:{label:"状态"}},[t("a-select",{model:{value:e.modal.form.status,callback:function(a){e.$set(e.modal.form,"status",a)},expression:"modal.form.status"}},[t("a-select-option",{attrs:{value:"enabled"}},[e._v("启用")]),t("a-select-option",{attrs:{value:"disabled"}},[e._v("禁用")])],1)],1)],1)],1)],1)},o=[],n=l(d,r,o,!1,null,null,null,null);const p=n.exports;export{p as default};
