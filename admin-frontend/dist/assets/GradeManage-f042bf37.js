import y from"./V2SimpleDate-11821f76.js";import{n as x}from"./index-67337038.js";const v={name:"GradeManage",components:{V2SimpleDate:y},data(){return{query:{studentId:null,subject:"",term:""},list:[],pagination:{current:1,pageSize:10,total:0},studentOptions:[],columns:[{title:"ID",dataIndex:"id"},{title:"学员ID",dataIndex:"studentId"},{title:"科目",dataIndex:"subject"},{title:"学期",dataIndex:"term"},{title:"分数",dataIndex:"score"},{title:"考试日期",dataIndex:"examDate"},{title:"状态",dataIndex:"status"},{title:"备注",dataIndex:"remark"},{title:"操作",key:"ops",scopedSlots:{customRender:"ops"}}],editVisible:!1,editMode:"add",saving:!1,form:{id:null,studentId:null,subject:"",term:"",score:null,examDate:null,status:"unknown",remark:""}}},created(){this.loadStudents(),this.loadList()},methods:{async loadStudents(){try{const t=await(await fetch("/api/student/list")).json();this.studentOptions=Array.isArray(t.data)?t.data.map(e=>({id:e.id,name:e.name})):[]}catch{this.studentOptions=[]}},async loadList(){const s=[];this.query.studentId&&s.push("studentId="+encodeURIComponent(this.query.studentId)),this.query.subject&&s.push("subject="+encodeURIComponent(this.query.subject)),this.query.term&&s.push("term="+encodeURIComponent(this.query.term)),s.push("page="+encodeURIComponent(this.pagination.current)),s.push("size="+encodeURIComponent(this.pagination.pageSize));const t=s.length?"?"+s.join("&"):"";try{const a=await(await fetch("/api/student/grade/list"+t)).json(),o=a&&a.data?a.data:{},n=Array.isArray(o.items)?o.items:Array.isArray(a.data)?a.data:[],r=Number(o.total||0),c=l=>{if(!l)return"";try{if(typeof l=="number"){const u=new Date(l),h=u.getFullYear(),g=(u.getMonth()+1+"").padStart(2,"0"),b=(u.getDate()+"").padStart(2,"0");return`${h}-${g}-${b}`}const d=String(l);if(/^\d{4}-\d{2}-\d{2}/.test(d))return d.slice(0,10);const i=new Date(d),m=i.getFullYear(),p=(i.getMonth()+1+"").padStart(2,"0"),f=(i.getDate()+"").padStart(2,"0");return`${m}-${p}-${f}`}catch{return""}};this.list=n.map(l=>({...l,examDate:c(l.examDate)})),this.pagination={...this.pagination,total:r}}catch{this.list=[]}},onTableChange(s){this.pagination={...this.pagination,current:s.current,pageSize:s.pageSize},this.loadList()},openAdd(){this.editMode="add",this.form={id:null,studentId:null,subject:"",term:"",score:null,examDate:null,status:"unknown",remark:""},this.editVisible=!0},openEdit(s){if(!s)return;this.editMode="edit";const t={...s};if(t.examDate)try{const e=new Date(t.examDate);if(isNaN(e.getTime())){const a=String(t.examDate);t.examDate=/^\d{4}-\d{2}-\d{2}/.test(a)?a.slice(0,10):""}else{const a=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");t.examDate=`${a}-${o}-${n}`}}catch{t.examDate=""}this.form=t,this.editVisible=!0},async doSave(){if(!this.form.studentId||!this.form.subject){this.$message&&this.$message.warning("请填写学员与科目");return}this.saving=!0;try{const s={...this.form};if(s.examDate instanceof Date){const n=s.examDate.getFullYear(),r=String(s.examDate.getMonth()+1).padStart(2,"0"),c=String(s.examDate.getDate()).padStart(2,"0");s.examDate=`${n}-${r}-${c}`}else if(typeof s.examDate=="string"){const n=s.examDate;if(/^\d{4}-\d{2}-\d{2}$/.test(n))s.examDate=n;else{const r=new Date(n);if(isNaN(r.getTime()))s.examDate="";else{const c=r.getFullYear(),l=String(r.getMonth()+1).padStart(2,"0"),d=String(r.getDate()).padStart(2,"0");s.examDate=`${c}-${l}-${d}`}}}const t=this.editMode==="add"?"/api/student/grade/save":"/api/student/grade/update/"+this.form.id,e=this.editMode==="add"?"POST":"PUT",o=await(await fetch(t,{method:e,headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(o&&o.code===200)this.$message&&this.$message.success("已保存"),this.editVisible=!1,this.loadList();else throw new Error(o.message||"保存失败")}catch(s){this.$message&&this.$message.error(s.message||"保存失败")}this.saving=!1},async doDelete(s){if(!(!s||!s.id))try{const e=await(await fetch("/api/student/grade/delete/"+s.id,{method:"DELETE"})).json();if(e&&e.code===200)this.$message&&this.$message.success("已删除"),this.loadList();else throw new Error(e.message||"删除失败")}catch{this.$message&&this.$message.error("删除失败")}},beforeImport(s){const t=new FileReader;return t.onload=async()=>{try{const e=t.result,a=String(e).trim().split(/\r?\n/),o=a[0].split(","),n=d=>o.findIndex(i=>i.trim()===d),r=[];for(let d=1;d<a.length;d++){const i=a[d].split(",");r.push({studentId:Number(i[n("studentId")]),subject:i[n("subject")],term:i[n("term")],score:i[n("score")]?Number(i[n("score")]):null,examDate:i[n("examDate")]||"",status:i[n("status")]||"unknown",remark:i[n("remark")]||""})}const l=await(await fetch("/api/student/grade/import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json();if(l&&l.code===200)this.$message&&this.$message.success("导入完成"),this.loadList();else throw new Error(l.message||"导入失败")}catch{this.$message&&this.$message.error("导入失败")}},t.readAsText(s),!1},async doExport(){const s=[];this.query.studentId&&s.push("studentId="+encodeURIComponent(this.query.studentId)),this.query.subject&&s.push("subject="+encodeURIComponent(this.query.subject)),this.query.term&&s.push("term="+encodeURIComponent(this.query.term));const t=s.length?"?"+s.join("&"):"";try{const a=await(await fetch("/api/student/grade/export"+t)).text(),o=new Blob([a],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(o),r=document.createElement("a");r.href=n,r.download="grades.csv",r.click(),URL.revokeObjectURL(n)}catch{this.$message&&this.$message.error("导出失败")}}}};var D=function(){var t=this,e=t._self._c;return e("div",{staticClass:"grade-manage"},[e("a-page-header",{attrs:{title:"学生成绩管理","sub-title":"新增、导入、导出与查询"}}),e("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:""}},[e("a-form",{staticClass:"filter-inline",attrs:{layout:"inline"}},[e("a-form-item",{attrs:{label:"学员"}},[e("a-select",{staticStyle:{width:"220px"},attrs:{"show-search":"",allowClear:"",placeholder:"选择学员"},on:{change:t.loadList},model:{value:t.query.studentId,callback:function(a){t.$set(t.query,"studentId",a)},expression:"query.studentId"}},t._l(t.studentOptions,function(a){return e("a-select-option",{key:a.id,attrs:{value:a.id}},[t._v(t._s(a.name)+"（#"+t._s(a.id)+"）")])}),1)],1),e("a-form-item",{attrs:{label:"科目"}},[e("a-input",{staticStyle:{width:"160px"},attrs:{placeholder:"如 数学"},on:{pressEnter:t.loadList},model:{value:t.query.subject,callback:function(a){t.$set(t.query,"subject",a)},expression:"query.subject"}})],1),e("a-form-item",{attrs:{label:"学期"}},[e("a-input",{staticStyle:{width:"160px"},attrs:{placeholder:"如 2025春季"},on:{pressEnter:t.loadList},model:{value:t.query.term,callback:function(a){t.$set(t.query,"term",a)},expression:"query.term"}})],1),e("a-form-item",[e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.loadList}},[t._v("查询")]),e("a-button",{on:{click:t.openAdd}},[t._v("新增")]),e("a-upload",{attrs:{"before-upload":t.beforeImport,"show-upload-list":!1}},[e("a-button",[t._v("导入CSV")])],1),e("a-button",{on:{click:t.doExport}},[t._v("导出CSV")])],1)],1)],1)],1),e("a-card",{attrs:{bordered:""}},[e("a-table",{attrs:{"data-source":t.list,columns:t.columns,rowKey:"id",pagination:t.pagination},on:{change:t.onTableChange},scopedSlots:t._u([{key:"ops",fn:function(a,o){return[e("a-space",[e("a-button",{attrs:{size:"small"},on:{click:function(n){return t.openEdit(o)}}},[t._v("编辑")]),e("a-popconfirm",{attrs:{title:"确认删除？"},on:{confirm:function(n){return t.doDelete(o)}}},[e("a-button",{attrs:{size:"small",danger:""}},[t._v("删除")])],1)],1)]}}])}),t.list.length===0?e("div",{staticClass:"empty"},[t._v("暂无数据")]):t._e()],1),e("a-modal",{attrs:{title:t.editMode==="add"?"新增成绩":"编辑成绩","confirm-loading":t.saving,width:520,destroyOnClose:!0,maskClosable:!1},on:{ok:t.doSave,cancel:()=>{t.editVisible=!1}},model:{value:t.editVisible,callback:function(a){t.editVisible=a},expression:"editVisible"}},[t.editVisible?e("a-form",{attrs:{layout:"horizontal","label-col":{span:6},"wrapper-col":{span:16}}},[e("a-form-item",{attrs:{label:"学员"}},[e("a-select",{attrs:{"show-search":"",placeholder:"选择学员"},model:{value:t.form.studentId,callback:function(a){t.$set(t.form,"studentId",a)},expression:"form.studentId"}},t._l(t.studentOptions,function(a){return e("a-select-option",{key:a.id,attrs:{value:a.id}},[t._v(t._s(a.name)+"（#"+t._s(a.id)+"）")])}),1)],1),e("a-form-item",{attrs:{label:"科目"}},[e("a-input",{model:{value:t.form.subject,callback:function(a){t.$set(t.form,"subject",a)},expression:"form.subject"}})],1),e("a-form-item",{attrs:{label:"学期"}},[e("a-input",{model:{value:t.form.term,callback:function(a){t.$set(t.form,"term",a)},expression:"form.term"}})],1),e("a-form-item",{attrs:{label:"分数"}},[e("a-input-number",{attrs:{min:0,max:100,precision:2},model:{value:t.form.score,callback:function(a){t.$set(t.form,"score",a)},expression:"form.score"}})],1),e("a-form-item",{attrs:{label:"考试日期"}},[e("V2SimpleDate",{attrs:{format:"YYYY-MM-DD",valueType:"format"},model:{value:t.form.examDate,callback:function(a){t.$set(t.form,"examDate",a)},expression:"form.examDate"}})],1),e("a-form-item",{attrs:{label:"状态"}},[e("a-select",{model:{value:t.form.status,callback:function(a){t.$set(t.form,"status",a)},expression:"form.status"}},[e("a-select-option",{attrs:{value:"passed"}},[t._v("及格")]),e("a-select-option",{attrs:{value:"failed"}},[t._v("不及格")]),e("a-select-option",{attrs:{value:"unknown"}},[t._v("未知")])],1)],1),e("a-form-item",{attrs:{label:"备注"}},[e("a-input",{model:{value:t.form.remark,callback:function(a){t.$set(t.form,"remark",a)},expression:"form.remark"}})],1)],1):t._e()],1)],1)},_=[],$=x(v,D,_,!1,null,"3af8768f",null,null);const I=$.exports;export{I as default};
