import{n as f,_ as b}from"./index-67337038.js";const v={name:"StudentProfile",components:{V2SimpleDate:()=>b(()=>import("./V2SimpleDate-11821f76.js"),["assets/V2SimpleDate-11821f76.js","assets/index-67337038.js","assets/index-f5f188af.css","assets/V2SimpleDate-9b3aafb8.css"])},data(){return{form:{id:null,name:"",gender:"male",birthDate:"",idType:"",idNumber:"",photoUrl:"",campusId:null},guardians:[],originChannels:[],interests:[],studyTags:[],list:[],pagination:{current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50"],showTotal:a=>`共 ${a} 条`},filters:{name:"",phone:"",channel:"",campusId:null},columns:[{title:"ID",dataIndex:"id",key:"id"},{title:"姓名",dataIndex:"name",key:"name"},{title:"性别",dataIndex:"gender",key:"gender"},{title:"出生日期",dataIndex:"birthDate",key:"birthDate"},{title:"校区",key:"campus",scopedSlots:{customRender:"campus"}},{title:"渠道",key:"channels",scopedSlots:{customRender:"channels"}},{title:"操作",key:"action",scopedSlots:{customRender:"action"}}],historyVisible:!1,currentStudentId:null,historyForm:{type:"",detail:"",time:""},historyList:[],campusList:[],campusMap:{},channelOptions:[{value:"地推",label:"地推"},{value:"转介绍",label:"转介绍"},{value:"线上",label:"线上"}],studentModal:{visible:!1,mode:"add"},importModal:{visible:!1},importText:""}},methods:{onBirthDateChange(a){this.form.birthDate=a||""},onHistoryTimeChange(a){this.historyForm.time=a||""},addGuardian(){this.guardians.push({name:"",relation:"",phone:"",emergency:!1})},removeGuardian(a){this.guardians.splice(a,1)},async loadCampusList(){try{const t=await(await fetch("/api/base/campus/list")).json();this.campusList=t.data||[];const e={};this.campusList.forEach(s=>{e[s.id]=s.title||s.name||"#"+s.id}),this.campusMap=e}catch{this.$message&&this.$message.error("加载校区失败")}},openAddStudent(){this.resetForm(),this.studentModal.visible=!0,this.studentModal.mode="add"},closeStudentModal(){this.studentModal.visible=!1},async submitStudent(){const a={...this.form,guardians:this.guardians,originChannels:this.originChannels,interests:this.interests,studyTags:this.studyTags},t=this.studentModal&&this.studentModal.mode==="edit",e=t?"/api/student/update":"/api/student/save";try{const r=await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();r.code===200?(this.$message&&this.$message.success(t?"更新成功":"新增成功"),this.closeStudentModal(),await this.loadList(),this.resetForm()):this.$message&&this.$message.error((t?"更新失败：":"新增失败：")+(r.msg||"未知错误"))}catch(s){this.$message&&this.$message.error((t?"更新异常：":"新增异常：")+(s&&s.message?s.message:"网络异常"))}},resetForm(){this.form={id:null,name:"",gender:"male",birthDate:"",idType:"",idNumber:"",photoUrl:"",campusId:null},this.guardians=[],this.originChannels=[],this.interests=[],this.studyTags=[]},searchStudents(){this.pagination.current=1,this.loadList()},resetFilters(){this.filters={name:"",phone:"",channel:"",campusId:null},this.pagination.current=1,this.loadList()},async loadList(){const{current:a,pageSize:t}=this.pagination,r=(await(await fetch(`/api/student/list?page=${a}&size=${t}`)).json()).data;if(Array.isArray(r)){const o=r.map(i=>{const l=i.id!=null?i.id:i.studentId,m=i.campusId!=null?i.campusId:i.campus!=null?i.campus:null,u=i.campusName||i.campusTitle||(m!=null&&this.campusMap?this.campusMap[m]:void 0),p=Array.isArray(i.originChannels)?i.originChannels:Array.isArray(i.channels)?i.channels:[];return{...i,id:l,campusId:m,campusName:u,originChannels:p}}),n=this.filters||{},h=(n.name||"").trim(),c=(n.phone||"").trim(),y=(n.channel||"").trim(),d=n.campusId,g=o.filter(i=>{if(!i||i.id===void 0||i.id===null)return!1;let l=!0;if(h&&(l=l&&String(i.name||"").includes(h)),d!=null&&d!==""&&(l=l&&String(i.campusId||"")===String(d)),y){const m=Array.isArray(i.originChannels)?i.originChannels:[];l=l&&m.some(u=>String(u||"").includes(y))}if(c){const u=(Array.isArray(i.guardians)?i.guardians:[]).some(p=>String(p&&p.phone?p.phone:"").includes(c));l=l&&u}return l});this.list=g,this.pagination.total=o.length}else if(r&&Array.isArray(r.items)){const o=r.items.map(n=>{const h=n.id!=null?n.id:n.studentId,c=n.campusId!=null?n.campusId:n.campus!=null?n.campus:null,y=n.campusName||n.campusTitle||(c!=null&&this.campusMap?this.campusMap[c]:void 0),d=Array.isArray(n.originChannels)?n.originChannels:Array.isArray(n.channels)?n.channels:[];return{...n,id:h,campusId:c,campusName:y,originChannels:d}});this.list=o,this.pagination.total=r.total||o.length}else this.list=[],this.pagination.total=0},onTableChange(a){this.pagination.current=a.current,this.pagination.pageSize=a.pageSize,this.loadList()},async generateDemo(){const t=await(await fetch("/api/student/import/demo",{method:"POST"})).json();t.code===200?(this.$message&&this.$message.success(`已生成 ${t.data.count} 条示例数据`),this.pagination.current=1,await this.loadList()):this.$message&&this.$message.error(`生成失败：${t.msg||"未知错误"}`)},openImportModal(){this.importModal.visible=!0},closeImportModal(){this.importModal.visible=!1},async submitImport(){let a=null;try{const t=JSON.parse(this.importText||"[]");if(!Array.isArray(t)||t.length===0){this.$message&&this.$message.warning("请输入有效的JSON数组");return}a=t.map(e=>({id:e.id||null,name:e.name||"",gender:e.gender||"male",birthDate:e.birthDate||"",idType:e.idType||"",idNumber:e.idNumber||"",photoUrl:e.photoUrl||"",campusId:e.campusId==null?null:e.campusId,guardians:Array.isArray(e.guardians)?e.guardians:[],originChannels:Array.isArray(e.originChannels)?e.originChannels:[],interests:Array.isArray(e.interests)?e.interests:[],studyTags:Array.isArray(e.studyTags)?e.studyTags:[]}))}catch{this.$message&&this.$message.error("JSON解析失败");return}try{const e=await(await fetch("/api/student/import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();e.code===200?(this.$message&&this.$message.success(`导入成功，共 ${e.data.count} 条`),this.importText="",this.closeImportModal(),this.pagination.current=1,await this.loadList()):this.$message&&this.$message.error(`导入失败：${e.msg||"未知错误"}`)}catch{this.$message&&this.$message.error("导入请求异常")}},getRecordById(a){if(!a&&a!==0)return null;const t=Array.isArray(this.list)?this.list:[],e=String(a);return t.find(s=>s&&String(s.id)===e)||null},editAt(a){const t=Array.isArray(this.list)?this.list:[],e=typeof a=="number"&&a>=0?t[a]:null;if(!e){this.$message&&this.$message.warning("未找到该行数据");return}this.edit(e)},editById(a){const t=this.getRecordById(a);if(!t){this.$message&&this.$message.warning("未找到该行数据");return}this.edit(t)},edit(a){if(console.log(a),!a){this.$message&&this.$message.warning("行数据缺失，无法编辑");return}const t=a.id!==void 0&&a.id!==null?a.id:a.studentId,e=t!=null&&this.getRecordById(t)||a;this.form.id=e.id!=null?e.id:t,this.form.name=e.name,this.form.gender=e.gender,this.form.birthDate=e.birthDate,this.form.idType=e.idType,this.form.idNumber=e.idNumber,this.form.photoUrl=e.photoUrl,this.form.campusId=e.campusId||null,this.guardians=Array.isArray(e.guardians)?e.guardians.map(s=>({...s})):[],this.originChannels=Array.isArray(e.originChannels)?e.originChannels.slice():Array.isArray(e.channels)?e.channels.slice():[],this.interests=Array.isArray(e.interests)?e.interests.slice():[],this.studyTags=Array.isArray(e.studyTags)?e.studyTags.slice():[],this.studentModal.visible=!0,this.studentModal.mode="edit"},openHistoryById(a){const t=this.getRecordById(a);if(!t){this.$message&&this.$message.warning("未找到该行数据");return}this.openHistory(t)},openHistoryAt(a){const t=Array.isArray(this.list)?this.list:[],e=typeof a=="number"&&a>=0?t[a]:null;if(!e){this.$message&&this.$message.warning("未找到该行数据");return}this.openHistory(e)},async openHistory(a){if(!a){this.$message&&this.$message.warning("行数据缺失，无法打开历史");return}const t=a.id!==void 0&&a.id!==null?a.id:a.studentId;if(t==null||t===""){this.$message&&this.$message.warning("缺少学员ID");return}this.historyVisible=!0,this.currentStudentId=t,await this.loadHistory()},async loadHistory(){const t=await(await fetch(`/api/student/history/list?studentId=${this.currentStudentId}`)).json();this.historyList=t.data||[]},async addHistory(){const a={...this.historyForm,studentId:this.currentStudentId},e=await(await fetch("/api/student/history/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();e.code===200?(await this.loadHistory(),this.$message&&this.$message.success("已添加历史记录")):this.$message&&this.$message.error("添加失败："+(e.msg||"未知错误"))},async exportStudents(){const t=await(await fetch("/api/student/export")).json();this.$message&&this.$message.success(`导出成功，共 ${t.data.length} 条`)},renderHistoryItem(a){return this.$createElement("a-list-item",[this.$createElement("span",`${a.time} [${a.type}] - ${a.detail}`)])},closeHistory(){this.historyVisible=!1}},async mounted(){await this.loadCampusList(),await this.loadList()}};var $=function(){var t=this,e=t._self._c;return e("div",{staticClass:"student-profile"},[e("a-page-header",{attrs:{title:"学员档案管理","sub-title":"基础信息、监护人、标签与历史记录"}}),e("a-modal",{attrs:{visible:t.studentModal.visible,title:t.studentModal.mode==="edit"?"编辑学员":"新增学员",width:900},on:{ok:t.submitStudent,cancel:t.closeStudentModal}},[e("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:""}},[e("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[e("a-row",{attrs:{gutter:16}},[e("a-col",{attrs:{span:8}},[e("a-form-item",{attrs:{label:"姓名"}},[e("a-input",{attrs:{placeholder:"请输入姓名"},model:{value:t.form.name,callback:function(s){t.$set(t.form,"name",s)},expression:"form.name"}})],1)],1),e("a-col",{attrs:{span:8}},[e("a-form-item",{attrs:{label:"性别"}},[e("a-select",{attrs:{placeholder:"选择性别"},model:{value:t.form.gender,callback:function(s){t.$set(t.form,"gender",s)},expression:"form.gender"}},[e("a-select-option",{attrs:{value:"male"}},[t._v("男")]),e("a-select-option",{attrs:{value:"female"}},[t._v("女")])],1)],1)],1),e("a-col",{attrs:{span:8}},[e("a-form-item",{attrs:{label:"出生日期"}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{type:"date",format:"YYYY-MM-DD",placeholder:"选择出生日期"},model:{value:t.form.birthDate,callback:function(s){t.$set(t.form,"birthDate",s)},expression:"form.birthDate"}})],1)],1)],1),e("a-row",{attrs:{gutter:16}},[e("a-col",{attrs:{span:8}},[e("a-form-item",{attrs:{label:"证件类型"}},[e("a-select",{attrs:{placeholder:"选择证件类型",allowClear:""},model:{value:t.form.idType,callback:function(s){t.$set(t.form,"idType",s)},expression:"form.idType"}},[e("a-select-option",{attrs:{value:"身份证"}},[t._v("身份证")]),e("a-select-option",{attrs:{value:"护照"}},[t._v("护照")])],1)],1)],1),e("a-col",{attrs:{span:8}},[e("a-form-item",{attrs:{label:"证件号码"}},[e("a-input",{attrs:{placeholder:"请输入证件号码"},model:{value:t.form.idNumber,callback:function(s){t.$set(t.form,"idNumber",s)},expression:"form.idNumber"}})],1)],1),e("a-col",{attrs:{span:8}},[e("a-form-item",{attrs:{label:"照片URL"}},[e("a-input",{attrs:{placeholder:"可输入图片链接"},model:{value:t.form.photoUrl,callback:function(s){t.$set(t.form,"photoUrl",s)},expression:"form.photoUrl"}})],1)],1)],1),e("a-row",{attrs:{gutter:16}},[e("a-col",{attrs:{span:8}},[e("a-form-item",{attrs:{label:"校区"}},[e("a-select",{attrs:{placeholder:"选择校区",allowClear:""},model:{value:t.form.campusId,callback:function(s){t.$set(t.form,"campusId",s)},expression:"form.campusId"}},t._l(t.campusList,function(s){return e("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.title||s.name||"#"+s.id))])}),1)],1)],1)],1)],1)],1),e("a-row",{staticStyle:{"margin-bottom":"12px"},attrs:{gutter:16}},[e("a-col",{attrs:{span:12}},[e("a-card",{attrs:{title:"监护人信息",bordered:""}},[e("a-space",{staticStyle:{width:"100%"},attrs:{direction:"vertical"}},[t._l(t.guardians,function(s,r){return e("div",{key:r},[e("a-row",{attrs:{gutter:8,align:"middle"}},[e("a-col",{attrs:{span:6}},[e("a-input",{attrs:{placeholder:"姓名"},model:{value:s.name,callback:function(o){t.$set(s,"name",o)},expression:"g.name"}})],1),e("a-col",{attrs:{span:6}},[e("a-input",{attrs:{placeholder:"关系"},model:{value:s.relation,callback:function(o){t.$set(s,"relation",o)},expression:"g.relation"}})],1),e("a-col",{attrs:{span:6}},[e("a-input",{attrs:{placeholder:"联系电话"},model:{value:s.phone,callback:function(o){t.$set(s,"phone",o)},expression:"g.phone"}})],1),e("a-col",{attrs:{span:4}},[e("a-checkbox",{model:{value:s.emergency,callback:function(o){t.$set(s,"emergency",o)},expression:"g.emergency"}},[t._v("紧急联系人")])],1),e("a-col",{attrs:{span:2}},[e("a-button",{attrs:{size:"small",type:"danger"},on:{click:function(o){return t.removeGuardian(r)}}},[t._v("删除")])],1)],1)],1)}),e("a-button",{attrs:{type:"dashed",icon:"plus"},on:{click:t.addGuardian}},[t._v("添加监护人")])],2)],1)],1),e("a-col",{attrs:{span:12}},[e("a-card",{attrs:{title:"标签管理",bordered:""}},[e("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:18}}},[e("a-form-item",{attrs:{label:"来源渠道"}},[e("a-select",{staticStyle:{width:"100%"},attrs:{mode:"tags","token-separators":[",","，",";","；"," "],options:t.channelOptions,placeholder:"输入或选择：地推/转介绍/线上"},model:{value:t.originChannels,callback:function(s){t.originChannels=s},expression:"originChannels"}})],1),e("a-form-item",{attrs:{label:"兴趣特长"}},[e("a-select",{staticStyle:{width:"100%"},attrs:{mode:"tags","token-separators":[",","，",";","；"," "],placeholder:"如：美术,钢琴,篮球"},model:{value:t.interests,callback:function(s){t.interests=s},expression:"interests"}})],1),e("a-form-item",{attrs:{label:"学情标签"}},[e("a-select",{staticStyle:{width:"100%"},attrs:{mode:"tags","token-separators":[",","，",";","；"," "],placeholder:"如：基础一般,注意力需提升"},model:{value:t.studyTags,callback:function(s){t.studyTags=s},expression:"studyTags"}})],1)],1)],1)],1)],1)],1),e("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:""}},[e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.openAddStudent}},[t._v("新增学员")]),e("a-button",{on:{click:t.exportStudents}},[t._v("导出")]),e("a-button",{on:{click:t.openImportModal}},[t._v("导入")]),e("a-button",{on:{click:t.generateDemo}},[t._v("生成50条数据")])],1)],1),e("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:""}},[e("a-form",{attrs:{layout:"inline"}},[e("a-form-item",{attrs:{label:"姓名"}},[e("a-input",{attrs:{placeholder:"学员姓名",allowClear:""},model:{value:t.filters.name,callback:function(s){t.$set(t.filters,"name",s)},expression:"filters.name"}})],1),e("a-form-item",{attrs:{label:"手机"}},[e("a-input",{attrs:{placeholder:"手机号码",allowClear:""},model:{value:t.filters.phone,callback:function(s){t.$set(t.filters,"phone",s)},expression:"filters.phone"}})],1),e("a-form-item",{attrs:{label:"来源渠道"}},[e("a-select",{staticStyle:{width:"160px"},attrs:{options:t.channelOptions,allowClear:"",placeholder:"选择渠道"},model:{value:t.filters.channel,callback:function(s){t.$set(t.filters,"channel",s)},expression:"filters.channel"}})],1),e("a-form-item",{attrs:{label:"校区"}},[e("a-select",{staticStyle:{width:"160px"},attrs:{allowClear:"",placeholder:"选择校区"},model:{value:t.filters.campusId,callback:function(s){t.$set(t.filters,"campusId",s)},expression:"filters.campusId"}},t._l(t.campusList,function(s){return e("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.title||s.name||"#"+s.id))])}),1)],1),e("a-form-item",[e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.searchStudents}},[t._v("查询")]),e("a-button",{on:{click:t.resetFilters}},[t._v("重置")])],1)],1)],1)],1),e("a-card",{attrs:{title:"学员列表",bordered:""}},[e("a-table",{attrs:{"data-source":t.list,columns:t.columns,rowKey:"id",pagination:t.pagination},on:{change:t.onTableChange},scopedSlots:t._u([{key:"campus",fn:function(s,r,o){return[e("span",[t._v(t._s(r&&r.campusName||"-"))])]}},{key:"channels",fn:function(s,r,o){return[e("span",[t._v(t._s((r&&r.originChannels||[]).join("、")))])]}},{key:"action",fn:function(s,r,o){return[e("a-space",[e("a-button",{attrs:{size:"small"},on:{click:function(n){return t.edit(r)}}},[t._v("编辑")]),e("a-button",{attrs:{size:"small"},on:{click:function(n){return t.openHistory(r)}}},[t._v("历史记录")])],1)]}}])})],1),e("a-modal",{attrs:{visible:t.importModal.visible,title:"导入学员数据",width:720},on:{ok:t.submitImport,cancel:t.closeImportModal}},[e("a-form",{attrs:{"label-col":{span:4},"wrapper-col":{span:20}}},[e("a-form-item",{attrs:{label:"JSON数组"}},[e("a-input",{attrs:{type:"textarea",rows:10,placeholder:'[{"name":"张三","gender":"male","birthDate":"2012-06-01","idType":"身份证","idNumber":"ID000001","photoUrl":"","campusId":1,"guardians":[{"name":"父亲","relation":"父亲","phone":"13800000000","emergency":true}],"originChannels":["地推"],"interests":["篮球"],"studyTags":["积极主动"]}]'},model:{value:t.importText,callback:function(s){t.importText=s},expression:"importText"}})],1)],1)],1),e("a-modal",{attrs:{visible:t.historyVisible,title:"历史记录",width:720},on:{ok:t.closeHistory,cancel:t.closeHistory}},[e("div",{staticStyle:{"margin-bottom":"12px"}},[t._v("当前学员ID："+t._s(t.currentStudentId))]),e("a-form",{attrs:{"label-col":{span:5},"wrapper-col":{span:18}}},[e("a-form-item",{attrs:{label:"类型"}},[e("a-select",{attrs:{placeholder:"报班/缴费/请假/调班",allowClear:""},model:{value:t.historyForm.type,callback:function(s){t.$set(t.historyForm,"type",s)},expression:"historyForm.type"}},[e("a-select-option",{attrs:{value:"报班"}},[t._v("报班")]),e("a-select-option",{attrs:{value:"缴费"}},[t._v("缴费")]),e("a-select-option",{attrs:{value:"请假"}},[t._v("请假")]),e("a-select-option",{attrs:{value:"调班"}},[t._v("调班")])],1)],1),e("a-form-item",{attrs:{label:"详情"}},[e("a-input",{attrs:{placeholder:"请输入详情"},model:{value:t.historyForm.detail,callback:function(s){t.$set(t.historyForm,"detail",s)},expression:"historyForm.detail"}})],1),e("a-form-item",{attrs:{label:"时间"}},[e("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{showTime:!0,format:"YYYY-MM-DD HH:mm:ss"},on:{change:t.onHistoryTimeChange},model:{value:t.historyForm.time,callback:function(s){t.$set(t.historyForm,"time",s)},expression:"historyForm.time"}})],1),e("a-form-item",{attrs:{"wrapper-col":{span:18,offset:5}}},[e("a-space",[e("a-button",{attrs:{type:"primary"},on:{click:t.addHistory}},[t._v("添加历史记录")]),e("a-button",{on:{click:t.loadHistory}},[t._v("刷新历史列表")])],1)],1)],1),e("a-list",{attrs:{"data-source":t.historyList,bordered:"",renderItem:t.renderHistoryItem}})],1)],1)},_=[],w=f(v,$,_,!1,null,"38717c12",null,null);const I=w.exports;export{I as default};
