import{n as l,_ as c}from"./index-67337038.js";const r={name:"InvoiceManage",data(){return{applications:[],records:[],filter:{month:"",campusId:null},campusOptions:[],issueVisible:!1,issue:{applicationId:"",settlementId:"",studentId:"",campusId:null,invoiceNo:"",invoiceDate:"",deliveryStatus:"pending",amount:0},appColumns:[{title:"申请ID",dataIndex:"id",key:"id"},{title:"学员ID",dataIndex:"studentId",key:"studentId"},{title:"金额",dataIndex:"amount",key:"amount"},{title:"状态",dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"操作",key:"action",scopedSlots:{customRender:"action"}}],recColumns:[{title:"记录ID",dataIndex:"id",key:"id"},{title:"发票号",dataIndex:"invoiceNo",key:"invoiceNo"},{title:"开票日期",dataIndex:"invoiceDate",key:"invoiceDate"},{title:"校区ID",dataIndex:"campusId",key:"campusId"},{title:"学员ID",dataIndex:"studentId",key:"studentId"},{title:"金额",dataIndex:"amount",key:"amount"},{title:"状态",dataIndex:"deliveryStatus",key:"deliveryStatus"}]}},components:{V2SimpleDate:()=>c(()=>import("./V2SimpleDate-11821f76.js"),["assets/V2SimpleDate-11821f76.js","assets/index-67337038.js","assets/index-f5f188af.css","assets/V2SimpleDate-9b3aafb8.css"])},methods:{async loadCampusOptions(){try{const e=await(await fetch("/api/base/campus/list")).json();e&&e.code===200?this.campusOptions=Array.isArray(e.data)?e.data:[]:this.campusOptions=[]}catch{this.campusOptions=[]}},async loadApplications(){try{const e=await(await fetch("/api/finance/invoice/applications")).json();this.applications=Array.isArray(e.data)?e.data:[]}catch{this.applications=[]}},async loadRecords(){const s=[];this.filter.month&&s.push("month="+encodeURIComponent(this.filter.month)),this.filter.campusId!=null&&this.filter.campusId!==""&&s.push("campusId="+encodeURIComponent(this.filter.campusId));const e="/api/finance/invoice/records"+(s.length?"?"+s.join("&"):"");try{const a=await(await fetch(e)).json();this.records=Array.isArray(a.data)?a.data:[]}catch{this.records=[]}},openIssue(s){this.issueVisible=!0,this.issue={applicationId:s.id,settlementId:s.settlementId,studentId:s.studentId,campusId:null,invoiceNo:"",invoiceDate:"",deliveryStatus:"pending",amount:s.amount}},async doIssue(){const s={...this.issue};if(s.invoiceDate&&typeof s.invoiceDate!="string")try{const a=s.invoiceDate,i=a.year(),n=(a.month()+1).toString().padStart(2,"0"),o=a.date().toString().padStart(2,"0");s.invoiceDate=`${i}-${n}-${o}`}catch{}const t=await(await fetch("/api/finance/invoice/issue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();t&&t.code===0?(this.$message&&this.$message.success("开票成功"),this.issueVisible=!1,this.loadApplications(),this.loadRecords()):this.$message&&this.$message.error("开票失败："+(t.msg||"未知错误"))}},mounted(){this.loadCampusOptions(),this.loadApplications(),this.loadRecords()}};var d=function(){var e=this,t=e._self._c;return t("div",{staticClass:"invoice-manage"},[t("a-page-header",{attrs:{title:"发票管理","sub-title":"记录发票号码、开票日期、寄送状态"}}),t("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:"",title:"申请列表"}},[t("a-table",{attrs:{"data-source":e.applications,columns:e.appColumns,rowKey:"id",pagination:!1},scopedSlots:e._u([{key:"status",fn:function(a){return[a.text==="APPLIED"?t("a-tag",{attrs:{color:"orange"}},[e._v("已申请")]):t("a-tag",{attrs:{color:"green"}},[e._v("已开票")])]}},{key:"action",fn:function(a){return[a&&a.record?t("a-space",[t("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"finance:invoice:manage",expression:"'finance:invoice:manage'"}],attrs:{size:"small",type:"primary",disabled:String(a.record.status)==="INVOICED"},on:{click:function(i){return e.openIssue(a.record)}}},[e._v("开票")])],1):t("span",[e._v("—")])]}}])})],1),t("a-card",{attrs:{bordered:"",title:"发票记录"}},[t("a-space",{staticStyle:{"margin-bottom":"12px"}},[t("V2SimpleDate",{staticStyle:{width:"160px"},attrs:{type:"month",format:"YYYY-MM",placeholder:"选择月份"},model:{value:e.filter.month,callback:function(a){e.$set(e.filter,"month",a)},expression:"filter.month"}}),t("a-select",{staticStyle:{width:"180px"},attrs:{placeholder:"选择学校(可选)",allowClear:""},model:{value:e.filter.campusId,callback:function(a){e.$set(e.filter,"campusId",a)},expression:"filter.campusId"}},e._l(e.campusOptions,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.name))])}),1),t("a-button",{on:{click:e.loadRecords}},[e._v("查询")])],1),t("a-table",{attrs:{"data-source":e.records,columns:e.recColumns,rowKey:"id",pagination:!1}})],1),t("a-modal",{attrs:{title:"开具发票",footer:null},model:{value:e.issueVisible,callback:function(a){e.issueVisible=a},expression:"issueVisible"}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[t("a-form-item",{attrs:{label:"申请ID"}},[t("a-input",{attrs:{disabled:""},model:{value:e.issue.applicationId,callback:function(a){e.$set(e.issue,"applicationId",a)},expression:"issue.applicationId"}})],1),t("a-form-item",{attrs:{label:"学员ID"}},[t("a-input",{model:{value:e.issue.studentId,callback:function(a){e.$set(e.issue,"studentId",a)},expression:"issue.studentId"}})],1),t("a-form-item",{attrs:{label:"缴费记录ID"}},[t("a-input",{model:{value:e.issue.settlementId,callback:function(a){e.$set(e.issue,"settlementId",a)},expression:"issue.settlementId"}})],1),t("a-form-item",{attrs:{label:"校区ID"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.issue.campusId,callback:function(a){e.$set(e.issue,"campusId",a)},expression:"issue.campusId"}})],1),t("a-form-item",{attrs:{label:"发票号"}},[t("a-input",{attrs:{placeholder:"不填自动生成"},model:{value:e.issue.invoiceNo,callback:function(a){e.$set(e.issue,"invoiceNo",a)},expression:"issue.invoiceNo"}})],1),t("a-form-item",{attrs:{label:"开票日期"}},[t("V2SimpleDate",{staticStyle:{width:"100%"},attrs:{type:"date",format:"YYYY-MM-DD"},model:{value:e.issue.invoiceDate,callback:function(a){e.$set(e.issue,"invoiceDate",a)},expression:"issue.invoiceDate"}})],1),t("a-form-item",{attrs:{label:"寄送状态"}},[t("a-select",{staticStyle:{width:"100%"},model:{value:e.issue.deliveryStatus,callback:function(a){e.$set(e.issue,"deliveryStatus",a)},expression:"issue.deliveryStatus"}},[t("a-select-option",{attrs:{value:"pending"}},[e._v("待寄送")]),t("a-select-option",{attrs:{value:"sent"}},[e._v("已寄送")]),t("a-select-option",{attrs:{value:"received"}},[e._v("已签收")])],1)],1),t("a-form-item",{attrs:{label:"金额"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.issue.amount,callback:function(a){e.$set(e.issue,"amount",a)},expression:"issue.amount"}})],1),t("a-form-item",{attrs:{"wrapper-col":{span:12,offset:6}}},[t("a-space",[t("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"finance:invoice:manage",expression:"'finance:invoice:manage'"}],attrs:{type:"primary"},on:{click:e.doIssue}},[e._v("确认开票")]),t("a-button",{on:{click:function(a){e.issueVisible=!1}}},[e._v("取消")])],1)],1)],1)],1)],1)},u=[],p=l(r,d,u,!1,null,"2a05ea87",null,null);const v=p.exports;export{v as default};
