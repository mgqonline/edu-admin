import{n as v}from"./index-67337038.js";const y={name:"RenewManage",data(){return{studentOptions:[],classOptions:[],classroomOptions:[],enrollOptions:[],recentList:[],saving:!1,form:{studentId:null,classId:null,classroomId:null,seatNo:null,unitPrice:0,hours:1,textbookFee:0,discount:0,totalFee:0,method:"cash",receiptNo:"",receiver:"",voucherUrl:""},seatPreviewVisible:!1,seatLoading:!1,seatGrid:[],seatLabelMap:{},occupiedMap:{}}},computed:{columns(){return[{title:"ID",dataIndex:"id"},{title:"类型",dataIndex:"opType",scopedSlots:{customRender:"opType"}},{title:"班级",dataIndex:"classId"},{title:"教室",dataIndex:"classroomId"},{title:"座位",dataIndex:"seatNo"},{title:"单价",dataIndex:"unitPrice"},{title:"课时",dataIndex:"hours"},{title:"教材费",dataIndex:"textbookFee"},{title:"优惠",dataIndex:"discount"},{title:"总额",dataIndex:"totalFee"},{title:"方式",dataIndex:"method"},{title:"状态",dataIndex:"status",scopedSlots:{customRender:"status"}}]},seatOptions(){if(!this.form.classroomId)return[];const a=(this.classroomOptions||[]).find(s=>s.id===this.form.classroomId),t=Number(a&&(a.usableSeats!=null?a.usableSeats:a.capacity))||0,e=[];for(let s=1;s<=t;s++)e.push(s);return e}},methods:{async loadStudents(){try{const t=await(await fetch("/api/student/list")).json();this.studentOptions=Array.isArray(t.data)?t.data.map(e=>({id:e.id,name:e.name})):[]}catch{this.studentOptions=[]}},async loadClasses(){try{const t=await(await fetch("/api/class/list")).json();this.classOptions=Array.isArray(t.data)?t.data:[]}catch{this.classOptions=[]}},async loadClassrooms(){try{const t=await(await fetch("/api/base/classroom/list")).json();this.classroomOptions=Array.isArray(t.data)?t.data:[]}catch{this.classroomOptions=[]}},async onStudentChange(a){if(this.form.classId=null,this.enrollOptions=[],!!a)try{const e=await(await fetch(`/api/enroll/list?studentId=${a}`)).json(),s=Array.isArray(e.data)?e.data:[];this.enrollOptions=s.map(r=>{const o=this.classOptions.find(n=>n.id===r.classId);return{classId:r.classId,className:o?o.title||o.name||"班级#"+o.id:"班级#"+r.classId,status:r.status}})}catch{this.enrollOptions=[]}},onClassChange(a){const t=this.classOptions.find(e=>e.id===a);t&&t.fee!=null&&(this.form.unitPrice=Number(t.fee)||0),this.form.seatNo=null,this.occupiedMap={},this.loadOccupiedSeats(),this.recalc()},onClassroomChange(){this.form.seatNo=null,this.seatLabelMap={},this.occupiedMap={},this.loadOccupiedSeats(),this.loadSeatLabels()},async onSeatDropdownOpen(a){a&&((!this.seatLabelMap||Object.keys(this.seatLabelMap).length===0)&&await this.loadSeatLabels(),await this.loadOccupiedSeats())},async loadSeatLabels(){if(this.seatLabelMap={},!!this.form.classroomId)try{const t=await(await fetch(`/api/base/classroom/seats/${this.form.classroomId}`)).json(),e=Array.isArray(t.data)?t.data:[],s={};let r=0;for(const o of e){if(!!!o.usable)continue;let l=o.seatNo!=null?Number(o.seatNo):null;(!Number.isFinite(l)||l<=0)&&(r+=1,l=r),s[l]=String(o.label||"")}this.seatLabelMap=s}catch{}},async loadOccupiedSeats(){if(this.occupiedMap={},!(!this.form.classroomId||!this.form.classId))try{const t=await(await fetch(`/api/finance/settlement/occupied-seats?classroomId=${this.form.classroomId}&classId=${this.form.classId}`)).json(),e=Array.isArray(t.data)?t.data:[],s={};e.forEach(r=>{const o=Number(r.seatNo);Number.isFinite(o)&&o>0&&(s[o]=String(r.studentName||"已占用"))}),this.occupiedMap=s}catch{}},async openSeatPreview(){if(!this.form.classroomId){this.$message&&this.$message.warning("请先选择教室");return}this.seatPreviewVisible=!0,this.seatLoading=!0,this.seatGrid=[];try{const t=await(await fetch(`/api/base/classroom/seats/${this.form.classroomId}`)).json(),e=Array.isArray(t.data)?t.data:[],s=e.reduce((i,c)=>Math.max(i,Number(c.rowIndex||0)),0),r=e.reduce((i,c)=>Math.max(i,Number(c.colIndex||0)),0),o=s+1,n=r+1,l=[];let p=0;for(let i=0;i<o;i++){const c=[];for(let d=0;d<n;d++){const u=e.find(h=>Number(h.rowIndex)===i&&Number(h.colIndex)===d)||{usable:!1,label:`${String.fromCharCode(65+i)}${d+1}`},f=!!u.usable;let m=u.seatNo!=null?Number(u.seatNo):null;(!Number.isFinite(m)||m<=0)&&(p+=1,m=p);const b=this.occupiedMap[m]||"";c.push({label:String(u.label||`${String.fromCharCode(65+i)}${d+1}`),usable:f,seatNo:m,occupiedName:b})}l.push(c)}this.seatGrid=l}catch{}finally{this.seatLoading=!1}},onPickSeat(a){!a||!a.usable||a.occupiedName||(this.form.seatNo=a.seatNo,this.seatPreviewVisible=!1)},async recalc(){try{const a={opType:"renew",unitPrice:this.form.unitPrice,hours:this.form.hours,textbookFee:this.form.textbookFee,discount:this.form.discount},e=await(await fetch("/api/finance/settlement/calculate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();e&&e.code===200&&(this.form.totalFee=Number(e.data&&e.data.totalFee||0))}catch{}},genReceiptNo(){const a=new Date,t=a.getFullYear(),e=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0"),r=String(a.getHours()).padStart(2,"0"),o=String(a.getMinutes()).padStart(2,"0"),n=String(a.getSeconds()).padStart(2,"0");return`RC-${t}${e}${s}-${r}${o}${n}`},async saveRenew(){if(!this.form.studentId||!this.form.classId){this.$message&&this.$message.error("请先选择学员与已报班级");return}if(!this.form.classroomId||!this.form.seatNo){this.$message&&this.$message.warning("请填写教室与座位");return}this.saving=!0;try{const a={opType:"renew",studentId:Number(this.form.studentId),classId:Number(this.form.classId),classroomId:Number(this.form.classroomId),seatNo:Number(this.form.seatNo),unitPrice:Number(this.form.unitPrice),hours:Number(this.form.hours),textbookFee:Number(this.form.textbookFee),discount:Number(this.form.discount),totalFee:Number(this.form.totalFee),method:this.form.method,receiptNo:this.form.receiptNo||this.genReceiptNo(),receiver:this.form.receiver,voucherUrl:this.form.voucherUrl,status:"paid"},e=await(await fetch("/api/finance/settlement/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json();if(e&&e.code===200)this.$message&&this.$message.success("续费记录已保存"),this.loadRecent();else if(e&&e.code===409)this.$message&&this.$message.error("该座位已被占用，请重新选择");else throw new Error("保存失败")}catch(a){this.$message&&this.$message.error(a.message||"保存失败")}this.saving=!1},async loadRecent(){try{const t=await(await fetch("/api/finance/settlement/list")).json(),e=Array.isArray(t.data)?t.data:[],s=this.form.studentId;this.recentList=e.filter(r=>!s||r.studentId===s)}catch{this.recentList=[]}}},created(){this.loadStudents(),this.loadClasses(),this.loadClassrooms(),this.recalc(),this.loadRecent();try{const a=this.$route&&this.$route.query?this.$route.query:{};if(a&&a.studentId){const t=Number(a.studentId)||null;this.form.studentId=t,this.onStudentChange(t),this.loadRecent()}}catch{}}};var g=function(){var t=this,e=t._self._c;return e("div",{staticClass:"renew-manage"},[e("a-page-header",{attrs:{title:"续费录入","sub-title":"为已报班学员续费并入库"}}),e("a-card",{attrs:{bordered:"",title:"选择学员与班级"}},[e("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[e("a-form-item",{attrs:{label:"学员"}},[e("a-select",{attrs:{"show-search":"",placeholder:"选择学员"},on:{change:t.onStudentChange},model:{value:t.form.studentId,callback:function(s){t.$set(t.form,"studentId",s)},expression:"form.studentId"}},t._l(t.studentOptions,function(s){return e("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name)+"（#"+t._s(s.id)+"）")])}),1)],1),e("a-form-item",{attrs:{label:"已报班级"}},[e("a-select",{attrs:{placeholder:"选择已报班级"},on:{change:t.onClassChange},model:{value:t.form.classId,callback:function(s){t.$set(t.form,"classId",s)},expression:"form.classId"}},t._l(t.enrollOptions,function(s){return e("a-select-option",{key:s.classId,attrs:{value:s.classId}},[t._v(t._s(s.className||"班级#"+s.classId))])}),1)],1),e("a-form-item",{attrs:{label:"教室"}},[e("a-select",{attrs:{placeholder:"选择教室",allowClear:""},on:{change:t.onClassroomChange},model:{value:t.form.classroomId,callback:function(s){t.$set(t.form,"classroomId",s)},expression:"form.classroomId"}},t._l(t.classroomOptions,function(s){return e("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name)+"（可用座位："+t._s(Number(s.usableSeats||s.capacity||0))+"）")])}),1)],1),e("a-form-item",{attrs:{label:"座位"}},[e("a-space",[e("a-select",{staticStyle:{width:"300px"},attrs:{placeholder:"选择座位",disabled:!t.form.classroomId||t.seatOptions.length===0,allowClear:""},on:{dropdownVisibleChange:t.onSeatDropdownOpen},model:{value:t.form.seatNo,callback:function(s){t.$set(t.form,"seatNo",s)},expression:"form.seatNo"}},t._l(t.seatOptions,function(s){return e("a-select-option",{key:s,attrs:{value:s,disabled:!!t.occupiedMap[s]}},[t._v(" "+t._s(s)+" 号 - "+t._s(t.seatLabelMap[s]||"未知")+" "),t.occupiedMap[s]?[t._v("（已占用："+t._s(t.occupiedMap[s])+"）")]:t._e()],2)}),1),e("a-button",{attrs:{disabled:!t.form.classroomId},on:{click:t.openSeatPreview}},[t._v("预览座位")])],1)],1),e("a-form-item",{attrs:{label:"单价(元/课时)"}},[e("a-input-number",{staticStyle:{width:"160px"},attrs:{min:0,precision:2},model:{value:t.form.unitPrice,callback:function(s){t.$set(t.form,"unitPrice",s)},expression:"form.unitPrice"}})],1),e("a-form-item",{attrs:{label:"续费课时"}},[e("a-input-number",{staticStyle:{width:"160px"},attrs:{min:1,precision:2},model:{value:t.form.hours,callback:function(s){t.$set(t.form,"hours",s)},expression:"form.hours"}})],1),e("a-form-item",{attrs:{label:"教材费"}},[e("a-input-number",{staticStyle:{width:"160px"},attrs:{min:0,precision:2},model:{value:t.form.textbookFee,callback:function(s){t.$set(t.form,"textbookFee",s)},expression:"form.textbookFee"}})],1),e("a-form-item",{attrs:{label:"优惠"}},[e("a-input-number",{staticStyle:{width:"160px"},attrs:{min:0,precision:2},model:{value:t.form.discount,callback:function(s){t.$set(t.form,"discount",s)},expression:"form.discount"}})],1),e("a-form-item",{attrs:{label:"应付总额"}},[e("a-space",[e("span",[t._v("¥ "+t._s(t.form.totalFee.toFixed(2)))]),e("a-button",{attrs:{size:"small"},on:{click:t.recalc}},[t._v("重新计算")])],1)],1)],1)],1),e("a-card",{staticStyle:{"margin-top":"12px"},attrs:{bordered:"",title:"支付与票据"}},[e("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[e("a-form-item",{attrs:{label:"支付方式"}},[e("a-select",{attrs:{placeholder:"选择支付方式"},model:{value:t.form.method,callback:function(s){t.$set(t.form,"method",s)},expression:"form.method"}},[e("a-select-option",{attrs:{value:"cash"}},[t._v("现金")]),e("a-select-option",{attrs:{value:"wechat"}},[t._v("微信")]),e("a-select-option",{attrs:{value:"alipay"}},[t._v("支付宝")]),e("a-select-option",{attrs:{value:"bankcard"}},[t._v("银行卡")])],1)],1),e("a-form-item",{attrs:{label:"收据编号"}},[e("a-input",{attrs:{placeholder:"自动生成，可覆盖"},model:{value:t.form.receiptNo,callback:function(s){t.$set(t.form,"receiptNo",s)},expression:"form.receiptNo"}})],1),e("a-form-item",{attrs:{label:"领取人"}},[e("a-input",{attrs:{placeholder:"填写领取人"},model:{value:t.form.receiver,callback:function(s){t.$set(t.form,"receiver",s)},expression:"form.receiver"}})],1),e("a-form-item",{attrs:{label:"凭证URL"}},[e("a-input",{attrs:{placeholder:"可粘贴上传后的地址（演示）"},model:{value:t.form.voucherUrl,callback:function(s){t.$set(t.form,"voucherUrl",s)},expression:"form.voucherUrl"}})],1),e("a-form-item",{attrs:{"wrapper-col":{span:12,offset:6}}},[e("a-space",[e("a-button",{attrs:{type:"primary",loading:t.saving},on:{click:t.saveRenew}},[t._v("保存续费记录")]),e("a-button",{on:{click:t.loadRecent}},[t._v("加载该学员近期缴费")])],1)],1)],1)],1),e("a-card",{staticStyle:{"margin-top":"12px"},attrs:{bordered:"",title:"近期缴费记录"}},[e("a-table",{attrs:{"data-source":t.recentList,columns:t.columns,rowKey:"id",pagination:!1},scopedSlots:t._u([{key:"opType",fn:function(s){return[s.text==="renew"?e("a-tag",{attrs:{color:"geekblue"}},[t._v("续费")]):e("a-tag",{attrs:{color:"blue"}},[t._v("报名")])]}},{key:"status",fn:function(s){return[s.text==="paid"?e("a-tag",{attrs:{color:"green"}},[t._v("已支付")]):e("a-tag",{attrs:{color:"red"}},[t._v("未缴清")])]}}])})],1),e("a-modal",{attrs:{title:"座位预览与选择",footer:null,width:"720px"},model:{value:t.seatPreviewVisible,callback:function(s){t.seatPreviewVisible=s},expression:"seatPreviewVisible"}},[t.seatLoading?e("div",[t._v("加载座位中...")]):e("div",{staticClass:"seat-grid"},t._l(t.seatGrid,function(s,r){return e("div",{key:"row-"+r,staticClass:"seat-row"},t._l(s,function(o){return e("div",{key:o.label,staticClass:"seat-cell",class:{disabled:!o.usable,occupied:!!o.occupiedName,selected:t.form.seatNo===o.seatNo},on:{click:function(n){return t.onPickSeat(o)}}},[e("div",{staticClass:"seat-label"},[t._v(t._s(o.label))]),o.occupiedName?e("div",{staticClass:"seat-name"},[t._v(t._s(o.occupiedName))]):e("div",{staticClass:"seat-no"},[t._v("#"+t._s(o.seatNo))])])}),0)}),0)])],1)},w=[],I=v(y,g,w,!1,null,"3428a221",null,null);const N=I.exports;export{N as default};
