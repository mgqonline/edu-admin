import{n as f,_ as g}from"./index-67337038.js";const b={name:"ClassDictPage",components:{V2SimpleDate:()=>g(()=>import("./V2SimpleDate-11821f76.js"),["assets/V2SimpleDate-11821f76.js","assets/index-67337038.js","assets/index-f5f188af.css","assets/V2SimpleDate-9b3aafb8.css"])},data(){return{loading:!1,loadingExport:!1,list:[],pagination:{current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},campusOptions:[],staffList:[],classroomOptions:[],gradeOptions:[],subjectOptions:[],detail:{visible:!1,item:{}},schedule:{visible:!1,items:[],meta:{}},students:{visible:!1,items:[],meta:{}},filters:{status:"",campusId:null,gradeId:null,q:"",subject:null},modal:{visible:!1,mode:"add",form:{id:null,campusId:null,gradeId:null,name:"",mode:"",startDate:null,endDate:null,term:"",state:"normal",headTeacherIds:[],classroom:"",status:"enabled",sortOrder:0,capacityLimit:null,feeStandard:"",feeStatus:"",tags:[],note:"",parentGroup:"",contacts:""}},columns:[{title:"学校/校区",dataIndex:"campusName",key:"campusName",scopedSlots:{customRender:"campus"}},{title:"年级",dataIndex:"gradeName",key:"gradeName",scopedSlots:{customRender:"grade"}},{title:"名称",dataIndex:"name",key:"name"},{title:"授课模式",dataIndex:"mode",key:"mode"},{title:"科目",dataIndex:"subjectName",key:"subjectName",scopedSlots:{customRender:"subject"}},{title:"主教室",dataIndex:"classroom",key:"classroom"},{title:"班主任",dataIndex:"headTeacherNames",key:"headTeacherNames"},{title:"开课日期",dataIndex:"startDate",key:"startDate",scopedSlots:{customRender:"startDate"}},{title:"结课日期",dataIndex:"endDate",key:"endDate",scopedSlots:{customRender:"endDate"}},{title:"当前学期",dataIndex:"term",key:"term"},{title:"报班人数",dataIndex:"currentCount",key:"currentCount"},{title:"班额",dataIndex:"capacityLimit",key:"capacityLimit"},{title:"班级状态",dataIndex:"state",key:"state",scopedSlots:{customRender:"state"}},{title:"学费",dataIndex:"feeStandard",key:"feeStandard"},{title:"收费状态",dataIndex:"feeStatus",key:"feeStatus"},{title:"班型",dataIndex:"tags",key:"tags",scopedSlots:{customRender:"tags"}},{title:"启用",dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"操作",key:"action",width:140,fixed:"right",className:"action-cell",scopedSlots:{customRender:"action"}}]}},computed:{modalTitle(){return this.modal.mode==="edit"?"编辑班级":"新增班级"},emptyText(){const e=this.filters||{};return!!(e.q||e.campusId||e.gradeId||e.status)?"没有匹配的班级":"暂无班级数据"}},created(){this.loadCampusOptions().then(async()=>{await Promise.all([this.loadGradeOptions(),this.loadStaffOptions()]),await this.loadSubjectOptions(),this.loadData()})},methods:{rowKeySchedule(e,t){return t},rowKeyStudent(e,t){return t},rowKeyMain(e){return e?e.id||String(e.campusId||"")+"-"+String(e.gradeId||"")+"-"+String(e.name||""):Math.random().toString(36).slice(2)},onNameFocus(){const e=this.modal&&this.modal.form?this.modal.form:null;e&&(!e.subject&&Array.isArray(this.subjectOptions)&&this.subjectOptions.length&&(this.modal.form.subject=this.subjectOptions[0].id),this.suggestClassName())},async exportXlsx(){this.loadingExport=!0;try{const e=new URLSearchParams;this.filters.status&&e.append("status",this.filters.status),this.filters.campusId&&e.append("campusId",String(this.filters.campusId)),this.filters.gradeId&&e.append("gradeId",String(this.filters.gradeId)),this.filters.q&&e.append("q",this.filters.q);const t="/api/dict/class/export"+(e.toString()?"?"+e.toString():""),a=await fetch(t,{method:"GET"});if(!a.ok){this.$message.error("导出失败："+a.status);return}const s=await a.blob(),i=a.headers.get("Content-Disposition")||"";let n="class_info.xlsx";const o=i.match(/filename\s*=\s*([^;]+)/i);o&&o[1]&&(n=decodeURIComponent(o[1].replace(/"/g,"")));const l=window.URL.createObjectURL(s),r=document.createElement("a");r.href=l,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(l)}catch(e){console.error(e),this.$message.error("导出出现异常")}finally{this.loadingExport=!1}},campusNameById(e){const t=this.campusOptions.find(a=>String((a&&a.id)!=null?a.id:a.campusId)===String(e));return t?t.name:""},gradeNameById(e){const a=(Array.isArray(this.gradeOptions)?this.gradeOptions:[]).find(s=>String((s&&s.id)!=null?s.id:s.gradeId)===String(e));return a?a.name:""},stateLabel(e){return{normal:"正常",preparing:"筹备中",finished:"已结课",dissolved:"已解散",paused:"暂停"}[e]||"—"},stateTagColor(e){return{normal:"green",preparing:"orange",finished:"blue",dissolved:"red",paused:"gold"}[e]||"default"},formatDate(e){if(!e)return"-";try{const t=new Date(e);if(isNaN(t.getTime()))return String(e);const a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${a}-${s}-${i}`}catch{return String(e)}},normalizeTags(e){return Array.isArray(e)?e.filter(Boolean):typeof e=="string"&&e.trim()?[e.trim()]:[]},async loadCampusOptions(){try{const t=await(await fetch("/api/base/campus/list")).json();let a=t&&t.code===200?t.data||[]:[];if(!a||!a.length){const i=await(await fetch("/api/campus/list")).json();i&&i.code===200&&(a=(i.data||[]).map(o=>({id:o.id!=null?o.id:o.campusId,name:o.name})))}this.campusOptions=a}catch{this.campusOptions=[]}},async loadGradeOptions(){try{const e=new URLSearchParams,t=this.modal&&this.modal.form&&this.modal.form.campusId||this.filters.campusId;t&&e.append("campusId",t);const a=`/api/dict/grade/list${e.toString()?"?"+e.toString():""}`,i=await(await fetch(a)).json();if(i&&i.code===200){const n=i.data||{},o=Array.isArray(n.items)?n.items:Array.isArray(i.data)?i.data:[];this.gradeOptions=o}else this.gradeOptions=[];this.modal&&this.modal.visible&&this.modal.form&&(!this.modal.form.gradeId&&this.gradeOptions&&this.gradeOptions.length&&(this.modal.form.gradeId=this.gradeOptions[0].id),this.modal.form.name||this.suggestClassName())}catch{this.gradeOptions=[]}},async loadStaffOptions(){try{const t=await(await fetch("/api/base/staff/list?page=1&size=100")).json();if(t&&t.code===200){const a=t.data||{};this.staffList=Array.isArray(a.items)?a.items:Array.isArray(t.data)?t.data:[]}else this.staffList=[]}catch{this.staffList=[]}},async loadSubjectOptions(){try{const t=await(await fetch("/api/dict/subject/list")).json();this.subjectOptions=t&&t.code===200?t.data||[]:[],this.modal&&this.modal.visible&&this.modal.form&&!this.modal.form.subject&&this.subjectOptions&&this.subjectOptions.length&&(this.modal.form.subject=this.subjectOptions[0].id)}catch{this.subjectOptions=[]}},async openDetail(e){const t=e||{};t.scheduleStatus||await this.ensureRecordScheduleStatus(t),this.detail.item=t,this.detail.visible=!0},goArrange(e,t=!1){if(!e||!e.id){this.$message.error("无法排课：缺少班级信息");return}const a={classId:String(e.id),className:e.name||"",mode:e.mode||"",classType:(e.classType||"").trim()||"班课",subject:(e.course||e.subject||"").trim()};e.headTeacherId&&(a.teacherId=String(e.headTeacherId)),t&&(a.reschedule="true"),this.$router.push({path:"/course/schedule",query:a})},goSchedule(e){const t=["语文","数学","英语","科学","音乐","美术","体育","信息"],a=["教学楼201","教学楼302","多媒体101","操场","实验室201"],s=["周一","周二","周三","周四","周五"],i=["08:00-08:45","09:00-09:45","10:00-10:45","11:00-11:45","14:00-14:45","15:00-15:45"],n=d=>d[Math.floor(Math.random()*d.length)],o=d=>{const m=this.staffList.find(h=>String(h.id)===String(d));return m?m.name||m.title||"#"+m.id:"任课老师"},l=Array.isArray(e.headTeacherIds)?e.headTeacherIds:[],r=[];for(let d of s)for(let m=0;m<4;m++)r.push({day:d,time:n(i),course:n(t),teacher:o(n(l.length?l:[e.headTeacherId,""])),room:n(a)});this.schedule.meta={className:e.name,classId:e.id,campus:this.campusNameById(e.campusId),grade:this.gradeNameById(e.gradeId)},this.schedule.items=r,this.schedule.visible=!0},viewStudents(e){const t=["张","李","王","刘","陈","杨","黄","赵","周","吴","徐","孙"],a=["一","二","三","四","五","六","七","八","九","十","嘉","晨","宇","涵","玥","珺","泽","诺","洋","琪"],s=l=>l[Math.floor(Math.random()*l.length)],i=()=>s(t)+s(a)+(Math.random()>.5?s(a):""),n=Math.max(12,Math.min(36,Number(e.capacityLimit||24))),o=Array.from({length:n}).map((l,r)=>({no:r+1,name:i(),gender:Math.random()>.5?"男":"女",status:"在读",joinDate:new Date(Date.now()-Math.floor(Math.random()*200)*864e5).toISOString().slice(0,10),contact:"1"+String(Math.floor(Math.random()*9)+3)+String(Math.floor(1e8+Math.random()*899999999))}));this.students.meta={className:e.name,classId:e.id},this.students.items=o,this.students.visible=!0},openBatchImport(){console.debug("openBatchImport"),this.$message&&this.$message.info("批量导入：功能占位，待接入")},openBatchAdjustGrade(){console.debug("openBatchAdjustGrade"),this.$message&&this.$message.info("批量年级调整：功能占位，待接入")},openBatchAdjustStatus(){console.debug("openBatchAdjustStatus"),this.$message&&this.$message.info("批量状态调整：功能占位，待接入")},onModalCampusChange(){this.loadGradeOptions(),this.loadClassroomOptions()},async loadClassroomOptions(){try{const e=new URLSearchParams,t=this.modal&&this.modal.form&&this.modal.form.campusId||this.filters.campusId;t&&e.append("campusId",t);const s=await(await fetch("/api/base/classroom/list"+(e.toString()?"?"+e.toString():""))).json();if(s&&s.code===200){const i=s.data||{},n=Array.isArray(i.items)?i.items:Array.isArray(s.data)?s.data:[];if(this.classroomOptions=n,this.modal&&this.modal.visible&&this.modal.form){const o=!!this.modal.form.classroomId,l=!!(this.modal.form.classroom&&String(this.modal.form.classroom).trim());if(!o&&l){const r=(this.classroomOptions||[]).find(d=>String(d.name)===String(this.modal.form.classroom));r&&(this.modal.form.classroomId=r.id)}}}else this.classroomOptions=[]}catch{this.classroomOptions=[]}},onClassroomChange(e){const t=(this.classroomOptions||[]).find(a=>String(a.id)===String(e));t&&(this.modal.form.classroom=t.name,(!this.modal.form.capacityLimit||Number(this.modal.form.capacityLimit)<=0)&&(this.modal.form.capacityLimit=Number(t.usableSeats||t.capacity||0)))},onFilterCampusChange(){this.loadGradeOptions(),this.loadData()},async loadData(){this.loading=!0;try{const e=new URLSearchParams;this.filters.campusId&&e.append("campusId",this.filters.campusId),this.filters.gradeId&&e.append("gradeId",this.filters.gradeId),this.filters.status&&e.append("status",this.filters.status),this.filters.q&&e.append("q",this.filters.q),this.filters.subject&&e.append("subject",this.filters.subject),e.append("page",String(this.pagination.current)),e.append("size",String(this.pagination.pageSize));const a=await(await fetch(`/api/class/list${"?"+e.toString()}`)).json();if(a&&a.code===200){const s=a.data||{},i=Array.isArray(s.items)?s.items:Array.isArray(a.data)?a.data:[];this.list=i.map(n=>{console.log(n);const l=(Array.isArray(n.headTeacherIds)?n.headTeacherIds:[]).map(c=>{const u=(Array.isArray(this.staffList)?this.staffList:[]).find(p=>String(p.id)===String(c));return u?u.name||u.title||"#"+u.id:"#"+c}).join("、"),r=Array.isArray(n.students)?n.students.filter(c=>c&&c.status!=="退学").length:n.currentCount||0,d=n.campusName||this.campusNameById(n.campusId),m=n.gradeName||this.gradeNameById(n.gradeId),h=n.subjectName||((this.subjectOptions||[]).find(c=>String(c.id)===String(n.subject))||{}).name||"";return{...n,headTeacherNames:l,currentCount:r,campusName:d,gradeName:m,subjectName:h}}),this.pagination={...this.pagination,total:Number(s.total||i.length||0)},await this.enrichScheduleStatuses()}else this.list=[]}catch{this.list=[]}finally{this.loading=!1}},async ensureRecordScheduleStatus(e){if(!(!e||!e.id))try{const a=await(await fetch(`/api/schedule/query/class?classId=${e.id}`)).json(),i=(a&&a.code===200?a.data||[]:[]).length>0,n=new Date,o=e.endDate?new Date(e.endDate):null,l=o&&!isNaN(o.getTime())&&n>o;e.scheduleStatus=l?"已结课":i?"已排课":"未排课"}catch{e.scheduleStatus="未排课"}},async enrichScheduleStatuses(){const e=new Date,t=(this.list||[]).map(async a=>{try{const i=await(await fetch(`/api/schedule/query/class?classId=${a.id}`)).json(),o=(i&&i.code===200?i.data||[]:[]).length>0;let l="未排课";const r=a.endDate?new Date(a.endDate):null;r&&!isNaN(r.getTime())&&e>r?l="已结课":o&&(l="已排课"),a.scheduleStatus=l}catch{a.scheduleStatus="未排课"}});await Promise.all(t)},scheduleStatusLabel(e){const t=e||{};if(t.scheduleStatus)return t.scheduleStatus;try{const a=new Date,s=t.endDate?new Date(t.endDate):null;if(s&&!isNaN(s.getTime())&&a>s)return"已结课"}catch{}return"未排课"},scheduleTagColor(e){const t=this.scheduleStatusLabel(e);return{未排课:"default",已排课:"green",已结课:"blue"}[t]||"default"},canArrange(e){return this.scheduleStatusLabel(e)==="未排课"},canReschedule(e){return this.scheduleStatusLabel(e)==="已排课"},canDelete(e){return this.scheduleStatusLabel(e)==="未排课"},openAdd(){this.modal.mode="add",this.modal.form={id:null,campusId:this.filters.campusId||this.campusOptions[0]&&this.campusOptions[0].id||null,gradeId:this.filters.gradeId||null,name:"",mode:"",startDate:null,endDate:null,term:this.autoTerm(),state:"normal",headTeacherIds:[],classroom:"",status:"enabled",sortOrder:0,capacityLimit:null,feeStandard:"",feeStatus:"",tags:[],note:"",parentGroup:"",contacts:"",subject:null},this.modal.visible=!0,this.loadGradeOptions(),this.loadStaffOptions(),this.loadClassroomOptions(),this.loadSubjectOptions().then(()=>{!this.modal.form.subject&&Array.isArray(this.subjectOptions)&&this.subjectOptions.length&&(this.modal.form.subject=this.subjectOptions[0].id),(!this.modal.form.name||!String(this.modal.form.name).trim())&&this.suggestClassName()})},openEdit(e){if(console.log(!e,!e.id),!e||!e.id){console.warn("[openEdit] invalid record:",e),this.$message&&this.$message.warning("当前行数据无效，无法编辑");return}this.modal.mode="edit",this.modal.form={id:e.id,campusId:e.campusId,gradeId:e.gradeId,name:e.name,mode:e.mode||"",startDate:e.startDate||null,endDate:e.endDate||null,term:e.term||"",state:e.state||"normal",headTeacherIds:Array.isArray(e.headTeacherIds)?e.headTeacherIds:[],classroom:e.classroom||"",classroomId:e.classroomId||null,status:e.status||"enabled",capacityLimit:e.capacityLimit||null,feeStandard:e.feeStandard||"",feeStatus:e.feeStatus||"",tags:Array.isArray(e.tags)?e.tags:[],note:e.note||"",parentGroup:e.parentGroup||"",contacts:e.contacts||"",subject:e.subject||null},this.loadGradeOptions(),this.loadStaffOptions(),this.loadClassroomOptions(),this.loadSubjectOptions(),this.modal.visible=!0},closeModal(){this.modal.visible=!1},async saveModal(){const e=this.modal.form;if(!e.campusId){this.$message&&this.$message.warning("请选择学校/校区");return}if(!e.gradeId){this.$message&&this.$message.warning("请选择年级");return}if(!e.name){this.$message&&this.$message.warning("请输入班级名称");return}if(e.startDate&&e.endDate){const t=new Date(e.startDate).getTime(),a=new Date(e.endDate).getTime();if(!isNaN(t)&&!isNaN(a)&&t>a){this.$message&&this.$message.warning("结课日期不能早于开班日期");return}}if(e.capacityLimit!=null){const t=Number(e.capacityLimit);if(isNaN(t)||t<=0){this.$message&&this.$message.warning("班额限制必须为正数");return}}if(e.classroomId){const t=(this.classroomOptions||[]).find(a=>String(a.id)===String(e.classroomId));if(t){const a=Number(t.usableSeats||t.capacity||0);if(e.capacityLimit!=null&&Number(e.capacityLimit)>a){this.$message&&this.$message.warning(`班额(${e.capacityLimit})不能大于教室可用座位(${a})`);return}}}try{if(this.modal.mode==="add"){const a=await(await fetch("/api/dict/class/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campusId:e.campusId,gradeId:e.gradeId,name:e.name,mode:e.mode,startDate:e.startDate,endDate:e.endDate,term:e.term,state:e.state,headTeacherIds:e.headTeacherIds,classroom:e.classroom,status:e.status,capacityLimit:e.capacityLimit,feeStandard:e.feeStandard,feeStatus:e.feeStatus,tags:e.tags,note:e.note,parentGroup:e.parentGroup,contacts:e.contacts,classroomId:e.classroomId||null,subject:e.subject||null})})).json();if(a&&a.code===200)this.$message&&this.$message.success("新增成功"),this.modal.visible=!1,this.loadData();else{const s=a&&a.msg?a.msg:"新增失败";throw new Error(s)}}else{const a=await(await fetch(`/api/dict/class/update/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({campusId:e.campusId,gradeId:e.gradeId,name:e.name,mode:e.mode,startDate:e.startDate,endDate:e.endDate,term:e.term,state:e.state,headTeacherIds:e.headTeacherIds,classroom:e.classroom,status:e.status,capacityLimit:e.capacityLimit,feeStandard:e.feeStandard,feeStatus:e.feeStatus,tags:e.tags,note:e.note,parentGroup:e.parentGroup,contacts:e.contacts,classroomId:e.classroomId||null,subject:e.subject||null})})).json();if(a&&a.code===200)this.$message&&this.$message.success("更新成功"),this.modal.visible=!1,this.loadData();else if(a&&a.code===409){const s=this.campusNameById(e.campusId)||`#${e.campusId}`,i=this.gradeNameById(e.gradeId)||`#${e.gradeId}`,n=`同校同年级已存在该班级名称（${s} / ${i}：${e.name}）。请更换名称。`;this.$message&&this.$message.error(n)}else{const s=a&&a.msg?a.msg:"更新失败";this.$message&&this.$message.error(s)}}}catch(t){this.$message&&this.$message.error(t.message||"操作失败")}},async deleteItem(e){if(!e||e.id==null){this.$message&&this.$message.warning("当前行数据无效，无法删除");return}try{const a=await(await fetch(`/api/dict/class/delete/${e.id}`,{method:"DELETE"})).json();if(a&&a.code===200)this.$message&&this.$message.success("删除成功"),this.loadData();else{const s=a&&a.msg?a.msg:"删除失败";throw new Error(s)}}catch(t){this.$message&&this.$message.error(t.message||"删除失败")}},async toggleStatus(e){if(!e||e.id==null){this.$message&&this.$message.warning("当前行数据无效，无法更新状态");return}try{const t=e.status==="enabled"?"disabled":"enabled",s=await(await fetch(`/api/dict/class/update/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({campusId:e.campusId,gradeId:e.gradeId,name:e.name,mode:e.mode,startDate:e.startDate,endDate:e.endDate,term:e.term,headTeacherIds:e.headTeacherIds,classroom:e.classroom,status:t,sortOrder:Number(e.sortOrder||0),capacityLimit:e.capacityLimit,feeStandard:e.feeStandard,feeStatus:e.feeStatus,tags:e.tags,note:e.note,parentGroup:e.parentGroup,contacts:e.contacts})})).json();if(s&&s.code===200)this.$message&&this.$message.success("状态已更新"),this.loadData();else{const i=s&&s.msg?s.msg:"更新失败";throw new Error(i)}}catch(t){this.$message&&this.$message.error(t.message||"更新失败")}},async updateSort(e){if(!e||e.id==null){this.$message&&this.$message.warning("当前行数据无效，无法更新排序");return}try{const a=await(await fetch(`/api/dict/class/update/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({campusId:e.campusId,gradeId:e.gradeId,name:e.name,mode:e.mode,startDate:e.startDate,endDate:e.endDate,term:e.term,headTeacherIds:e.headTeacherIds,classroom:e.classroom,status:e.status||"enabled",sortOrder:Number(e.sortOrder||0),capacityLimit:e.capacityLimit,feeStandard:e.feeStandard,feeStatus:e.feeStatus,tags:e.tags,note:e.note,parentGroup:e.parentGroup,contacts:e.contacts})})).json();if(a&&a.code===200)this.$message&&this.$message.success("排序已更新"),this.loadData();else{const s=a&&a.msg?a.msg:"更新失败";throw new Error(s)}}catch(t){this.$message&&this.$message.error(t.message||"更新失败")}},suggestClassName(){const e=this.modal&&this.modal.form||{},t=this.gradeNameById(e.gradeId)||"",a=(()=>{const l=(Array.isArray(this.subjectOptions)?this.subjectOptions:[]).find(r=>String(r.id)===String(e.subject));return l?l.name:""})(),s=e.term&&String(e.term).trim()?String(e.term).trim():this.autoTerm(),i=[];t&&i.push(t),a&&i.push(a),s&&i.push(s);const n=(i.join("")+"班").trim();this.modal.form.name=n},autoTerm(){const e=new Date,t=e.getFullYear();return e.getMonth()+1>=8?`${t}-${t+1}上学期`:`${t}春季`},onTermFocus(){const e=this.modal&&this.modal.form||{};(!e.term||!String(e.term).trim())&&(this.modal.form.term=this.autoTerm()),(!e.name||!String(e.name).trim())&&this.suggestClassName()},onModalGradeChange(){this.modal.form.name||this.suggestClassName()},computeNextOrdinalSuffix(e,t){const a=["一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八","十九","二十"],s=this.gradeNameById(t)||"",i=(this.list||[]).filter(o=>String(o.campusId)===String(e)&&String(o.gradeId)===String(t)),n=new Set;for(const o of i){const l=String(o.name||"");if(s&&l.startsWith(s)){const r=l.slice(s.length);r&&/^(一|二|三|四|五|六|七|八|九|十(一|二|三|四|五|六|七|八|九)?|二十)班$/.test(r)&&n.add(r)}}for(const o of a){const l=`${o}班`;if(!n.has(l))return l}return`${i.length+1}班`},onTableChange(e){this.pagination={...this.pagination,current:e.current,pageSize:e.pageSize},this.loadData()}}};var y=function(){var t=this,a=t._self._c;return a("div",{staticClass:"class-dict-page"},[a("a-page-header",{attrs:{title:"班级管理","sub-title":"维护班级全量信息（标识、属性、人员、资源、状态）"}}),a("a-card",{attrs:{bordered:""}},[a("a-space",{staticStyle:{"margin-bottom":"12px",width:"100%"},attrs:{direction:"vertical"}},[a("a-space",{attrs:{wrap:""}},[a("a-input-search",{staticStyle:{width:"220px"},attrs:{placeholder:"按名称关键词搜索",allowClear:""},on:{search:t.loadData},model:{value:t.filters.q,callback:function(s){t.$set(t.filters,"q",s)},expression:"filters.q"}}),a("a-select",{staticStyle:{width:"200px"},attrs:{placeholder:"学校筛选",allowClear:""},on:{change:t.onFilterCampusChange},model:{value:t.filters.campusId,callback:function(s){t.$set(t.filters,"campusId",s)},expression:"filters.campusId"}},t._l(t.campusOptions,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1),a("a-select",{staticStyle:{width:"180px"},attrs:{placeholder:"年级筛选",allowClear:""},on:{change:t.loadData},model:{value:t.filters.gradeId,callback:function(s){t.$set(t.filters,"gradeId",s)},expression:"filters.gradeId"}},t._l(t.gradeOptions,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1),a("a-select",{staticStyle:{width:"160px"},attrs:{placeholder:"状态筛选",allowClear:""},on:{change:t.loadData},model:{value:t.filters.status,callback:function(s){t.$set(t.filters,"status",s)},expression:"filters.status"}},[a("a-select-option",{attrs:{value:"enabled"}},[t._v("启用")]),a("a-select-option",{attrs:{value:"disabled"}},[t._v("禁用")])],1),a("a-select",{staticStyle:{width:"180px"},attrs:{placeholder:"科目筛选",allowClear:""},on:{change:t.loadData},model:{value:t.filters.subject,callback:function(s){t.$set(t.filters,"subject",s)},expression:"filters.subject"}},t._l(t.subjectOptions,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1),a("a-button",{attrs:{loading:t.loading},on:{click:t.loadData}},[t._v("刷新")])],1),a("br"),a("br"),a("a-space",{attrs:{wrap:""}},[a("a-button",{attrs:{type:"primary"},on:{click:t.openAdd}},[t._v("新增班级")]),a("a-button",{attrs:{loading:t.loadingExport},on:{click:t.exportXlsx}},[t._v("导出xlsx")])],1)],1),a("a-table",{attrs:{"data-source":t.list,columns:t.columns,rowKey:t.rowKeyMain,pagination:t.pagination,locale:{emptyText:t.emptyText},scroll:{x:"max-content"},size:"small"},on:{change:t.onTableChange},scopedSlots:t._u([{key:"campus",fn:function(s,i,n){return[t._v(" "+t._s(i&&i.campusName||"-")+" ")]}},{key:"grade",fn:function(s,i,n){return[t._v(" "+t._s(i&&i.gradeName||"-")+" ")]}},{key:"subject",fn:function(s,i,n){return[t._v(" "+t._s(i&&i.subjectName||"-")+" ")]}},{key:"startDate",fn:function(s,i,n){return[t._v(" "+t._s(t.formatDate(s))+" ")]}},{key:"endDate",fn:function(s,i,n){return[t._v(" "+t._s(t.formatDate(s))+" ")]}},{key:"state",fn:function(s,i,n){return[a("a-tag",{attrs:{color:t.stateTagColor(s)}},[t._v(" "+t._s(t.stateLabel(s))+" ")])]}},{key:"tags",fn:function(s,i,n){return[a("a-space",{attrs:{wrap:""}},[t._l(t.normalizeTags(s),function(o){return a("a-tag",{key:o},[t._v(t._s(o))])}),t.normalizeTags(s).length?t._e():a("span",[t._v("-")])],2)]}},{key:"status",fn:function(s,i,n){return[a("a-tag",{attrs:{color:s==="enabled"?"green":"red"}},[t._v(" "+t._s(s==="enabled"?"启用":"禁用")+" ")])]}},{key:"action",fn:function(s,i,n){return[a("div",{staticClass:"action-cell-wrap"},[a("a-dropdown",{attrs:{placement:"bottomRight",trigger:["hover"]}},[a("a-button",{attrs:{size:"small",disabled:!i},on:{click:function(o){return t.openEdit(i)}}},[t._v("编辑")]),a("a-menu",{attrs:{slot:"overlay"},slot:"overlay"},[a("a-menu-item",[a("a",{on:{click:function(o){return t.openDetail(i)}}},[t._v("详情")])]),a("a-menu-item",{attrs:{disabled:!t.canArrange(i)}},[a("a",{class:["action-link",{"action-link-disabled":!t.canArrange(i)}],on:{click:function(o){t.canArrange(i)&&t.goArrange(i)}}},[t._v("排课")])]),a("a-menu-item",{attrs:{disabled:!t.canReschedule(i)}},[a("a",{class:["action-link",{"action-link-disabled":!t.canReschedule(i)}],on:{click:function(o){t.canReschedule(i)&&t.goArrange(i,!0)}}},[t._v("重新排课")])]),a("a-menu-item",[a("a",{on:{click:function(o){return t.goSchedule(i)}}},[t._v("课表")])]),a("a-menu-item",[a("a",{on:{click:function(o){return t.viewStudents(i)}}},[t._v("学生")])]),a("a-menu-item",{attrs:{disabled:!t.canDelete(i)}},[t.canDelete(i)?[a("a-popconfirm",{attrs:{title:"确认删除该班级？"},on:{confirm:function(o){return t.deleteItem(i)}}},[a("a",{staticClass:"action-delete"},[t._v("删除")])])]:[a("a",{staticClass:"action-delete action-delete-disabled"},[t._v("删除")])]],2),a("a-menu-item",[a("a",{on:{click:function(o){return t.toggleStatus(i)}}},[t._v(t._s(i&&i.status==="enabled"?"禁用":"启用"))])])],1)],1)],1)]}}])})],1),a("a-drawer",{attrs:{visible:t.detail.visible,title:"班级详情",width:"520"},on:{close:function(s){t.detail.visible=!1}}},[a("a-descriptions",{attrs:{bordered:"",size:"small",column:1}},[a("a-descriptions-item",{attrs:{label:"班级ID"}},[t._v(t._s(t.detail.item.id||"-"))]),a("a-descriptions-item",{attrs:{label:"名称"}},[t._v(t._s(t.detail.item.name||"-"))]),a("a-descriptions-item",{attrs:{label:"学校/校区"}},[t._v(t._s(t.campusNameById(t.detail.item.campusId)||"-"))]),a("a-descriptions-item",{attrs:{label:"年级"}},[t._v(t._s(t.gradeNameById(t.detail.item.gradeId)||"-"))]),a("a-descriptions-item",{attrs:{label:"授课模式"}},[t._v(t._s(t.detail.item.mode||"-"))]),a("a-descriptions-item",{attrs:{label:"开班/结课"}},[t._v(t._s((t.detail.item.startDate||"-")+" / "+(t.detail.item.endDate||"-")))]),a("a-descriptions-item",{attrs:{label:"当前学期"}},[t._v(t._s(t.detail.item.term||"-"))]),a("a-descriptions-item",{attrs:{label:"班级状态"}},[t._v(t._s(t.stateLabel(t.detail.item.state)))]),a("a-descriptions-item",{attrs:{label:"排课状态"}},[a("a-tag",{attrs:{color:t.scheduleTagColor(t.detail.item)}},[t._v(t._s(t.scheduleStatusLabel(t.detail.item)))])],1),a("a-descriptions-item",{attrs:{label:"班主任"}},[t._v(t._s(t.detail.item.headTeacherNames||"-"))]),a("a-descriptions-item",{attrs:{label:"主教室"}},[t._v(t._s(t.detail.item.classroom||"-"))]),a("a-descriptions-item",{attrs:{label:"班额/在读"}},[t._v(t._s((t.detail.item.capacityLimit||"-")+" / "+(t.detail.item.currentCount||"-")))]),a("a-descriptions-item",{attrs:{label:"收费"}},[t._v(t._s(t.detail.item.feeStandard||"-")+"（"+t._s(t.detail.item.feeStatus||"未设置")+"）")]),a("a-descriptions-item",{attrs:{label:"标签"}},[t._v(t._s(Array.isArray(t.detail.item.tags)?t.detail.item.tags.join("、"):t.detail.item.tags||"-"))]),a("a-descriptions-item",{attrs:{label:"家长群"}},[t._v(t._s(t.detail.item.parentGroup||"-"))]),a("a-descriptions-item",{attrs:{label:"联系人"}},[t._v(t._s(t.detail.item.contacts||"-"))]),a("a-descriptions-item",{attrs:{label:"备注"}},[t._v(t._s(t.detail.item.note||"-"))])],1)],1),a("a-drawer",{attrs:{visible:t.schedule.visible,title:"班级课表",width:"720"},on:{close:function(s){t.schedule.visible=!1}}},[a("a-descriptions",{staticStyle:{"margin-bottom":"8px"},attrs:{size:"small",column:3}},[a("a-descriptions-item",{attrs:{label:"班级"}},[t._v(t._s(t.schedule.meta.className||"-"))]),a("a-descriptions-item",{attrs:{label:"班级ID"}},[t._v(t._s(t.schedule.meta.classId||"-"))]),a("a-descriptions-item",{attrs:{label:"校区/年级"}},[t._v(t._s((t.schedule.meta.campus||"-")+" / "+(t.schedule.meta.grade||"-")))])],1),a("a-table",{attrs:{"data-source":t.schedule.items,pagination:!1,rowKey:t.rowKeySchedule,columns:[{title:"星期",dataIndex:"day",key:"day"},{title:"时间",dataIndex:"time",key:"time"},{title:"课程",dataIndex:"course",key:"course"},{title:"任课老师",dataIndex:"teacher",key:"teacher"},{title:"教室",dataIndex:"room",key:"room"}]}})],1),a("a-drawer",{attrs:{visible:t.students.visible,title:"班级学生",width:"720"},on:{close:function(s){t.students.visible=!1}}},[a("a-descriptions",{staticStyle:{"margin-bottom":"8px"},attrs:{size:"small",column:2}},[a("a-descriptions-item",{attrs:{label:"班级"}},[t._v(t._s(t.students.meta.className||"-"))]),a("a-descriptions-item",{attrs:{label:"班级ID"}},[t._v(t._s(t.students.meta.classId||"-"))])],1),a("a-table",{attrs:{"data-source":t.students.items,pagination:!1,rowKey:t.rowKeyStudent,columns:[{title:"序号",dataIndex:"no",key:"no"},{title:"姓名",dataIndex:"name",key:"name"},{title:"性别",dataIndex:"gender",key:"gender"},{title:"状态",dataIndex:"status",key:"status"},{title:"入班日期",dataIndex:"joinDate",key:"joinDate"},{title:"联系方式",dataIndex:"contact",key:"contact"}]}})],1),a("a-modal",{attrs:{visible:t.modal.visible,title:t.modalTitle,width:800},on:{ok:t.saveModal,cancel:t.closeModal}},[a("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:16}}},[a("a-form-item",{attrs:{label:"学校/校区"}},[a("a-select",{attrs:{placeholder:"选择学校/校区"},on:{change:t.onModalCampusChange},model:{value:t.modal.form.campusId,callback:function(s){t.$set(t.modal.form,"campusId",s)},expression:"modal.form.campusId"}},t._l(t.campusOptions,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1)],1),a("a-form-item",{attrs:{label:"年级"}},[a("a-select",{attrs:{placeholder:"选择年级"},on:{change:t.onModalGradeChange},model:{value:t.modal.form.gradeId,callback:function(s){t.$set(t.modal.form,"gradeId",s)},expression:"modal.form.gradeId"}},t._l(t.gradeOptions,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1)],1),a("a-form-item",{attrs:{label:"当前学期"}},[a("a-input",{attrs:{placeholder:"如 2024-2025 第一学期"},on:{focus:t.onTermFocus},model:{value:t.modal.form.term,callback:function(s){t.$set(t.modal.form,"term",s)},expression:"modal.form.term"}})],1),a("a-form-item",{attrs:{label:"科目"}},[a("a-select",{attrs:{placeholder:"请选择科目"},model:{value:t.modal.form.subject,callback:function(s){t.$set(t.modal.form,"subject",s)},expression:"modal.form.subject"}},t._l(t.subjectOptions,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name))])}),1)],1),a("a-form-item",{attrs:{label:"名称"}},[a("a-input",{attrs:{placeholder:"请输入班级名称"},on:{focus:t.onNameFocus},model:{value:t.modal.form.name,callback:function(s){t.$set(t.modal.form,"name",s)},expression:"modal.form.name"}})],1),a("a-form-item",{attrs:{label:"授课模式"}},[a("a-select",{attrs:{placeholder:"线上/线下"},model:{value:t.modal.form.mode,callback:function(s){t.$set(t.modal.form,"mode",s)},expression:"modal.form.mode"}},[a("a-select-option",{attrs:{value:"线上"}},[t._v("线上")]),a("a-select-option",{attrs:{value:"线下"}},[t._v("线下")])],1)],1),a("a-form-item",{attrs:{label:"开班日期"}},[a("V2SimpleDate",{attrs:{format:"YYYY-MM-DD"},model:{value:t.modal.form.startDate,callback:function(s){t.$set(t.modal.form,"startDate",s)},expression:"modal.form.startDate"}})],1),a("a-form-item",{attrs:{label:"结课日期"}},[a("V2SimpleDate",{attrs:{format:"YYYY-MM-DD"},model:{value:t.modal.form.endDate,callback:function(s){t.$set(t.modal.form,"endDate",s)},expression:"modal.form.endDate"}})],1),a("a-form-item",{attrs:{label:"班级状态"}},[a("a-select",{attrs:{placeholder:"选择班级状态"},model:{value:t.modal.form.state,callback:function(s){t.$set(t.modal.form,"state",s)},expression:"modal.form.state"}},[a("a-select-option",{attrs:{value:"normal"}},[t._v("正常")]),a("a-select-option",{attrs:{value:"preparing"}},[t._v("筹备中")]),a("a-select-option",{attrs:{value:"paused"}},[t._v("暂停")]),a("a-select-option",{attrs:{value:"finished"}},[t._v("已结课")]),a("a-select-option",{attrs:{value:"dissolved"}},[t._v("已解散")])],1)],1),a("a-form-item",{attrs:{label:"班主任"}},[a("a-select",{attrs:{mode:"multiple","show-search":"",placeholder:"选择班主任"},model:{value:t.modal.form.headTeacherIds,callback:function(s){t.$set(t.modal.form,"headTeacherIds",s)},expression:"modal.form.headTeacherIds"}},t._l(t.staffList,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name||s.title||"#"+s.id))])}),1)],1),a("a-form-item",{attrs:{label:"主教室"}},[a("div",{staticStyle:{display:"flex",gap:"8px"}},[a("a-select",{staticStyle:{flex:"1"},attrs:{"show-search":"","allow-clear":"",filterOption:!0,placeholder:"选择教室"},on:{change:t.onClassroomChange},model:{value:t.modal.form.classroomId,callback:function(s){t.$set(t.modal.form,"classroomId",s)},expression:"modal.form.classroomId"}},t._l(t.classroomOptions,function(s){return a("a-select-option",{key:s.id,attrs:{value:s.id}},[t._v(t._s(s.name)+"（可用座位："+t._s(s.usableSeats)+"）")])}),1),a("a-button",{on:{click:function(s){return t.$router.push("/base/classroom")}}},[t._v("管理教室")])],1)]),a("a-form-item",{attrs:{label:"状态"}},[a("a-select",{model:{value:t.modal.form.status,callback:function(s){t.$set(t.modal.form,"status",s)},expression:"modal.form.status"}},[a("a-select-option",{attrs:{value:"enabled"}},[t._v("启用")]),a("a-select-option",{attrs:{value:"disabled"}},[t._v("禁用")])],1)],1),a("a-form-item",{attrs:{label:"班额限制"}},[a("a-input-number",{staticStyle:{width:"100%"},attrs:{min:1},model:{value:t.modal.form.capacityLimit,callback:function(s){t.$set(t.modal.form,"capacityLimit",s)},expression:"modal.form.capacityLimit"}})],1),a("a-form-item",{attrs:{label:"学费标准"}},[a("a-input",{attrs:{placeholder:"如 5000元/学期 或 200元/课时"},model:{value:t.modal.form.feeStandard,callback:function(s){t.$set(t.modal.form,"feeStandard",s)},expression:"modal.form.feeStandard"}})],1),a("a-form-item",{attrs:{label:"收费状态"}},[a("a-select",{attrs:{placeholder:"选择收费状态"},model:{value:t.modal.form.feeStatus,callback:function(s){t.$set(t.modal.form,"feeStatus",s)},expression:"modal.form.feeStatus"}},[a("a-select-option",{attrs:{value:"统一收费"}},[t._v("已统一收费")]),a("a-select-option",{attrs:{value:"按课时收费"}},[t._v("按课时收费")]),a("a-select-option",{attrs:{value:"未设置"}},[t._v("未设置")])],1)],1),a("a-form-item",{attrs:{label:"班型标签"}},[a("a-select",{staticStyle:{width:"100%"},attrs:{mode:"tags",placeholder:"输入或选择标签"},model:{value:t.modal.form.tags,callback:function(s){t.$set(t.modal.form,"tags",s)},expression:"modal.form.tags"}},[a("a-select-option",{attrs:{value:"实验班"}},[t._v("实验班")]),a("a-select-option",{attrs:{value:"平行班"}},[t._v("平行班")]),a("a-select-option",{attrs:{value:"一对一"}},[t._v("一对一")]),a("a-select-option",{attrs:{value:"小班课"}},[t._v("小班课")])],1)],1),a("a-form-item",{attrs:{label:"备注"}},[a("a-textarea",{attrs:{rows:3,placeholder:"特殊说明"},model:{value:t.modal.form.note,callback:function(s){t.$set(t.modal.form,"note",s)},expression:"modal.form.note"}})],1),a("a-form-item",{attrs:{label:"家长群信息"}},[a("a-input",{attrs:{placeholder:"群号或二维码说明"},model:{value:t.modal.form.parentGroup,callback:function(s){t.$set(t.modal.form,"parentGroup",s)},expression:"modal.form.parentGroup"}})],1),a("a-form-item",{attrs:{label:"联系人信息"}},[a("a-input",{attrs:{placeholder:"如 家委成员姓名/电话"},model:{value:t.modal.form.contacts,callback:function(s){t.$set(t.modal.form,"contacts",s)},expression:"modal.form.contacts"}})],1)],1)],1)],1)},v=[],S=f(b,y,v,!1,null,null,null,null);const w=S.exports;export{w as default};
