import{n as o}from"./index-67337038.js";const i={name:"RefundManage",data(){return{classOptions:[],studentOptions:[],apply:{studentId:null,classId:null,remainingHours:0,unitPrice:0,serviceFee:0,reason:""},list:[],columns:[{title:"学员ID",dataIndex:"studentId",key:"studentId"},{title:"班级ID",dataIndex:"classId",key:"classId"},{title:"金额",key:"amount",scopedSlots:{customRender:"amount"}},{title:"状态",dataIndex:"status",key:"status",scopedSlots:{customRender:"status"}},{title:"退款方式",dataIndex:"refundMethod",key:"refundMethod",scopedSlots:{customRender:"refundMethod"}},{title:"到账时间",dataIndex:"refundAt",key:"refundAt",scopedSlots:{customRender:"refundAt"}},{title:"操作",key:"action",scopedSlots:{customRender:"action"}}],adjust:{visible:!1,id:null,autoAmount:0,finalAmount:0,note:""},exec:{visible:!1,id:null,method:"",txnId:""},approveDlg:{visible:!1,id:null,level:"1",pass:!0,approverId:null},approverConfig:{level1ApproverIds:[],level2ApproverIds:[],financeApproverIds:[]}}},methods:{toFixed(s){const e=Number(s||0);return Number.isFinite(e)?e.toFixed(2):"0.00"},async loadStudentOptions(){try{const e=await(await fetch("/api/student/list")).json(),t=Array.isArray(e.data)?e.data:[];this.studentOptions=t.map(a=>({id:a.id,name:a.name}))}catch{this.studentOptions=[]}},async loadClassOptions(){try{const e=await(await fetch("/api/class/list")).json();this.classOptions=Array.isArray(e.data)?e.data:[]}catch{this.classOptions=[]}},async loadList(){try{const e=await(await fetch("/api/finance/refund/list")).json();let t=Array.isArray(e.data)?e.data:[];const a=this.$route&&this.$route.query?this.$route.query:{},n=a&&a.studentId?Number(a.studentId):null;n&&(t=t.filter(r=>Number(r.studentId)===n)),this.list=t}catch{this.list=[]}},async loadApproverConfig(){try{const e=await(await fetch("/api/finance/refund/approver/config")).json(),t=e&&e.data;this.approverConfig=t||{level1ApproverIds:[],level2ApproverIds:[],financeApproverIds:[]}}catch{this.approverConfig={level1ApproverIds:[],level2ApproverIds:[],financeApproverIds:[]}}},async submitApply(){const s={studentId:Number(this.apply.studentId),classId:Number(this.apply.classId),remainingHours:Number(this.apply.remainingHours||0),unitPrice:Number(this.apply.unitPrice||0),serviceFee:Number(this.apply.serviceFee||0),reason:this.apply.reason||""};try{const t=await(await fetch("/api/finance/refund/apply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(t&&t.code==="ok")this.$message&&this.$message.success("申请已提交"),this.loadList();else throw new Error("失败")}catch{this.$message&&this.$message.error("申请失败")}},openAdjust(s){this.adjust={visible:!0,id:s.id,autoAmount:s.autoAmount,finalAmount:Number(s.finalAmount||0),note:""}},async doAdjust(){try{const e=await(await fetch(`/api/finance/refund/adjust/${this.adjust.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({finalAmount:Number(this.adjust.finalAmount||0),note:this.adjust.note||""})})).json();if(e&&e.code==="ok")this.$message&&this.$message.success("调整已保存"),this.adjust.visible=!1,this.loadList();else throw new Error("失败")}catch{this.$message&&this.$message.error("调整失败")}},openApprove(s,e,t){this.approveDlg={visible:!0,id:s.id,level:e,pass:t,approverId:null};const n={1:this.approverConfig.level1ApproverIds,2:this.approverConfig.level2ApproverIds,finance:this.approverConfig.financeApproverIds}[e]||[];n.length===1&&(this.approveDlg.approverId=n[0])},async doApprove(){if(!this.approveDlg.approverId){this.$message&&this.$message.warning("请选择审批人");return}try{const e=await(await fetch(`/api/finance/refund/approve/${this.approveDlg.id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({level:this.approveDlg.level,pass:this.approveDlg.pass,approverId:this.approveDlg.approverId})})).json();if(e&&e.code==="ok")this.$message&&this.$message.success("已处理审批"),this.approveDlg.visible=!1,this.loadList();else{const t=e&&e.data||"失败";this.$message&&this.$message.error("审批失败："+t)}}catch{this.$message&&this.$message.error("审批失败")}},openExecute(s){this.exec={visible:!0,id:s.id,method:"",txnId:""}},async doExecute(){try{const e=await(await fetch(`/api/finance/refund/execute/${this.exec.id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refundMethod:this.exec.method||"",refundTxnId:this.exec.txnId||""})})).json();if(e&&e.code==="ok")this.$message&&this.$message.success("退款已执行"),this.exec.visible=!1,this.loadList();else throw new Error("失败")}catch{this.$message&&this.$message.error("执行失败")}},formatRefundMethod(s){return s?{cash:"现金",wechat:"微信",alipay:"支付宝",bankcard:"银行卡",bank:"银行转账",banktransfer:"银行转账",银行转账:"银行转账",现金:"现金",微信:"微信",支付宝:"支付宝",银行卡:"银行卡"}[s]||s:"-"},formatTime(s){try{const e=new Date(s);return isNaN(e.getTime())?String(s):e.toLocaleString()}catch{return String(s)}}},created(){this.loadStudentOptions(),this.loadClassOptions();try{const s=this.$route&&this.$route.query?this.$route.query:{};s&&s.studentId&&(this.apply.studentId=Number(s.studentId)||null)}catch{}this.loadList(),this.loadApproverConfig()}};var l=function(){var e=this,t=e._self._c;return t("div",{staticClass:"refund-manage"},[t("a-page-header",{attrs:{title:"退费管理","sub-title":"退费申请、核算、审批与执行"}}),t("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{bordered:"",title:"退费申请"}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[t("a-form-item",{attrs:{label:"学员"}},[t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择学员",allowClear:""},model:{value:e.apply.studentId,callback:function(a){e.$set(e.apply,"studentId",a)},expression:"apply.studentId"}},e._l(e.studentOptions,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.name)+"（ID: "+e._s(a.id)+"）")])}),1)],1),t("a-form-item",{attrs:{label:"班级"}},[t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"选择班级"},model:{value:e.apply.classId,callback:function(a){e.$set(e.apply,"classId",a)},expression:"apply.classId"}},e._l(e.classOptions,function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(e._s(a.name))])}),1)],1),t("a-form-item",{attrs:{label:"剩余课时"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.apply.remainingHours,callback:function(a){e.$set(e.apply,"remainingHours",a)},expression:"apply.remainingHours"}})],1),t("a-form-item",{attrs:{label:"单价"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.apply.unitPrice,callback:function(a){e.$set(e.apply,"unitPrice",a)},expression:"apply.unitPrice"}})],1),t("a-form-item",{attrs:{label:"手续费"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.apply.serviceFee,callback:function(a){e.$set(e.apply,"serviceFee",a)},expression:"apply.serviceFee"}})],1),t("a-form-item",{attrs:{label:"退费原因"}},[t("a-textarea",{attrs:{rows:3,placeholder:"填写退费原因"},model:{value:e.apply.reason,callback:function(a){e.$set(e.apply,"reason",a)},expression:"apply.reason"}})],1),t("a-form-item",{attrs:{"wrapper-col":{span:12,offset:6}}},[t("a-space",[t("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"finance:refund:apply",expression:"'finance:refund:apply'"}],attrs:{type:"primary"},on:{click:e.submitApply}},[e._v("提交申请")])],1)],1)],1)],1),t("a-card",{attrs:{bordered:"",title:"退费记录"}},[t("a-table",{attrs:{"data-source":e.list,columns:e.columns,rowKey:"id",pagination:!1},scopedSlots:e._u([{key:"status",fn:function(a,n){return t("span",{},[a==="PENDING_L1"?t("a-tag",{attrs:{color:"orange"}},[e._v("待一审")]):a==="PENDING_L2"?t("a-tag",{attrs:{color:"gold"}},[e._v("待二审")]):a==="PENDING_FINANCE"?t("a-tag",{attrs:{color:"blue"}},[e._v("待财务")]):a==="APPROVED"?t("a-tag",{attrs:{color:"green"}},[e._v("已审批")]):a==="REFUNDED"?t("a-tag",{attrs:{color:"green"}},[e._v("已退款")]):a==="REJECTED"?t("a-tag",{attrs:{color:"red"}},[e._v("已驳回")]):t("a-tag",[e._v(e._s(a))])],1)}},{key:"amount",fn:function(a,n){return t("span",{},[e._v(" 自动："+e._s(e.toFixed(n.autoAmount))+" / 实际："),t("strong",[e._v(e._s(e.toFixed(n.finalAmount)))])])}},{key:"refundMethod",fn:function(a,n){return t("span",{},[n.status==="REFUNDED"?t("span",[e._v(e._s(e.formatRefundMethod(a)))]):t("span",[e._v("—")])])}},{key:"refundAt",fn:function(a,n){return t("span",{},[n.status==="REFUNDED"&&a?t("span",[e._v(e._s(e.formatTime(a)))]):t("span",[e._v("—")])])}},{key:"action",fn:function(a,n){return t("span",{},[t("a-space",[t("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"finance:refund:adjust",expression:"'finance:refund:adjust'"}],attrs:{size:"small",disabled:n.status==="REFUNDED"},on:{click:function(r){return e.openAdjust(n)}}},[e._v("调整金额")]),t("a-dropdown",{directives:[{name:"perm",rawName:"v-perm",value:"finance:refund:approve",expression:"'finance:refund:approve'"}]},[t("a-button",{attrs:{size:"small",disabled:n.status==="REFUNDED"}},[e._v("审批")]),t("a-menu",{attrs:{slot:"overlay"},slot:"overlay"},[t("a-menu-item",{on:{click:function(r){return e.openApprove(n,"1",!0)}}},[e._v("一审通过")]),t("a-menu-item",{on:{click:function(r){return e.openApprove(n,"2",!0)}}},[e._v("二审通过")]),t("a-menu-item",{on:{click:function(r){return e.openApprove(n,"finance",!0)}}},[e._v("财务通过")]),t("a-menu-divider"),t("a-menu-item",{on:{click:function(r){return e.approve(n,"1",!1)}}},[e._v("一审驳回")])],1)],1),t("a-button",{directives:[{name:"perm",rawName:"v-perm",value:"finance:refund:execute",expression:"'finance:refund:execute'"}],attrs:{size:"small",type:"primary",disabled:n.status!=="APPROVED"},on:{click:function(r){return e.openExecute(n)}}},[e._v("执行退款")])],1)],1)}}])})],1),t("a-modal",{attrs:{title:"调整退款金额","ok-text":"保存","cancel-text":"取消"},on:{ok:e.doAdjust},model:{value:e.adjust.visible,callback:function(a){e.$set(e.adjust,"visible",a)},expression:"adjust.visible"}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[t("a-form-item",{attrs:{label:"自动金额"}},[t("a-input",{attrs:{value:e.toFixed(e.adjust.autoAmount),disabled:""}})],1),t("a-form-item",{attrs:{label:"实际金额"}},[t("a-input-number",{staticStyle:{width:"100%"},attrs:{min:0},model:{value:e.adjust.finalAmount,callback:function(a){e.$set(e.adjust,"finalAmount",a)},expression:"adjust.finalAmount"}})],1),t("a-form-item",{attrs:{label:"调整说明"}},[t("a-textarea",{attrs:{rows:3},model:{value:e.adjust.note,callback:function(a){e.$set(e.adjust,"note",a)},expression:"adjust.note"}})],1)],1)],1),t("a-modal",{attrs:{title:"执行退款","ok-text":"执行","cancel-text":"取消"},on:{ok:e.doExecute},model:{value:e.exec.visible,callback:function(a){e.$set(e.exec,"visible",a)},expression:"exec.visible"}},[t("a-form",{attrs:{"label-col":{span:6},"wrapper-col":{span:12}}},[t("a-form-item",{attrs:{label:"退款方式"}},[t("a-select",{attrs:{placeholder:"选择退款方式"},model:{value:e.exec.method,callback:function(a){e.$set(e.exec,"method",a)},expression:"exec.method"}},[t("a-select-option",{attrs:{value:"cash"}},[e._v("现金")]),t("a-select-option",{attrs:{value:"wechat"}},[e._v("微信")]),t("a-select-option",{attrs:{value:"alipay"}},[e._v("支付宝")]),t("a-select-option",{attrs:{value:"bankcard"}},[e._v("银行卡")]),t("a-select-option",{attrs:{value:"banktransfer"}},[e._v("银行转账")])],1)],1),t("a-form-item",{attrs:{label:"交易/收据号"}},[t("a-input",{attrs:{placeholder:"填写交易或收据编号"},model:{value:e.exec.txnId,callback:function(a){e.$set(e.exec,"txnId",a)},expression:"exec.txnId"}})],1)],1)],1),t("a-modal",{attrs:{title:"选择审批人","ok-text":"提交","cancel-text":"取消"},on:{ok:e.doApprove},model:{value:e.approveDlg.visible,callback:function(a){e.$set(e.approveDlg,"visible",a)},expression:"approveDlg.visible"}},[e.approveDlg.level==="1"?t("div",[t("a-alert",{staticStyle:{"margin-bottom":"8px"},attrs:{type:"info",message:"为一审选择审批人","show-icon":""}}),t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择一审审批人"},model:{value:e.approveDlg.approverId,callback:function(a){e.$set(e.approveDlg,"approverId",a)},expression:"approveDlg.approverId"}},e._l(e.approverConfig.level1ApproverIds,function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v("审批人ID："+e._s(a))])}),1),e.approverConfig.level1ApproverIds.length===0?t("div",{staticStyle:{"margin-top":"8px",color:"#999"}},[e._v("未配置一审审批人，无法通过，请在“审批人配置”页面设置")]):e._e()],1):e.approveDlg.level==="2"?t("div",[t("a-alert",{staticStyle:{"margin-bottom":"8px"},attrs:{type:"info",message:"为二审选择审批人","show-icon":""}}),t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择二审审批人"},model:{value:e.approveDlg.approverId,callback:function(a){e.$set(e.approveDlg,"approverId",a)},expression:"approveDlg.approverId"}},e._l(e.approverConfig.level2ApproverIds,function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v("审批人ID："+e._s(a))])}),1),e.approverConfig.level2ApproverIds.length===0?t("div",{staticStyle:{"margin-top":"8px",color:"#999"}},[e._v("未配置二审审批人，无法通过，请在“审批人配置”页面设置")]):e._e()],1):t("div",[t("a-alert",{staticStyle:{"margin-bottom":"8px"},attrs:{type:"info",message:"为财务终审选择审批人","show-icon":""}}),t("a-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择财务审批人"},model:{value:e.approveDlg.approverId,callback:function(a){e.$set(e.approveDlg,"approverId",a)},expression:"approveDlg.approverId"}},e._l(e.approverConfig.financeApproverIds,function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v("审批人ID："+e._s(a))])}),1),e.approverConfig.financeApproverIds.length===0?t("div",{staticStyle:{"margin-top":"8px",color:"#999"}},[e._v("未配置财务审批人，无法通过，请在“审批人配置”页面设置")]):e._e()],1)])],1)},p=[],c=o(i,l,p,!1,null,"40b0db58",null,null);const u=c.exports;export{u as default};
